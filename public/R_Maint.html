<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชูุฑูุฑ ุงุฌูุงูู ุนุฏุงุฏุงุช ุงูุตูุงูุฉ</title>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="G1_Calib.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
</head>

<body>
    <main class="app">
        <div class="right-side">

            <section class="table-top-section">
                <div class="table-header">
                    <ion-icon name="list-outline"></ion-icon>


                    <div class="modern-dropdown">
                        <button class="dropdown-btn" id="dropdownBtn">
                            โพ ุงุฎุชุฑ ุงูุตูุญุฉ ููุงูุชูุงู
                        </button>

                        <div class="dropdown-menu" id="dropdownMenu">
                            <div class="dropdown-group" data-icon="๐๏ธ">ุงูุตูุงูุฉ</div>
                            <div class="dropdown-item" data-page="Entr_Maint.html">ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Maint.html">ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Edite_Maint.html">ุชุนุฏูู ุจูุงูุงุช ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Print_Out_SMaint.html">ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุตูุงูุฉ ุนุฏุงุฏ
                            </div>
                            <div class="dropdown-item" data-page="Print_Out_TMaint.html">ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน ุตูุงูุฉ ุนุฏุงุฏ
                            </div>
                            <div class="dropdown-item" data-page="Re_Print_Out_SMaint.html">ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต
                                ุตูุงูุฉ
                                ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Re_Print_Out_TMaint.html">ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน
                                ุตูุงูุฉ
                                ุนุฏุงุฏ</div>

                            <div class="dropdown-group" data-icon="๐">ุชูุงุฑูุฑ ุงูุตูุงูุฉ</div>
                            <div class="dropdown-item" data-page="R_Entr_Maint.html">ุชูุฑูุฑ ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="R_Maint.html">ุชูุฑูุฑ ุตูุงูุฉ ุนุฏุงุฏ</div>

                            <div class="dropdown-group" data-icon="๐๏ธ">ุงูุฃุฑุดูู</div>
                            <div class="dropdown-item" data-page="R_Maint_Archive.html">ุฃุฑุดูู ุงูุตูุงูุฉ</div>
                            <div class="dropdown-item" data-page="Main_Dashboard.html" data-icon="๐">ุงูุตูุญุฉ
                                ุงูุฑุฆูุณูุฉ
                            </div>
                        </div>
                    </div>


                    <input type="date" id="current_date" class="calib_date" readonly>

                    <script>
                        // Get today's date in the format YYYY-MM-DD (required for <input type="date">)
                        const today = new Date();
                        const Year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0'); // Add leading zero if month is single digit
                        const day = String(today.getDate()).padStart(2, '0'); // Add leading zero if day is single digit
                        const formattedDate = `${Year}-${month}-${day}`;

                        // Set the value of the input field to today's date
                        document.getElementById('current_date').value = formattedDate;
                    </script>

                    <div class="table-header-controls">
                        <input id="searchInput" placeholder="๐ ุงุจุญุซ ูู ุงููุชุงุฆุฌ...">
                        <button id="exportBtn">
                            <ion-icon name="download-outline"></ion-icon> ุชุตุฏูุฑ Excel
                        </button>
                    </div>
                </div>
            </section>

            <section class="table-wrapper">
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>ู</th>
                                <th>ุฑูู ุงูุนุฏุงุฏ</th>
                                <th>ููุน ุงูุนุฏุงุฏ</th>
                                <th>ููุน ุงูุชูุตูู</th>
                                <th>ุณูุฉ ุงูุตูุน</th>
                                <th>ุงููุฑุงุกุฉ ูุจู ุงููุญุต</th>
                                <th>ุงููุทุงุน</th>
                                <th>ุงูููุฏุณุฉ</th>
                                <th>ุณุจุจ ุงูุฑูุน</th>
                                <th>ุชุงุฑูุฎ ุงูุฑูุน</th>
                                <th>ุชูุฑูุฑ ูุญุต ุงูููุฏุณุฉ</th>
                                <th>ุชุงุฑูุฎ ุฏุฎูู ุงูุตูุงูุฉ</th>
                                <th>ุชูุฑูุฑ ุงูุตูุงูุฉ</th>
                                <th>ุชุงุฑูุฎ ุงูุตูุงูุฉ</th>
                                <th>ููุงุญุธุงุช</th>
                                <th>ุญุงูุฉ ุงูุตูุงูุฉ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </section>

            <div class="row-counter-dashboard">
                <div class="dashboard-card">
                    <h3>ุนุฏุฏ ุงูุณุฌูุงุช</h3>
                    <span id="rowCountValue">0</span>
                </div>
            </div>

            <div class="scroll-buttons">
                <button id="scrollUp" class="scroll-btn" aria-label="ุชูุฑูุฑ ูุฃุนูู" title="ุชูุฑูุฑ ูุฃุนูู">
                    <ion-icon name="chevron-up-outline"></ion-icon>
                </button>
                <button id="scrollDown" class="scroll-btn" aria-label="ุชูุฑูุฑ ูุฃุณูู" title="ุชูุฑูุฑ ูุฃุณูู">
                    <ion-icon name="chevron-down-outline"></ion-icon>
                </button>
            </div>
        </div>

        <!-- ================= LEFT SIDE : FILTERS ================= -->

        <div class="left-side">
            <section class="glass">
                <div class="header-top">
                    <div class="logo">
                        <ion-icon name="construct-outline"></ion-icon>
                    </div>
                    <div>
                        ูุฒุงุฑุฉ ุงูููุฑุจุงุก ูุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ<br>
                        ุงูุดุฑูุฉ ุงููุงุจุถุฉ ูููุฑุจุงุก ูุตุฑ<br>
                        ุดุฑูุฉ ุดูุงู ุงูุฏูุชุง ูุชูุฒูุน ุงูููุฑุจุงุก
                    </div>
                </div>

                <h1 class="title-main">ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ูุฃูุธูุฉ ุงูุนุฏุงุฏุงุช ุงูุญุฏูุซุฉ</h1>

                <h3>ุชูุฑูุฑ ุงุฌูุงูู ุนุฏุงุฏุงุช ุงูุตูุงูุฉ</h3>

                <div class="form-grid">
                    <select id="mtype" title="ููุน ุงูุนุฏุงุฏ">
                        <option value="">โพ ุงุฎุชุฑ ููุน ุงูุนุฏุงุฏ</option>
                        <option>ุฌููุจุงู-ูุณุจู</option>
                        <option>ุณููุฏู-ูุณุจู</option>
                        <option>ุงููุตุฑูุฉ-ูุณุจู</option>
                        <option>ุงุณูุฑุง-ูุณุจู</option>
                        <option>ุฌูุฒุฉ ุจุงูุฑ-ูุณุจู</option>
                        <option>ูููุงูููู</option>
                        <option>ุฑููู</option>
                        <option>ุนุฏุงุฏุงุช-ุฐููุฉ</option>
                        <option>ุฃุฎุฑู</option>
                    </select>

                    <select id="mconn" title="ููุน ุงูุชูุตูู">
                        <option value="">โพููุน ุงูุชูุตูู</option>
                        <option>ุฃุญุงุฏู</option>
                        <option>ุซูุงุซู-ูุจุงุดุฑ</option>
                        <option>ุซูุงุซู-ุบูุฑ ูุจุงุดุฑ</option>
                    </select>

                    <input id="year" placeholder="ุณูุฉ ุงูุตูุน">

                    <select id="keta3" title="ุงููุทุงุน">
                        <option value="">โพ ุงููุทุงุน</option>
                        <option>ุฏููุงุท</option>
                        <option>ุดูุงู-ุงูุฏููููุฉ</option>
                        <option>ุฌููุจ-ุงูุฏููููุฉ</option>
                        <option>ููุฑ ุงูุดูุฎ</option>
                    </select>

                    <select id="handsa" title="ุงูููุฏุณุฉ">
                        <option value="">โพ ุงุฎุชุฑ ุงูููุฏุณุฉ</option>
                        <option>ููุฏุณุฉ ุดูุงู ุฏููุงุท</option>
                        <option>ููุฏุณุฉ ุฌููุจ ุฏููุงุท</option>
                        <option>ููุฏุณุฉ ุนุฒุจุฉ ุงูุจุฑุฌ</option>
                        <option>ููุฏุณุฉ ููุฑ ุณุนุฏ</option>
                        <option>ููุฏุณุฉ ููุฑ ุงูุจุทูุฎ</option>
                        <option>ููุฏุณุฉ ุฑุงุณ ุงูุจุฑ</option>
                        <option>ููุฏุณุฉ ุฏููุงุท ุงูุฌุฏูุฏุฉ</option>
                        <option>ููุฏุณุฉ ุงูุฒุฑูุง</option>
                        <option>ููุฏุณุฉ ูุงุฑุณููุฑ</option>
                        <option>ููุฏุณุฉ ุงูุฑูุถุฉ</option>
                        <option>ููุฏุณุฉ ุงูุดุนุฑุงุก</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ุดุฑุจูู</option>
                        <option>ููุฏุณุฉ ูุฑู ุดุฑุจูู</option>
                        <option>ููุฏุณุฉ ุฏูุฑูุณ</option>
                        <option>ููุฏุณุฉ ุฌูุตุฉ</option>
                        <option>ููุฏุณุฉ ูุฑู ุจููุงุณ</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ุจููุงุณ</option>
                        <option>ููุฏุณุฉ ุงูุณุชุงูููู</option>
                        <option>ููุฏุณุฉ ุจูู ุนุจูุฏ</option>
                        <option>ููุฏุณุฉ ูููุฉ ุงููุตุฑ</option>
                        <option>ููุฏุณุฉ ููุช ุณูุณูู</option>
                        <option>ููุฏุณุฉ ุงูุฌูุงููุฉ</option>
                        <option>ููุฏุณุฉ ูุฑู ุงูููุฒูุฉ</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ุงูููุฒูุฉ</option>
                        <option>ููุฏุณุฉ ุงููุทุฑูุฉ</option>
                        <option>ููุฏุณุฉ ุดุฑู ุงูููุตูุฑุฉ</option>
                        <option>ููุฏุณุฉ ุบุฑุจ ุงูููุตูุฑุฉ</option>
                        <option>ููุฏุณุฉ ุทูุฎุง</option>
                        <option>ููุฏุณุฉ ูุจุฑูู</option>
                        <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 1</option>
                        <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 2</option>
                        <option>ููุฏุณุฉ ุงุฌุง</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ุงูุณูุจูุงููู</option>
                        <option>ููุฏุณุฉ ูุฑู ุงูุณูุจูุงููู</option>
                        <option>ููุฏุณุฉ ุชูู ุงูุงูุฏูุฏ</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ููุช ุบูุฑ</option>
                        <option>ููุฏุณุฉ ูุฑู ููุช ุบูุฑ</option>
                        <option>ููุฏุณุฉ ููู ุงูููุฑ</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ููุฑ ุงูุดูุฎ</option>
                        <option>ููุฏุณุฉ ุบุฑุจ ููุฑ ุงูุดูุฎ</option>
                        <option>ููุฏุณุฉ ุดุฑู ููุฑ ุงูุดูุฎ</option>
                        <option>ููุฏุณุฉ ูููู</option>
                        <option>ููุฏุณุฉ ูุฑู ุณูุฏู ุณุงูู</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ุณูุฏู ุณุงูู</option>
                        <option>ููุฏุณุฉ ุงูุฑูุงุถ</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ุฏุณูู</option>
                        <option>ููุฏุณุฉ ูุฑู ุดูุงู ุฏุณูู</option>
                        <option>ููุฏุณุฉ ูุฑู ุฌููุจ ุฏุณูู</option>
                        <option>ููุฏุณุฉ ููู</option>
                        <option>ููุฏุณุฉ ูุทูุจุณ</option>
                        <option>ููุฏุณุฉ ูุฏููุฉ ุงูุญุงููู</option>
                        <option>ููุฏุณุฉ ูุฑู ุงูุญุงููู</option>
                        <option>ููุฏุณุฉ ุจููุง</option>
                        <option>ููุฏุณุฉ ุจูุทูู</option>
                        <option>ููุฏุณุฉ ุจุฑุฌ ุงูุจุฑูุณ</option>
                    </select>

                    <select id="removingfor" title="ุณุจุจ ุงูุฑูุน">
                        <option value="">โพุณุจุจ ุงูุฑูุน</option>
                        <option>ุงููุญุต</option>
                        <option>ุงูุตูุงูุฉ</option>
                        <option>ุงููุฏู ูุงูุจูุงุก</option>
                        <option>ุชุตููุฉ ูุดุชุฑู</option>
                        <option>ุฒูุงุฏุฉ ูุฏุฑุฉ</option>
                        <option>ุงุญูุงู ุฑุจุงุนู</option>
                        <option>ุชูุงุฒู</option>
                        <option>ุฎุทุฉ ุงุญูุงู</option>
                        <option>ุงุญูุงู ุนุฏู ุณุฏุงุฏ</option>
                    </select>

                    <select id="mremovingfor" title="ุชูุฑูุฑ ุงูููุฏุณุฉ">
                        <option value="">โพุชูุฑูุฑ ุงูููุฏุณุฉ</option>
                        <option>ุนุทู ุจุงูุจุทุงุฑูุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ูุงุฑูุก ุงููุฑูุช ูุง ูุนูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุง ููุจู ุงูุดุญู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุง ูููู ุจุงูุชูุตูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุดุงุดุฉ ุนุงุทูุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุญุชุงุฌ ููุชููุฆุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุชูุฑูุฑ ูุญุต ููุนุฏุงุฏ ูู ูุจู ุงูุดุฑูุฉ ุงูููุฑุฏุฉ</option>
                        <option>ุชูู ุจุฌุณู/ุฑูุฒุชุฉ ุงูุนุฏุงุฏ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุฒูุงุฏุฉ ูุฏุฑุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุจุญุซ ูุฏููููุฉ ุจุงูุนุฏุงุฏ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุญุชุฑู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุง ูุนูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ููุจุฉ ุงูุชูุงุนุจ ุชุนูู ุจุงุณุชูุฑุงุฑ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุนูู ุจุฏูู ุดุญู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุง ูุณุฌู ุงูุงุณุชููุงู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>ุงูุนุฏุงุฏ ูุณุฌู ุงุณุชููุงู ุจุฏูู ุญูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
                        <option>blocking</option>
                    </select>

                    <select id="maintreport" title="ุชูุฑูุฑ ุงูุตูุงูุฉ">
                        <option value="">โพ ุงุฎุชุฑ ุชูุฑูุฑ ุงูุตูุงูุฉ</option>
                        <option>ุชุบููุฑ ุงูุจุทุงุฑูุฉ</option>
                        <option>ุชุบููุฑ ูุงุฑูุก ุงููุฑูุช</option>
                        <option>ุตูุงูุฉ / ุชุบููุฑ ุดุงุดุฉ ุงูุนุฏุงุฏ</option>
                        <option>ุตูุงูุฉ/ ุชุบููุฑ ุงูุฑููุงู</option>
                        <option>ุตูุงูุฉ / ุชุบููุฑ ูุญุฏุฉ ุงูุงุชุตุงู</option>
                        <option>ุตูุงูุฉ / ุชุบููุฑ ุงูุจูุฑุฏุฉ ุงูุฏุงุฎููุฉ ููุนุฏุงุฏ</option>
                        <option>ุชููุฆุฉ ุงูุนุฏุงุฏ</option>
                        <option>ุชุบููุฑ ุฑูุฒุชุฉ ุงูุนุฏุงุฏ</option>
                        <option>ุชุบููุฑ ุฌุณู ุงูุนุฏุงุฏ</option>
                        <option>ุชุบููุฑ ุงูุนุฏุงุฏ ุจุงููุงูู</option>
                    </select>

                    <div class="date-group">
                        <input type="date" id="maint_date" placeholder="ูู ุชุงุฑูุฎ">
                        <input type="date" id="maint_date2" placeholder="ุฅูู ุชุงุฑูุฎ">
                    </div>
                </div>

                <div class="buttons">
                    <button id="clearBtn" class="secondary">
                        <ion-icon name="refresh-outline"></ion-icon> ุชูุฑูุบ
                    </button>
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        // ================= FIREBASE CONFIG =================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
            authDomain: "ndedc-meter-calib.firebaseapp.com",
            databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com",
            projectId: "ndedc-meter-calib",
            storageBucket: "ndedc-meter-calib.appspot.com",
            messagingSenderId: "185425429190",
            appId: "1:185425429190:web:dce85f29eea55ad9f54dc7",
            measurementId: "G-C6QEKW26MW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ================= ELEMENTS =================
        const el = id => document.getElementById(id);

        const tableBody = el('tableBody');
        const rowCount = el('rowCountValue') || el('rowCount'); // ุฏุนู ููุงุณููู ุงููุญุชูููู
        const searchInput = el('searchInput');
        const exportBtn = el('exportBtn');
        const clearBtn = el('clearBtn');

        // Filters
        const mtype = el('mtype');
        const mconn = el('mconn');
        const keta3 = el('keta3');
        const handsa = el('handsa');
        const removingfor = el('removingfor');
        const maintreport = el('maintreport');
        const mremovingfor = el('mremovingfor');
        const startDate = el('maint_date');
        const endDate = el('maint_date2');
        const yearInput = el('year');

        // ================= DATA STATE =================
        let allData = [];
        let filteredData = [];

        // ================= HELPERS =================
        const formatDate = d => d ? new Date(d).toLocaleDateString("ar-EG") : "---";

        const showToast = (title, icon = 'success') => {
            if (window.Swal) {
                Swal.fire({
                    icon: icon, title: title, toast: true, position: 'top-end',
                    showConfirmButton: false, timer: 1500, timerProgressBar: true
                });
            }
        };

        // ================= CORE FUNCTIONS =================

        // ุฌูุจ ุงูุจูุงูุงุช ูุน ูุงุฌูุฉ ุชุญููู (Loading)
        async function fetchAllData() {
            if (!tableBody) return;
            tableBody.innerHTML = `<tr><td colspan="16" style="text-align:center">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>`;

            if (window.Swal) {
                Swal.fire({
                    title: 'ุฌุงุฑู ุชุญุฏูุซ ุงูุชูุงุฑูุฑ...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
            }

            try {
                const snapshot = await get(ref(db, "Maint"));
                if (!snapshot.exists()) {
                    tableBody.innerHTML = `<tr><td colspan="16" style="text-align:center">ูุง ุชูุฌุฏ ุจูุงูุงุช ุญุงููุงู</td></tr>`;
                    if (rowCount) rowCount.textContent = "0";
                    Swal.close();
                    return;
                }

                allData = [];
                snapshot.forEach(child => {
                    // ุฏุนู ุงููููููู: direct data ุฃู inside otherdata
                    const record = child.val().otherdata || child.val();
                    allData.push(record);
                });

                filteredData = [...allData];
                renderTable();
                if (window.Swal) Swal.close();

            } catch (error) {
                console.error("Firebase Error:", error);
                if (window.Swal) Swal.fire({ icon: 'error', title: 'ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช', text: error.message });
            }
        }

        // ุจูุงุก ุงูุฌุฏูู ุจูุงุกู ุนูู ุงููุตูููุฉ ุงููููุชุฑุฉ
        function renderTable() {
            if (!tableBody) return;
            tableBody.innerHTML = "";

            if (filteredData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="16" style="text-align:center;padding:30px;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุชุทุงุจู ูุนุงููุฑ ุงูุจุญุซ</td></tr>`;
                if (rowCount) rowCount.textContent = "0";
                return;
            }

            let rows = "";
            filteredData.forEach((d, i) => {
                // ููุทู ุงูุญุงูุฉ: ุฅุฐุง ูุงู ููุงู ุณุจุจ ุฅุนุงุฏุฉ ุชุฑููุจ (MRemovingfor) ูุนุชุจุฑูุง ุชูุช ุงูุตูุงูุฉ
                const isDone = d.MRemovingfor && d.MRemovingfor.trim() !== "";
                const statusText = isDone ? "ุชูุช ุงูุตูุงูุฉ" : "ููุฏ ุงูุงูุชุธุงุฑ";
                const statusColor = isDone ? "#27ae60" : "#f39c12";

                rows += `
            <tr>
                <td>${i + 1}</td>
                <td style="font-weight:bold">${d.MNO || ''}</td>
                <td>${d.Mtype || ''}</td>
                <td>${d.Connection || ''}</td>
                <td>${d.YEAR || ''}</td>
                <td>${d.MREADING || ''}</td>
                <td>${d.Keta3 || ''}</td>
                <td>${d.Handsa || ''}</td>
                <td>${d.Removingfor || ''}</td>
                <td>${formatDate(d.Uploaddate)}</td>
                <td>${d.MRemovingfor || ''}</td>
                <td>${formatDate(d.Enter_Maint_Date)}</td>
                <td>${d.Maintreport || ''}</td>
                <td>${formatDate(d.Maint_Date)}</td>
                <td>${d.Notes || ''}</td>
                <td><span class="status">ุชู ุงูุตูุงูุฉ</span></td>
            </tr>`;
            });

            tableBody.innerHTML = rows;
            if (rowCount) rowCount.textContent = filteredData.length;
        }

        // ููุทู ุงูููุชุฑุฉ ุงููุชูุฏูุฉ
        function applyFilters() {
            const q = searchInput.value.toLowerCase().trim();
            const startV = startDate ? startDate.value : "";
            const endV = endDate ? endDate.value : "";
            const yearV = yearInput ? yearInput.value.trim() : "";

            filteredData = allData.filter(o => {
                // 1. ุจุญุซ ุจุฑูู ุงูุนุฏุงุฏ
                const matchesSearch = !q || (o.MNO && o.MNO.toString().toLowerCase().includes(q));

                // 2. ููุงุชุฑ ุงูููุงุฆู ุงูููุณุฏูุฉ (ุชุฌุงูู ุงูููุชุฑ ุฅุฐุง ูู ูุชู ุงุฎุชูุงุฑ ูููุฉ)
                const matchesMtype = !mtype.value || o.Mtype === mtype.value;
                const matchesConn = !mconn.value || o.Connection === mconn.value;
                const matchesKeta3 = !keta3.value || o.Keta3 === keta3.value;
                const matchesHandsa = !handsa.value || o.Handsa === handsa.value;
                const matchesRem = !removingfor.value || o.Removingfor === removingfor.value;

                // 3. ููุงุชุฑ ุชูุฑูุฑ ุงูุตูุงูุฉ ูุณุจุจ ุงูุฅุนุงุฏุฉ (ุจุญุซ ุฏููู)
                const matchesMRem = !mremovingfor.value ||
                    (o.MRemovingfor && o.MRemovingfor.trim() === mremovingfor.value.trim());

                const matchesMaintRem = !maintreport.value ||
                    (o.Maintreport && o.Maintreport.trim() === maintreport.value.trim());

                // 4. ููุชุฑ ุณูุฉ ุงูุตูุน
                const matchesYear = !yearV || (o.YEAR && o.YEAR.toString().includes(yearV));

                // 5. ููุงุชุฑ ุชุงุฑูุฎ ุงูุตูุงูุฉ (ุงููุทุงู ุงูุฒููู)
                const itemDate = o.Maint_Date || "";
                const matchesStart = !startV || itemDate >= startV;
                const matchesEnd = !endV || itemDate <= endV;

                return matchesSearch && matchesMtype && matchesConn &&
                    matchesKeta3 && matchesHandsa && matchesRem &&
                    matchesMRem && matchesMaintRem && matchesYear &&
                    matchesStart && matchesEnd;
            });

            renderTable();
        }

        // ูุณุญ ุงูููุงุชุฑ ูุฅุนุงุฏุฉ ุนุฑุถ ุงููู
        function clearFilters() {
            document.querySelectorAll("select, .left-side input, .search-box input").forEach(input => {
                if (input.tagName === "SELECT") input.selectedIndex = 0;
                else input.value = "";
            });

            filteredData = [...allData];
            renderTable();
            showToast("ุชู ูุณุญ ุฌููุน ุงูููุงุชุฑ", "info");
        }

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', () => {
            fetchAllData();

            // ุฑุจุท ุฃุญุฏุงุซ ุงูุฅุฏุฎุงู (Input)
            [searchInput, yearInput].forEach(inp => {
                if (inp) inp.addEventListener('input', applyFilters);
            });

            // ุฑุจุท ุฃุญุฏุงุซ ุงูููุงุฆู ูุงูุชุงุฑูุฎ (Change)
            const filterElements = [
                mtype, mconn, keta3, handsa, removingfor,
                mremovingfor, maintreport, startDate, endDate
            ];

            filterElements.forEach(el => {
                if (el) el.addEventListener('change', applyFilters);
            });

            if (clearBtn) clearBtn.onclick = clearFilters;

            if (exportBtn) {
                exportBtn.onclick = () => {
                    if (typeof exportToExcel === 'function') exportToExcel();
                    else showToast("ูุธููุฉ ุงูุชุตุฏูุฑ ุบูุฑ ูุนุฑูุฉ", "error");
                };
            }
        });

        /* ================= EXPORT ================= */
        function exportToExcel() {
            if (!filteredData.length) {
                return Swal.fire({
                    icon: 'warning',
                    title: 'ูุง ุชูุฌุฏ ุจูุงูุงุช',
                    text: 'ูุง ูููู ุชุตุฏูุฑ ุฌุฏูู ูุงุฑุบุ ูุฑุฌู ุงูุชุฃูุฏ ูู ูุฌูุฏ ุจูุงูุงุช ุฃููุงู',
                    confirmButtonColor: '#f39c12'
                });
            }

            Swal.fire({
                title: 'ุชุตุฏูุฑ ุงูุจูุงูุงุช',
                text: "ูู ุชุฑูุฏ ุชุตุฏูุฑ ุงูุฌุฏูู ุงูุญุงูู ุฅูู ููู Excelุ",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#27ae60',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ูุนู',
                cancelButtonText: 'ุฅูุบุงุก'
            }).then((result) => {
                if (result.isConfirmed) {
                    const dataToExport = filteredData.map((o, i) => ({
                        "ู": i + 1,
                        "ุฑูู ุงูุนุฏุงุฏ": o.MNO || "",
                        "ููุน ุงูุนุฏุงุฏ": o.Mtype || "",
                        "ููุน ุงูุชูุตูู": o.Connection || "",
                        "ุณูุฉ ุงูุตูุน": o.YEAR || "",
                        "ุงููุทุงุน": o.Keta3 || "",
                        "ุงูููุฏุณุฉ": o.Handsa || "",
                        "ุณุจุจ ุงูุฑูุน": o.Removingfor || "",
                        "ุชุงุฑูุฎ ุงูุฑูุน": formatDate(o.Uploaddate),
                        "ุชูุฑูุฑ ูุญุต ุงูููุฏุณุฉ": o.MRemovingfor || "",
                        "ุชุงุฑูุฎ ุฏุฎูู ุงูุตูุงูุฉ": formatDate(o.Enter_Maint_Date),
                        "ุชูุฑูุฑ ุงูุตูุงูุฉ": o.Maintreport || "",
                        "ุชุงุฑูุฎ ุงูุตูุงูุฉ": formatDate(o.Maint_Date),
                        "ููุงุญุธุงุช": o.Notes || "",
                        "ุญุงูุฉ ุงูุตูุงูุฉ": o.Maintreport ? "ุชู ุงูุตูุงูุฉ" : "ููุฏ ุงูุงูุชุธุงุฑ"

                    }));

                    const ws = XLSX.utils.json_to_sheet(dataToExport);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "ุงูุชูุงุฑูุฑ");
                    XLSX.writeFile(wb, `ุชูุฑูุฑ_ุงูุตูุงูุฉ${new Date().toISOString().slice(0, 10)}.xlsx`);

                    Swal.fire({
                        icon: 'success',
                        title: 'ุชู ุงูุชุตุฏูุฑ!',
                        text: 'ุชู ุชุญููู ููู Excel ุจูุฌุงุญ',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        /* ================= SCROLL FUNCTIONS ================= */
        function scrollUp() {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }

        function scrollDown() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: "smooth"
            });
        }

        // ุฑุจุท ุงูุฃุฒุฑุงุฑ ุจุงูุฏูุงู
        document.querySelectorAll("#scrollUp").forEach(btn => {
            btn.addEventListener("click", scrollUp);
        });

        document.querySelectorAll("#scrollDown").forEach(btn => {
            btn.addEventListener("click", scrollDown);
        });


        // Dropdown Menu Functionality
        const btn = document.getElementById("dropdownBtn");
        const menu = document.getElementById("dropdownMenu");

        btn.addEventListener("click", () => {
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        });

        document.querySelectorAll('.dropdown-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                window.open(page, '_blank'); // ูุชุญ ูู ุชุจููุจ ุฌุฏูุฏ
            });
        });

        // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงููุงุฆูุฉ
        document.addEventListener("click", e => {
            if (!e.target.closest(".modern-dropdown")) {
                menu.style.display = "none";
            }
        });



    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <script src="gatekeeper.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ููุญุฉ ุงูุชุญูู - ูุธุงู ุงููุญุต ูุงูุตูุงูุฉ</title>

  <link rel="stylesheet" type="text/css" href="Main_Dashboard.css">

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="content-area">
  <div id="pageOverlay">
    <div id="loadingSpinner" class="spinner"></div>
  </div>

  <nav class="main-nav">
    <div class="nav-brand">
      <div class="logo">
        <ion-icon name="speedometer-outline"></ion-icon>
      </div>

      <div class="brand-text">
        <h2 class="top-right-text">
          ูุฒุงุฑุฉ ุงูููุฑุจุงุก ูุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ<br>
          ุงูุดุฑูุฉ ุงููุงุจุถุฉ ูููุฑุจุงุก ูุตุฑ<br>
          ุดุฑูุฉ ุดูุงู ุงูุฏูุชุง ูุชูุฒูุน ุงูููุฑุจุงุก
        </h2>
      </div>

      <div class="dashboard-title">
        <h1>ููุญุฉ ุชุญูู ูุธุงู ุงููุญุต ูุงูุตูุงูุฉ</h1>
      </div>
    </div>

    <button id="showDailyStatsBtn" class="show-stats-btn">ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุญุต ุงูููููุฉ</button>
    <label class="dark-toggle">
      <input type="checkbox" onclick="document.body.classList.toggle('dark-mode')">
      ๐
    </label>

    <div class="system-type-selector">
      <div class="time-box">
        <ion-icon name="time-outline"></ion-icon>
        <span id="currentTime" class="current-time"></span>
      </div>
    </div>
  </nav>

  <main class="main-container">
    <div class="top-overview-grid">
      <section class="stats-section">
        <div class="section-header">
          <h3><ion-icon name="stats-chart-outline"></ion-icon> ุงูุฅุญุตุงุฆูุงุช ุงูุฑุฆูุณูุฉ</h3>
        </div>


        <div class="stats-grid">
          <div class="stat-card calibration">
            <div class="stat-icon"><ion-icon name="search-outline"></ion-icon></div>
            <div class="stat-content">
              <h4>ุงููุญุต ูุงููุนุงูุฑุฉ</h4>
              <div class="stat-numbers">
                <div class="stat-item"><span class="stat-label">ุงููุณุชููุฉ</span><span class="stat-value"
                    id="receivedMeters">0</span></div>
                <div class="stat-item"><span class="stat-label">ุงูููุชููุฉ</span><span class="stat-value"
                    id="calibratedMeters">0</span></div>
                <div class="stat-item"><span class="stat-label">ุงููุชุจููุฉ</span><span class="stat-value"
                    id="remainingMeters">0</span></div>
              </div>
            </div>
          </div>

          <div class="stat-card maintenance">
            <div class="stat-icon"><ion-icon name="construct-outline"></ion-icon></div>
            <div class="stat-content">
              <h4>ุงูุตูุงูุฉ</h4>
              <div class="stat-numbers">
                <div class="stat-item"><span class="stat-label">ุงููุณุชููุฉ</span><span class="stat-value"
                    id="receivedMaintMeters">0</span></div>
                <div class="stat-item"><span class="stat-label">ุงูููุชููุฉ</span><span class="stat-value"
                    id="calibratedMaintMeters">0</span></div>
                <div class="stat-item"><span class="stat-label">ุงููุชุจููุฉ</span><span class="stat-value"
                    id="remainingMaintMeters">0</span></div>
              </div>
            </div>
          </div>

          <div class="stat-card scrap">
            <div class="stat-icon"><ion-icon name="trash-outline"></ion-icon></div>
            <div class="stat-content">
              <h4>ูุธุงู ุงูุชูููู</h4>
              <div class="stat-numbers">
                <div class="stat-item"><span class="stat-label">ุฅุฌูุงูู ุงูุชูููู</span><span class="stat-value"
                    id="totalTakheen">0</span></div>
              </div>
            </div>
          </div>

          <div class="stat-card delivery">
            <div class="stat-icon"><ion-icon name="checkmark-done-circle-outline"></ion-icon></div>
            <div class="stat-content">
              <h4>ุชุณููู ุงูููุฏุณุงุช[ ูุญุต-ุตูุงูุฉ]</h4>
              <div class="stat-numbers">
                <div class="stat-item"><span class="stat-label">ุชุณููู ูุญุต</span><span class="stat-value"
                    id="recCalibValue">0</span></div>
                <div class="stat-item"><span class="stat-label">ุชุณููู ุตูุงูุฉ</span><span class="stat-value"
                    id="recMaintValue">0</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="chart-section-container">
        <div class="chart-grid-layout">
          <div class="chart-card">
            <div class="chart-header">
              <h4><ion-icon name="pie-chart-outline"></ion-icon> ุชูุฒูุน ุงูุญุงูุงุช ุงูุญุงููุฉ</h4>
            </div>
            <div class="chart-wrapper"><canvas id="statusChart"></canvas></div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h4><ion-icon name="bar-chart-outline"></ion-icon> ููุงุฑูุฉ ุงูุงุณุชูุงู ูุงูููุฌุฒ</h4>
            </div>
            <div class="chart-wrapper"><canvas id="performanceChart"></canvas></div>
          </div>
        </div>
      </section>

      <section class="modern-dropdown-section">
        <div class="section-header">
          <h3><ion-icon name="grid-outline"></ion-icon> ููุญุฉ ุงูุชุญูู ูุงูุฃูุธูุฉ</h3>
          <button class="show-stats-btn" onclick="window.location.href='Index.html'">
            ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
          </button>
        </div>


        <div class="dropdown-container">

          <div class="dropdown-item admin-only">
            <button class="dropdown-btn smart">
              <span><ion-icon name="speedometer-outline"></ion-icon> ูุธุงู ุงูุนุฏุงุฏุงุช ุงูุฐููุฉ</span>
              <ion-icon name="chevron-down-outline" class="arrow"></ion-icon>
            </button>
            <div class="dropdown-content">
              <a href="Dashboard_Smart.html"><ion-icon name="analytics-outline"></ion-icon> ููุญุฉ ุงูุชุญูู</a>
              <a href="SMART_Added_Mod.html"><ion-icon name="add-circle-outline"></ion-icon> ุงุถุงูุฉ ุนุฏุงุฏุงุช</a>
              <a href="SMART_Map.html"><ion-icon name="map-outline"></ion-icon> ุจุญุซ ุจุงูุฃุญุฏุงุซูุงุช</a>
              <a href="SMART_Conv_Cord.html"><ion-icon name="locate-outline"></ion-icon> ุชุญููู ุงูุฃุญุฏุงุซูุงุช</a>
              <a href="SMART_R.html"><ion-icon name="document-outline"></ion-icon> ุงูุชูุงุฑูุฑ</a>
              <a href="SMART_Excel.html"><ion-icon name="cloud-download-outline"></ion-icon> ุชูุฒูู ุงูุจูุงูุงุช</a>
              <a href="SMART_Admin.html"><ion-icon name="shield-checkmark-outline"></ion-icon> ุฑูุน ุงูุจูุงูุงุช</a>
            </div>
          </div>

          <div class="dropdown-item admin-only">
            <button class="dropdown-btn calibration">
              <span><ion-icon name="search-outline"></ion-icon> ูุธุงู ุงููุญุต ูุงููุนุงูุฑุฉ</span>
              <ion-icon name="chevron-down-outline" class="arrow"></ion-icon>
            </button>
            <div class="dropdown-content">
              <a href="Entr_Calib.html">ุฏุฎูู ูุญุต</a>
              <a href="Calib.html">ูุญุต ุนุฏุงุฏ</a>
              <a href="Edite_Calib.html">ุชุนุฏูู ุจูุงูุงุช</a>
              <a href="Print_Out_Calib.html">ุทุจุงุนุฉ ุชูุฑูุฑ</a>
              <a href="Recived_Calib.html">ุชุณููู ุนุฏุงุฏ</a>
            </div>
          </div>

          <div class="dropdown-item">
            <button class="dropdown-btn maintenance">
              <span><ion-icon name="construct-outline"></ion-icon> ูุธุงู ุงูุตูุงูุฉ</span>
              <ion-icon name="chevron-down-outline" class="arrow"></ion-icon>
            </button>
            <div class="dropdown-content">
              <a href="Entr_Maint.html">ุฏุฎูู ุตูุงูุฉ</a>
              <a href="Maint.html">ุตูุงูุฉ ุนุฏุงุฏ</a>
              <a href="R_Maint.html">ุชูุฑูุฑ ุตูุงูุฉ</a>
              <a href="R_Maint_Archive.html">ุฃุฑุดูู ุงูุตูุงูุฉ</a>
            </div>
          </div>

          <div class="dropdown-item admin-only">
            <button class="dropdown-btn math">
              <span><ion-icon name="flash-outline"></ion-icon> ุงูุญุณุงุจุงุช ุงูููุฑุจูุฉ</span>
              <ion-icon name="chevron-down-outline" class="arrow"></ion-icon>
            </button>
            <div class="dropdown-content">
              <a href="Angles.html">ุชุญููู ุงูุฒูุงูุง</a>
              <a href="Munipilation_Report.html">ุงูุถุจุทูุฉ</a>
              <a href="Add_Loads.html">ุงุถุงูุฉ ุงุญูุงู</a>
              <a href="PF.html">ุญุณุงุจุงุช ูุนุงูู ุงููุฏุฑุฉ</a>
              <a href="Calibrations.html">ุญุณุงุจุงุช ุงููุนุงูุฑุฉ</a>
              <a href="M_T_Calculations.html">ุญุณุงุจุงุช ููุงููุฏ ุงููุญููุงุช - ุงูููุชูุฑ</a>
              <a href="Research.html">ุงููุงุฏุฉ ุงูุนูููุฉ ูููุธููุฉ ุงูุนุฏุงุฏุงุช ุงูุฐููุฉ</a>
              <a href="Spex.html">ุงูููุงุตูุงุช</a>
              <a href="Tarrifs.html">ุงูุชุดุฑูุญ</a>
              <a href="Cables_V.D_Calculator.html">ุงููุงุจูุงุช-ุงูููุฏ ูู ุงูุฌูุฏ</a>
              <a href="TVJ.html">TVJ</a>

            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
      authDomain: "ndedc-meter-calib.firebaseapp.com",
      databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com",
      projectId: "ndedc-meter-calib",
      storageBucket: "ndedc-meter-calib.appspot.com",
      messagingSenderId: "185425429190",
      appId: "1:185425429190:web:dce85f29eea55ad9f54dc7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const overlay = document.getElementById("pageOverlay");
    let statusChart = null;
    let performanceChart = null;

    function updateTime() {
      const now = new Date();
      document.getElementById("currentTime").textContent =
        now.toLocaleDateString("ar-EG") + " - " + now.toLocaleTimeString("ar-EG");
    }

    const valCount = snap => (snap && snap.exists()) ? Object.keys(snap.val()).length : 0;

    function processUserStats(calibSnap) {
      if (!calibSnap || !calibSnap.exists()) return [];
      const calibRecords = Object.values(calibSnap.val());
      const usersKeys = ["User_1", "User_2"];
      const statsMap = {};

      calibRecords.forEach(record => {
        const userData = record.calibdata || {};
        const date = userData.CalibDate || "ุบูุฑ ูุญุฏุฏ";
        usersKeys.forEach(key => {
          const name = userData[key];
          if (name) {
            const groupKey = `${name}|${date}`;
            statsMap[groupKey] = (statsMap[groupKey] || 0) + 1;
          }
        });
      });

      return Object.keys(statsMap).map(key => {
        const [name, date] = key.split("|");
        return { name, date, count: statsMap[key] };
      });
    }

    function updateCharts(ec, c, em, m) {
      const countC = valCount(c);
      const countM = valCount(m);

      const ctx1 = document.getElementById("statusChart");
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(ctx1, {
        type: "doughnut",
        data: {
          labels: ["ูุญุต ููุชูู", "ูุญุต ูุชุจูู", "ุตูุงูุฉ ููุชูู", "ุตูุงูุฉ ูุชุจููุฉ"],
          datasets: [{
            data: [countC, valCount(ec) - countC, countM, valCount(em) - countM],
            backgroundColor: ["#2ecc71", "#f1c40f", "#3498db", "#e74c3c"]
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#333', font: { family: 'Cairo' } }
            }
          }
        }
      });

      const ctx2 = document.getElementById("performanceChart");
      if (performanceChart) performanceChart.destroy();
      performanceChart = new Chart(ctx2, {
        type: "bar",
        data: {
          labels: ["ููุธููุฉ ุงููุญุต", "ููุธููุฉ ุงูุตูุงูุฉ"],
          datasets: [
            { label: 'ุงููุณุชูู', data: [valCount(ec), valCount(em)], backgroundColor: '#9b59b6' },
            { label: 'ุงูููุฌุฒ', data: [countC, countM], backgroundColor: '#2ecc71' }
          ]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            y: { ticks: { color: '#333' }, grid: { color: '#eee' } },
            x: { ticks: { color: '#333' } }
          },
          plugins: {
            legend: {
              labels: { color: '#333', font: { family: 'Cairo' } }
            }
          }
        }
      });
    }

    async function fetchData() {
      try {
        const paths = ["Enter_Calib", "Calib", "Enter_Maint", "Maint", "Takheen", "Reciever_Calib", "Reciever_Maint"];
        const snapshots = await Promise.all(paths.map(path => get(ref(db, path))));
        const [ec, c, em, m, t, rc, rm] = snapshots;

        document.getElementById("receivedMeters").textContent = valCount(ec);
        document.getElementById("calibratedMeters").textContent = valCount(c);
        document.getElementById("remainingMeters").textContent = valCount(ec) - valCount(c);
        document.getElementById("receivedMaintMeters").textContent = valCount(em);
        document.getElementById("calibratedMaintMeters").textContent = valCount(m);
        document.getElementById("remainingMaintMeters").textContent = valCount(em) - valCount(m);
        document.getElementById("totalTakheen").textContent = valCount(t);
        document.getElementById("recCalibValue").textContent = valCount(rc);
        document.getElementById("recMaintValue").textContent = valCount(rm);

        updateCharts(ec, c, em, m);
        overlay.style.display = "none";
      } catch (e) {
        console.error(e);
        overlay.style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateTime();
      setInterval(updateTime, 1000);
      fetchData();
      setInterval(fetchData, 60000);

      document.getElementById("showDailyStatsBtn").addEventListener("click", async () => {
        const calibSnap = await get(ref(db, "Calib"));
        const stats = processUserStats(calibSnap);
        const rows = stats.map(u => `
          <tr class="swal-row">
            <td>${u.name}</td>
            <td>${u.count}</td>
            <td>${u.date}</td>
          </tr>`).join("");

        Swal.fire({
          title: "ุฅุญุตุงุฆูุงุช ุงููุญุต",
          html: `
            <div dir="rtl">
              <table class="swal-table">
                <thead>
                  <tr>
                    <th>ุงููุณุชุฎุฏู</th>
                    <th>ุงููููุฉ</th>
                    <th>ุงูุชุงุฑูุฎ</th>
                  </tr>
                </thead>
                <tbody>${rows || "<tr><td colspan='3'>ูุง ุชูุฌุฏ ุจูุงูุงุช</td></tr>"}</tbody>
              </table>
            </div>`,
          background: "#fff",
          confirmButtonColor: "#3498db",
          confirmButtonText: "ุฅุบูุงู",
          customClass: {
            title: 'swal-title-custom'
          }
        });
      });
    });


    document.addEventListener("DOMContentLoaded", () => {
      // --- ACCESS CONTROL HIDING LOGIC ---
      const role = localStorage.getItem("userRole");

      // If the role is 'user', hide all elements marked 'admin-only'
      if (role === "user") {
        const adminSections = document.querySelectorAll(".admin-only");
        adminSections.forEach(section => {
          section.style.display = "none";
        });

        // Optional: Hide the "Show Daily Stats" button for users too
        const statsBtn = document.getElementById("showDailyStatsBtn");
        if (statsBtn) statsBtn.style.display = "none";
      }
      // -----------------------------------

      updateTime();
      setInterval(updateTime, 1000);
      fetchData();
      // ... rest of your existing code
    });


    document.querySelectorAll('.dropdown-btn').forEach(button => {
      button.addEventListener('click', () => {
        const parent = button.parentElement;

        // ุฅุบูุงู ุงูููุงุฆู ุงูุฃุฎุฑู ุฅุฐุง ุฃุฑุฏุช (ุงุฎุชูุงุฑู)
        document.querySelectorAll('.dropdown-item').forEach(item => {
          if (item !== parent) item.classList.remove('active');
        });

        // ูุชุญ ุฃู ุฅุบูุงู ุงููุงุฆูุฉ ุงูุญุงููุฉ
        parent.classList.toggle('active');
      });
    });


  </script>
</body>

</html>
<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Smart Meters</title>
    <link rel="stylesheet" type="text/css" href="Dashboard_Smart.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

</head>

<body>


    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Alert Banner for Delayed Handsa -->
        <div class="alert-banner" id="alertBanner">
            <div class="alert-content">
                <h4><i class="fas fa-exclamation-triangle"></i> ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ù†Ø§Ùƒ Ù‡Ù†Ø¯Ø³Ø§Øª Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù† Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h4>
                <p id="alertMessage"></p>
            </div>
            <button class="alert-close" id="closeAlertBtn" type="button" aria-label="Close alert">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Header -->
        <div class="header">

            <div class="header-title">
                <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Smart Meters</h1>
                <p id="currentDate">--/--/----</p>
            </div>

            <div class="header-actions">

                <button class="btn btn-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                    ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <label class="dark-toggle" title="Toggle dark mode">
                    <input id="darkToggle" class="dark-toggle__input" type="checkbox" aria-label="Dark mode toggle"
                        role="switch" aria-checked="false" />
                    <span class="switch"></span>
                    <span class="icon">ğŸŒ™</span>
                </label>
                <button class="btn btn-secondary" id="exportBtn">
                    <i class="fas fa-file-export"></i>
                    ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±
                </button>
            </div>
        </div>

        <!-- Filter Summary -->
        <div class="filter-summary" id="filterSummary">
            <div>
                <h4>ÙÙ„ØªØ± Ù…ÙØ¹Ù„</h4>
                <p id="filterInfo"></p>
            </div>
            <button class="clear-filters" id="clearFiltersBtn">
                <i class="fas fa-times"></i> Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon stat-icon-primary">
                    <i class="fas fa-microchip"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalMeters">0</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
                </div>
            </div>

            <!-- ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ -->
            <div class="stat-card stat-card-wide">
                <div class="stat-content">
                    <div class="ranking-header">
                        <h3>ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª</h3>
                        <span class="ranking-subtitle">(Ø§Ù„Ø£Ù‚Ù„ ØªØ±ÙƒÙŠØ¨Ù‹Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)</span>
                    </div>
                    <div class="ranking-list" id="rankingList">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-content">
                    <h3 id="totalWeekMeters">0</h3>
                    <p>Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</p>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Ø§Ù„ØªÙ‚Ø¯Ù…</span>
                            <span id="weekProgressPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="weekProgressFill"></div>
                        </div>
                    </div>
                    <div class="target-info">
                        <span>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: 25 Ø¹Ø¯Ø§Ø¯/Ù‡Ù†Ø¯Ø³Ø©</span>
                    </div>
                </div>
            </div>

            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù‚Ø·Ø§Ø¹ -->
            <div class="stat-card">
                <div class="stat-icon stat-icon-purple">
                    <i class="fas fa-sitemap"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalDisco">0</h3>
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</p>
                </div>
            </div>

            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© -->
            <div class="stat-card">
                <div class="stat-icon stat-icon-teal">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalHandsa">0</h3>
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª</p>
                </div>
            </div>

            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ¹ -->
            <div class="stat-card">
                <div class="stat-icon stat-icon-orange">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="stat-content">
                    <h3 id="typeDistribution">-</h3>
                    <p>Ø£ÙƒØ«Ø± Ù†ÙˆØ¹ Ø§Ù†ØªØ´Ø§Ø±Ø§Ù‹</p>
                    <div class="target-info" id="typeInfo"></div>
                </div>
            </div>

            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø£Ø¹Ù„Ù‰ Ù‡Ù†Ø¯Ø³Ø© Ø£Ø¯Ø§Ø¡ -->
            <div class="stat-card highlight">
                <div class="stat-icon stat-icon-green">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-content">
                    <h3 id="topHandsa">-</h3>
                    <p>Ø£Ø¹Ù„Ù‰ Ù‡Ù†Ø¯Ø³Ø© Ø£Ø¯Ø§Ø¡</p>
                    <div class="target-info" id="topHandsaInfo"></div>
                </div>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="charts-grid">
            <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 1: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ù„Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© (Ø§Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ)</h3>
                    <div class="chart-filters">
                        <select id="currentWeekFilter" class="filter-select" aria-label="Current week filter">
                            <option value="current">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
                            <option value="last">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="currentHandsaChart"></canvas>
                </div>
            </div>

            <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 2: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ¹ Ù„Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ¹ (Ø§Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ)</h3>
                    <select id="currentTypeFilter" class="filter-select" aria-label="Current type filter">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</option>
                    </select>
                </div>
                <div class="chart-container">
                    <canvas id="currentTypeChart"></canvas>
                </div>
            </div>

            <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 3: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª) -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª)</h3>
                    <div class="chart-filters">
                        <select id="allHandsaFilter" class="filter-select" aria-label="All handsa filter">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="allHandsaChart"></canvas>
                </div>
            </div>

            <!-- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 4: ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª) -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª)</h3>
                    <div class="chart-filters">
                        <select id="allDiscoFilter" class="filter-select" aria-label="All sectors filter">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="allDiscoChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© -->
        <div class="chart-card chart-card-margin-bottom">
            <div class="chart-header">
                <h3>Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                <div class="chart-tabs">
                    <div class="chart-tab active" data-chart="tabHandsaChart">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>
                    <div class="chart-tab" data-chart="tabDiscoChart">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div>
                    <div class="chart-tab" data-chart="tabTypeChart">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div>
                </div>
            </div>

            <div class="chart-tab-content active" id="tabHandsaChart">
                <div class="chart-container">
                    <canvas id="advancedHandsaChart"></canvas>
                </div>
            </div>

            <div class="chart-tab-content" id="tabDiscoChart">
                <div class="chart-container">
                    <canvas id="advancedDiscoChart"></canvas>
                </div>
            </div>

            <div class="chart-tab-content" id="tabTypeChart">
                <div class="chart-container">
                    <canvas id="advancedTypeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="activity-card">
            <div class="activity-header">
                <h3>Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© (Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨)</h3>
                <button class="btn btn-outline" id="viewAllBtn">
                    <i class="fas fa-list"></i>
                    Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
                </button>
            </div>
            <ul class="activity-list" id="activityList">
                <!-- Dynamic content will be loaded here -->
            </ul>
        </div>
    </div>
    </div>

    <!-- Firebase & Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyABeLySOk_10XjaHSUjkfnR8f3HSTFkEYU",
            authDomain: "ndedc-smartmeter.firebaseapp.com",
            databaseURL: "https://ndedc-smartmeter-default-rtdb.firebaseio.com",
            projectId: "ndedc-smartmeter",
            storageBucket: "ndedc-smartmeter.appspot.com",
            messagingSenderId: "557422247352",
            appId: "1:557422247352:web:824d4f96affd7bbb0fa34d",
            measurementId: "G-3DCP87C92Y"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // DOM Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notification = document.getElementById('notification');
        const refreshBtn = document.getElementById('refreshBtn');
        const exportBtn = document.getElementById('exportBtn');
        const currentDateEl = document.getElementById('currentDate');
        const viewAllBtn = document.getElementById('viewAllBtn');
        const alertBanner = document.getElementById('alertBanner');
        const alertMessage = document.getElementById('alertMessage');
        const closeAlertBtn = document.getElementById('closeAlertBtn');
        const rankingList = document.getElementById('rankingList');
        const activityList = document.getElementById('activityList');
        const chartTabs = document.querySelectorAll('.chart-tab');
        const chartTabContents = document.querySelectorAll('.chart-tab-content');
        const currentWeekFilter = document.getElementById('currentWeekFilter');
        const currentTypeFilter = document.getElementById('currentTypeFilter');
        const allHandsaFilter = document.getElementById('allHandsaFilter');
        const allDiscoFilter = document.getElementById('allDiscoFilter');

        // Global variables
        let allData = [];
        let currentHandsaChart = null;
        let currentTypeChart = null;
        let allHandsaChart = null;
        let allDiscoChart = null;
        let advancedHandsaChart = null;
        let advancedDiscoChart = null;
        let advancedTypeChart = null;

        // Weekly targets - Ù‡Ø¯Ù 25 Ø¹Ø¯Ø§Ø¯ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹ Ù„ÙƒÙ„ Ù‡Ù†Ø¯Ø³Ø©
        const WEEKLY_TARGET_METERS = 25;

        // Set current date
        function updateCurrentDate() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timeZone: 'Africa/Cairo'
            };
            currentDateEl.textContent = now.toLocaleDateString('ar-EG', options);
        }

        // Helper function to parse date from DD/MM/YYYY format
        function parseDate(dateString) {
            if (!dateString) return null;

            try {
                // Handle both DD/MM/YYYY and other formats
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        // DD/MM/YYYY format
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1; // Months are 0-indexed
                        const year = parseInt(parts[2], 10);

                        // Handle 2-digit years
                        const fullYear = year < 100 ? 2000 + year : year;
                        return new Date(fullYear, month, day);
                    }
                } else if (dateString.includes('-')) {
                    // Handle YYYY-MM-DD format
                    return new Date(dateString);
                }

                // Try default Date parse
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? null : date;
            } catch (e) {
                console.error('Error parsing date:', dateString, e);
                return null;
            }
        }

        // Get current week data (Sunday to Saturday - Egyptian work week)
        function getCurrentWeekData() {
            const now = new Date();

            // Set to Egypt timezone
            const egyptNow = new Date(now.toLocaleString('en-US', { timeZone: 'Africa/Cairo' }));

            // Get current day of week (0 = Sunday, 1 = Monday, etc.)
            const day = egyptNow.getDay();

            // Calculate start of week (Sunday)
            const startOfWeek = new Date(egyptNow);
            const diff = day; // Since day 0 is Sunday, diff = 0 means today is Sunday
            startOfWeek.setDate(egyptNow.getDate() - diff);
            startOfWeek.setHours(0, 0, 0, 0);

            // Calculate end of week (Saturday)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            console.log('Current week (Egypt time):',
                startOfWeek.toLocaleDateString('en-GB'),
                'to',
                endOfWeek.toLocaleDateString('en-GB')
            );
            console.log('Today:', egyptNow.toLocaleDateString('en-GB'));

            return { startDate: startOfWeek, endDate: endOfWeek };
        }
        // Get last week data
        function getLastWeekData() {
            const now = new Date();
            const lastWeek = new Date(now);
            lastWeek.setDate(now.getDate() - 7);

            const day = lastWeek.getDay();
            const startOfWeek = new Date(lastWeek);
            const diff = day === 0 ? -6 : 1 - day;
            startOfWeek.setDate(lastWeek.getDate() + diff);
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            console.log('Last week:', startOfWeek.toLocaleDateString(), 'to', endOfWeek.toLocaleDateString());
            return { startDate: startOfWeek, endDate: endOfWeek };
        }

        // Get week before last week data
        function getWeekBeforeLastData() {
            const now = new Date();
            const twoWeeksAgo = new Date(now);
            twoWeeksAgo.setDate(now.getDate() - 14);

            const day = twoWeeksAgo.getDay();
            const startOfWeek = new Date(twoWeeksAgo);
            const diff = day === 0 ? -6 : 1 - day;
            startOfWeek.setDate(twoWeeksAgo.getDate() + diff);
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            console.log('Week before last:', startOfWeek.toLocaleDateString(), 'to', endOfWeek.toLocaleDateString());
            return { startDate: startOfWeek, endDate: endOfWeek };
        }

        // Filter data by week
        function filterByWeek(data, weekFilter) {
            console.log('Filtering by week:', weekFilter, 'Total data:', data.length);

            if (weekFilter === 'all' || !weekFilter) {
                console.log('Returning all data');
                return data;
            }

            let weekData;
            if (weekFilter === 'current') {
                weekData = getCurrentWeekData();
            } else if (weekFilter === 'last') {
                weekData = getLastWeekData();
            } else if (weekFilter === 'last2') {
                weekData = getWeekBeforeLastData();
            } else {
                console.log('Unknown week filter, returning all data');
                return data;
            }

            const filteredData = data.filter(item => {
                const installDate = parseDate(item.installDate);
                if (!installDate) {
                    console.log('No valid date for item:', item.serial);
                    return false;
                }

                const inRange = installDate >= weekData.startDate && installDate <= weekData.endDate;

                if (inRange) {
                    console.log('Item in range:', item.serial, 'Date:', item.installDate,
                        'Parsed:', installDate.toLocaleDateString());
                }

                return inRange;
            });

            console.log(`Filtered ${filteredData.length} items for ${weekFilter} week`);

            // Log some sample dates for debugging
            if (filteredData.length > 0) {
                console.log('Sample filtered items:',
                    filteredData.slice(0, 3).map(d => ({ serial: d.serial, date: d.installDate }))
                );
            }

            return filteredData;
        }

        // Alternative: Simple date-based filtering
        function filterByDateRange(data, startDate, endDate) {
            if (!startDate && !endDate) return data;

            return data.filter(item => {
                const installDate = parseDate(item.installDate);
                if (!installDate) return false;

                if (startDate && installDate < startDate) return false;
                if (endDate && installDate > endDate) return false;

                return true;
            });
        }

        // Get week number for a date
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7)); // Thursday in current week
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
            return weekNo;
        }

        // Group data by week
        function groupDataByWeek(data) {
            const weeks = {};

            data.forEach(item => {
                const installDate = parseDate(item.installDate);
                if (!installDate) return;

                const weekNumber = getWeekNumber(installDate);
                const year = installDate.getFullYear();
                const weekKey = `${year}-W${weekNumber.toString().padStart(2, '0')}`;

                if (!weeks[weekKey]) {
                    weeks[weekKey] = {
                        week: weekKey,
                        year: year,
                        weekNumber: weekNumber,
                        startDate: new Date(installDate),
                        endDate: new Date(installDate),
                        count: 0,
                        items: []
                    };
                }

                weeks[weekKey].count++;
                weeks[weekKey].items.push(item);

                // Update start and end dates
                if (installDate < weeks[weekKey].startDate) {
                    weeks[weekKey].startDate = new Date(installDate);
                }
                if (installDate > weeks[weekKey].endDate) {
                    weeks[weekKey].endDate = new Date(installDate);
                }
            });

            // Convert to array and sort by date
            return Object.values(weeks).sort((a, b) => b.startDate - a.startDate);
        }

        // Debug function to see what's happening
        function debugWeekFilter(data) {
            console.log('=== DEBUG WEEK FILTER ===');

            // Get all dates
            const dates = data.map(item => ({
                serial: item.serial,
                date: item.installDate,
                parsed: parseDate(item.installDate)
            })).filter(d => d.parsed);

            console.log('All dates with parsable dates:', dates.length);

            // Get current week
            const currentWeek = getCurrentWeekData();
            console.log('Current week range:',
                currentWeek.startDate.toLocaleDateString(),
                'to',
                currentWeek.endDate.toLocaleDateString()
            );

            // Get last week
            const lastWeek = getLastWeekData();
            console.log('Last week range:',
                lastWeek.startDate.toLocaleDateString(),
                'to',
                lastWeek.endDate.toLocaleDateString()
            );

            // Check which dates fall in each week
            const currentWeekDates = dates.filter(d =>
                d.parsed >= currentWeek.startDate && d.parsed <= currentWeek.endDate
            );
            const lastWeekDates = dates.filter(d =>
                d.parsed >= lastWeek.startDate && d.parsed <= lastWeek.endDate
            );

            console.log('Dates in current week:', currentWeekDates.length);
            console.log('Dates in last week:', lastWeekDates.length);

            // Show sample of last week dates
            if (lastWeekDates.length > 0) {
                console.log('Sample last week dates:',
                    lastWeekDates.slice(0, 5).map(d => ({ serial: d.serial, date: d.date }))
                );
            }

            return {
                currentWeek: currentWeekDates,
                lastWeek: lastWeekDates,
                allDates: dates
            };
        }




        // Helper functions
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Fetch data from Firebase
        async function fetchDashboardData() {
            showLoading();

            try {
                console.log('Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                const dbRef = ref(db, "SMART");
                const snapshot = await get(dbRef);

                if (!snapshot.exists()) {
                    showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    updateStats();
                    updateRecentActivity();
                    return;
                }

                allData = [];
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    if (data && typeof data === 'object') {
                        data.firebaseKey = childSnapshot.key;
                        // ØªØ­ÙˆÙŠÙ„ installDate Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ù‚ÙŠØ§Ø³ÙŠ
                        if (data.installDate) {
                            const parsedDate = parseDate(data.installDate);
                            if (parsedDate) {
                                data.parsedInstallDate = parsedDate;
                                data.formattedInstallDate = parsedDate.toLocaleDateString('ar-EG');
                            }
                        }
                        allData.push(data);
                    }
                });

                console.log(`ØªÙ… Ø¬Ù„Ø¨ ${allData.length} Ø³Ø¬Ù„`);
                processData(allData);
                showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ - ${allData.length} Ø¹Ø¯Ø§Ø¯`, 'success');

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Process and filter data
        function processData(data) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø´Ø­Ø§Øª
            updateFilterDropdowns();
            updateAllUI();
        }

        // Update filter dropdowns
        function updateFilterDropdowns() {
            // ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø´Ø­ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
            const discos = new Set(allData.map(item => item.discoSec).filter(Boolean));
            updateFilterDropdown(allDiscoFilter, Array.from(discos), 'Ø§Ù„Ù‚Ø·Ø§Ø¹');

            // ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø´Ø­ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
            const handsas = new Set(allData.map(item => item.discoBranch).filter(Boolean));
            updateFilterDropdown(allHandsaFilter, Array.from(handsas), 'Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©');

            // ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø´Ø­ Ø§Ù„Ù†ÙˆØ¹ Ù„Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const types = new Set(allData.map(item => item.type).filter(Boolean));
            updateFilterDropdown(currentTypeFilter, Array.from(types), 'Ø§Ù„Ù†ÙˆØ¹');
        }

        function updateFilterDropdown(select, values, label) {
            select.innerHTML = `<option value="">Ø¬Ù…ÙŠØ¹ ${label}</option>`;
            values.sort().forEach(value => {
                if (value && value.trim() !== '') {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                }
            });
        }

        // Update all UI components
        function updateAllUI() {
            updateStats();
            updateRanking();
            updateAlert();
            updateCurrentCharts();
            updateAllTimeCharts();
            updateAdvancedCharts();
            updateRecentActivity();
        }

        // Update statistics cards
        function updateStats() {
            // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            document.getElementById('totalMeters').textContent = formatNumber(allData.length);

            // Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
            const currentWeekData = filterByWeek(allData, 'current');
            const totalWeekMeters = currentWeekData.length;
            document.getElementById('totalWeekMeters').textContent = formatNumber(totalWeekMeters);

            // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ
            const weekProgressPercentage = Math.min(100, Math.round((totalWeekMeters / WEEKLY_TARGET_METERS) * 100));
            document.getElementById('weekProgressPercentage').textContent = `${weekProgressPercentage}%`;

            const weekProgressFill = document.getElementById('weekProgressFill');
            weekProgressFill.style.width = `${weekProgressPercentage}%`;

            if (weekProgressPercentage < 50) {
                weekProgressFill.className = 'progress-fill critical';
            } else if (weekProgressPercentage < 80) {
                weekProgressFill.className = 'progress-fill warning';
            } else {
                weekProgressFill.className = 'progress-fill';
            }

            // Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª
            const discos = new Set(allData.map(item => item.discoSec).filter(Boolean));
            document.getElementById('totalDisco').textContent = formatNumber(discos.size);

            // Ø¹Ø¯Ø¯ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª
            const handsas = new Set(allData.map(item => item.discoBranch).filter(Boolean));
            document.getElementById('totalHandsa').textContent = formatNumber(handsas.size);

            // Ø£ÙƒØ«Ø± Ù†ÙˆØ¹ Ø§Ù†ØªØ´Ø§Ø±Ø§Ù‹
            const typeCounts = {};
            allData.forEach(item => {
                const type = item.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            let mostCommonType = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            let maxCount = 0;
            Object.entries(typeCounts).forEach(([type, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    mostCommonType = type;
                }
            });

            const totalMeters = allData.length;
            const typePercentage = totalMeters > 0 ? Math.round((maxCount / totalMeters) * 100) : 0;
            document.getElementById('typeDistribution').textContent = mostCommonType;
            document.getElementById('typeInfo').textContent = `${maxCount} Ø¹Ø¯Ø§Ø¯ (${typePercentage}%)`;

            // Ø£Ø¹Ù„Ù‰ Ù‡Ù†Ø¯Ø³Ø© Ø£Ø¯Ø§Ø¡
            const handsaCounts = {};
            allData.forEach(item => {
                const handsa = item.discoBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (handsa !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    handsaCounts[handsa] = (handsaCounts[handsa] || 0) + 1;
                }
            });

            let topHandsa = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            let topHandsaCount = 0;
            Object.entries(handsaCounts).forEach(([handsa, count]) => {
                if (count > topHandsaCount) {
                    topHandsaCount = count;
                    topHandsa = handsa;
                }
            });

            document.getElementById('topHandsa').textContent = topHandsa;
            document.getElementById('topHandsaInfo').textContent = `${topHandsaCount} Ø¹Ø¯Ø§Ø¯`;
        }

        // Update ranking of Handsa based on weekly installations
        function updateRanking() {
            const currentWeekData = filterByWeek(allData, 'current');

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const handsaCounts = {};
            currentWeekData.forEach(item => {
                const handsa = item.discoBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (handsa !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    handsaCounts[handsa] = (handsaCounts[handsa] || 0) + 1;
                }
            });

            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ÙˆØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ (Ø§Ù„Ø£Ù‚Ù„ ØªØ±ÙƒÙŠØ¨Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹)
            const ranking = Object.entries(handsaCounts)
                .map(([handsa, count]) => ({
                    handsa,
                    count,
                    percentage: Math.min(100, (count / WEEKLY_TARGET_METERS) * 100)
                }))
                .sort((a, b) => a.percentage - b.percentage)
                .slice(0, 5); // Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„ 5 ÙÙ‚Ø·

            if (ranking.length === 0) {
                rankingList.innerHTML = `
                    <div class="ranking-item">
                        <div class="ranking-info">
                            <div class="ranking-number">1</div>
                            <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                        </div>
                    </div>
                `;
                return;
            }

            let rankingHTML = '';
            ranking.forEach((item, index) => {
                let statusClass = '';
                if (item.percentage < 50) statusClass = 'ranking-critical';
                else if (item.percentage < 80) statusClass = 'ranking-warning';
                else statusClass = 'ranking-good';

                rankingHTML += `
                    <div class="ranking-item ${statusClass}">
                        <div class="ranking-info">
                            <div class="ranking-number">${index + 1}</div>
                            <div>
                                <strong>${item.handsa}</strong>
                                <br>
                                <small>${item.count} Ø¹Ø¯Ø§Ø¯</small>
                            </div>
                        </div>
                        <div class="ranking-percentage">${item.percentage.toFixed(1)}%</div>
                    </div>
                `;
            });

            rankingList.innerHTML = rankingHTML;
        }

        // Update alert for delayed Handsa
        function updateAlert() {
            const currentWeekData = filterByWeek(allData, 'current');
            const handsaCounts = {};
            currentWeekData.forEach(item => {
                const handsa = item.discoBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (handsa !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    handsaCounts[handsa] = (handsaCounts[handsa] || 0) + 1;
                }
            });

            // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª Ø§Ù„ØªÙŠ ØªÙ‚Ù„ Ø¹Ù† 50% Ù…Ù† Ø§Ù„Ù‡Ø¯Ù
            const delayedHandsas = Object.entries(handsaCounts)
                .filter(([_, count]) => (count / WEEKLY_TARGET_METERS) * 100 < 50)
                .sort((a, b) => (a[1] / WEEKLY_TARGET_METERS) - (b[1] / WEEKLY_TARGET_METERS));

            if (delayedHandsas.length > 0) {
                const alertText = delayedHandsas.map(([handsa, count]) =>
                    `${handsa}: ${count} Ø¹Ø¯Ø§Ø¯ (${((count / WEEKLY_TARGET_METERS) * 100).toFixed(1)}%)`
                ).join('ØŒ ');

                alertMessage.textContent = `Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©: ${alertText}`;
                alertBanner.classList.add('show');
            } else {
                alertBanner.classList.remove('show');
            }
        }

        // Update current installation charts
        function updateCurrentCharts() {
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª Ù„Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const weekFilterValue = currentWeekFilter.value;
            const currentData = filterByWeek(allData, weekFilterValue);

            const handsaCounts = {};
            currentData.forEach(item => {
                const handsa = item.discoBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (handsa !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    handsaCounts[handsa] = (handsaCounts[handsa] || 0) + 1;
                }
            });

            const sortedHandsas = Object.entries(handsaCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            const handsaLabels = sortedHandsas.map(item => item[0]);
            const handsaData = sortedHandsas.map(item => item[1]);

            if (currentHandsaChart) {
                currentHandsaChart.destroy();
            }

            const handsaCtx = document.getElementById('currentHandsaChart').getContext('2d');
            if (handsaCtx) {
                currentHandsaChart = new Chart(handsaCtx, {
                    type: 'bar',
                    data: {
                        labels: handsaLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
                            data: handsaData,
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = currentData.length;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${value} Ø¹Ø¯Ø§Ø¯ (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: { family: 'Cairo' },
                                    callback: function (value) {
                                        return formatNumber(value);
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: { family: 'Cairo' },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ¹ Ù„Ù„ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const typeCounts = {};
            currentData.forEach(item => {
                const type = item.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const typeLabels = Object.keys(typeCounts);
            const typeData = Object.values(typeCounts);

            if (currentTypeChart) {
                currentTypeChart.destroy();
            }

            const typeCtx = document.getElementById('currentTypeChart').getContext('2d');
            if (typeCtx) {
                currentTypeChart = new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: typeLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
                            data: typeData,
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#f39c12', '#e74c3c',
                                '#9b59b6', '#1abc9c', '#34495e', '#7f8c8d'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'left',
                                labels: {
                                    font: {
                                        family: 'Cairo',
                                        size: 12
                                    },
                                    padding: 15
                                }
                            },
                            title: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = currentData.length;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} Ø¹Ø¯Ø§Ø¯ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Update all-time charts
        function updateAllTimeCharts() {
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
            const filteredData = filterDataByFilters(allData);

            const handsaCounts = {};
            filteredData.forEach(item => {
                const handsa = item.discoBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (handsa !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    handsaCounts[handsa] = (handsaCounts[handsa] || 0) + 1;
                }
            });

            const sortedHandsas = Object.entries(handsaCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            const handsaLabels = sortedHandsas.map(item => item[0]);
            const handsaData = sortedHandsas.map(item => item[1]);

            if (allHandsaChart) {
                allHandsaChart.destroy();
            }

            const allHandsaCtx = document.getElementById('allHandsaChart').getContext('2d');
            if (allHandsaCtx) {
                allHandsaChart = new Chart(allHandsaCtx, {
                    type: 'bar',
                    data: {
                        labels: handsaLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
                            data: handsaData,
                            backgroundColor: '#2ecc71',
                            borderColor: '#27ae60',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = filteredData.length;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${value} Ø¹Ø¯Ø§Ø¯ (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: { family: 'Cairo' },
                                    callback: function (value) {
                                        return formatNumber(value);
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: { family: 'Cairo' },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
            const discoCounts = {};
            filteredData.forEach(item => {
                const disco = item.discoSec || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (disco !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    discoCounts[disco] = (discoCounts[disco] || 0) + 1;
                }
            });

            const sortedDiscos = Object.entries(discoCounts)
                .sort((a, b) => b[1] - a[1]);

            const discoLabels = sortedDiscos.map(item => item[0]);
            const discoData = sortedDiscos.map(item => item[1]);

            if (allDiscoChart) {
                allDiscoChart.destroy();
            }

            const discoCtx = document.getElementById('allDiscoChart').getContext('2d');
            if (discoCtx) {
                allDiscoChart = new Chart(discoCtx, {
                    type: 'pie',
                    data: {
                        labels: discoLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
                            data: discoData,
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#f39c12', '#e74c3c',
                                '#9b59b6', '#1abc9c', '#34495e', '#7f8c8d',
                                '#d35400', '#27ae60'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'left',
                                labels: {
                                    font: {
                                        family: 'Cairo',
                                        size: 12
                                    },
                                    padding: 15
                                }
                            },
                            title: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = filteredData.length;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} Ø¹Ø¯Ø§Ø¯ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Update advanced charts
        function updateAdvancedCharts() {
            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
            const handsaCounts = {};
            allData.forEach(item => {
                const handsa = item.discoBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (handsa !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    handsaCounts[handsa] = (handsaCounts[handsa] || 0) + 1;
                }
            });

            const sortedHandsas = Object.entries(handsaCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const handsaLabels = sortedHandsas.map(item => item[0]);
            const handsaData = sortedHandsas.map(item => item[1]);

            if (advancedHandsaChart) {
                advancedHandsaChart.destroy();
            }

            const advancedHandsaCtx = document.getElementById('advancedHandsaChart').getContext('2d');
            if (advancedHandsaCtx) {
                advancedHandsaChart = new Chart(advancedHandsaCtx, {
                    type: 'bar',
                    data: {
                        labels: handsaLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
                            data: handsaData,
                            backgroundColor: '#9b59b6',
                            borderColor: '#8e44ad',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = allData.length;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${value} Ø¹Ø¯Ø§Ø¯ (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: { family: 'Cairo' },
                                    callback: function (value) {
                                        return formatNumber(value);
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: { family: 'Cairo' },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }

            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
            const discoCounts = {};
            allData.forEach(item => {
                const disco = item.discoSec || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (disco !== 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                    discoCounts[disco] = (discoCounts[disco] || 0) + 1;
                }
            });

            const sortedDiscos = Object.entries(discoCounts)
                .sort((a, b) => b[1] - a[1]);

            const discoLabels = sortedDiscos.map(item => item[0]);
            const discoData = sortedDiscos.map(item => item[1]);

            if (advancedDiscoChart) {
                advancedDiscoChart.destroy();
            }

            const advancedDiscoCtx = document.getElementById('advancedDiscoChart').getContext('2d');
            if (advancedDiscoCtx) {
                advancedDiscoChart = new Chart(advancedDiscoCtx, {
                    type: 'pie',
                    data: {
                        labels: discoLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
                            data: discoData,
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#f39c12', '#e74c3c',
                                '#9b59b6', '#1abc9c', '#34495e', '#7f8c8d'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'left',
                                labels: {
                                    font: {
                                        family: 'Cairo',
                                        size: 12
                                    },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = allData.length;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} Ø¹Ø¯Ø§Ø¯ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
            const typeCounts = {};
            allData.forEach(item => {
                const type = item.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const typeLabels = Object.keys(typeCounts);
            const typeData = Object.values(typeCounts);

            if (advancedTypeChart) {
                advancedTypeChart.destroy();
            }

            const advancedTypeCtx = document.getElementById('advancedTypeChart').getContext('2d');
            if (advancedTypeCtx) {
                advancedTypeChart = new Chart(advancedTypeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: typeLabels,
                        datasets: [{
                            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª',
                            data: typeData,
                            backgroundColor: [
                                '#3498db', '#2ecc71', '#f39c12', '#e74c3c',
                                '#9b59b6', '#1abc9c', '#34495e', '#7f8c8d'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'left',
                                labels: {
                                    font: {
                                        family: 'Cairo',
                                        size: 12
                                    },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const value = context.raw;
                                        const total = allData.length;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${context.label}: ${value} Ø¹Ø¯Ø§Ø¯ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Filter data by filters
        function filterDataByFilters(data) {
            const discoFilterValue = allDiscoFilter.value;
            const handsaFilterValue = allHandsaFilter.value;

            return data.filter(item => {
                if (discoFilterValue && item.discoSec !== discoFilterValue) return false;
                if (handsaFilterValue && item.discoBranch !== handsaFilterValue) return false;
                return true;
            });
        }

        // Update recent activity sorted by installDate
        function updateRecentActivity() {
            activityList.innerHTML = '';

            // ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±ÙƒÙŠØ¨ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            const recentData = [...allData]
                .filter(item => item.parsedInstallDate)
                .sort((a, b) => b.parsedInstallDate - a.parsedInstallDate)
                .slice(0, 10);

            if (recentData.length === 0) {
                activityList.innerHTML = `
                    <li class="activity-item">
                        <div class="activity-content">
                            <p class="no-activity-message">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ© Ù…Ø¤Ø®Ø±Ù‹Ø§
                            </p>
                        </div>
                    </li>
                `;
                return;
            }

            const colors = ['#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#e74c3c'];

            recentData.forEach((item, index) => {
                const color = colors[index % colors.length];

                const activityItem = document.createElement('li');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-icon" style="--icon-bg: ${color}">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="activity-content">
                        <h4>${item.serial || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</h4>
                        <p>${item.facDesc || item.model || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</p>
                        <div class="activity-details">
                            <span class="activity-detail">
                                <i class="fas fa-sitemap"></i>
                                ${item.discoBranch || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </span>
                            <span class="activity-detail">
                                <i class="fas fa-tag"></i>
                                ${item.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </span>
                            <span class="activity-detail">
                                <i class="fas fa-calendar-alt"></i>
                                ${item.formattedInstallDate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
                            </span>
                        </div>
                    </div>
                `;

                activityList.appendChild(activityItem);
            });
        }

        // Export data
        function exportData() {
            if (allData.length === 0) {
                showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'warning');
                return;
            }

            const headers = ['Serial', 'SIM', 'Badge', 'Model', 'EEHC Code',
                'Facility Description', 'Disco', 'Disco Section', 'Disco Branch',
                'Area', 'Loss Area', 'Device Function', 'Distribution Facility',
                'Installation Date', 'Address', 'Type', 'Latitude', 'Longitude'];

            const csvRows = [headers.join(',')];

            allData.forEach(item => {
                const row = [
                    item.serial || '', item.sim || '', item.badge || '',
                    item.model || '', item.code1 || '',
                    item.facDesc || '', item.disco || '', item.discoSec || '',
                    item.discoBranch || '', item.area || '', item.lossArea || '',
                    item.devFunc || '', item.distFac || '', item.installDate || '',
                    item.addr4 || '', item.type || '', item.lat || '', item.lon || ''
                ].map(value => `"${value}"`).join(',');

                csvRows.push(row);
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `smart-meters-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification(`ØªÙ… ØªØµØ¯ÙŠØ± ${allData.length} Ø³Ø¬Ù„`, 'success');
        }

        // Chart tabs functionality
        chartTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                chartTabs.forEach(t => t.classList.remove('active'));
                chartTabContents.forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab
                tab.classList.add('active');

                // Show corresponding content
                const chartId = tab.getAttribute('data-chart');
                document.getElementById(chartId).classList.add('active');
            });
        });

        // Event Listeners for filters
        currentWeekFilter.addEventListener('change', updateCurrentCharts);
        currentTypeFilter.addEventListener('change', updateCurrentCharts);
        allHandsaFilter.addEventListener('change', updateAllTimeCharts);
        allDiscoFilter.addEventListener('change', updateAllTimeCharts);

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentDate();
            fetchDashboardData().catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ', 'error');
            });
            setInterval(updateCurrentDate, 60000);
        });

        refreshBtn.addEventListener('click', () => {
            fetchDashboardData().catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            });
        });

        exportBtn.addEventListener('click', exportData);
        viewAllBtn.addEventListener('click', () => window.open('SMART_R.html', '_blank'));
        closeAlertBtn.addEventListener('click', () => {
            alertBanner.classList.remove('show');
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            fetchDashboardData().catch(error => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
            });
        }, 300000);

    </script>
    <script>
        (function () {
            const checkbox = document.getElementById("darkToggle");

            function setDark(enable) {
                if (enable) {
                    document.body.classList.add("dark-mode");
                    localStorage.setItem("darkMode", "1");
                } else {
                    document.body.classList.remove("dark-mode");
                    localStorage.setItem("darkMode", "0");
                }
                if (checkbox) checkbox.setAttribute("aria-checked", enable);
            }

            window.toggleDarkMode = function () {
                if (checkbox) setDark(!checkbox.checked);
            };

            if (checkbox) {
                checkbox.addEventListener("change", function (e) {
                    setDark(e.target.checked);
                });
            }

            function init() {
                const saved = localStorage.getItem("darkMode");
                const enabled = saved === "1";
                if (checkbox) {
                    checkbox.checked = enabled;
                    setDark(enabled);
                }
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", init);
            } else {
                init();
            }
        })();
    </script>
</body>

</html>
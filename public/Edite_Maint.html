<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ุชุนุฏูู ุจูุงูุงุช ุนุฏุงุฏ โ ุงูุตูุงูุฉ</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS -->
    <link rel="stylesheet" href="G1_Calib.css" />

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
  </head>

  <body>
    <main class="app">
      <!-- RIGHT SIDE : TABLE -->
      <div class="right-side">
        <section class="table-top-section">
          <div class="table-header">
            <ion-icon name="list-outline"></ion-icon>

            <div class="modern-dropdown">
              <button class="dropdown-btn" id="dropdownBtn">
                โพ ุงุฎุชุฑ ุงูุตูุญุฉ ููุงูุชูุงู
              </button>

              <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-group" data-icon="๐๏ธ">ุงูุตูุงูุฉ</div>
                <div class="dropdown-item" data-page="Entr_Maint.html">
                  ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ
                </div>
                <div class="dropdown-item" data-page="Maint.html">
                  ุตูุงูุฉ ุนุฏุงุฏ
                </div>
                <div class="dropdown-item" data-page="Edite_Maint.html">
                  ุชุนุฏูู ุจูุงูุงุช ุตูุงูุฉ ุนุฏุงุฏ
                </div>
                <div class="dropdown-item" data-page="Print_Out_SMaint.html">
                  ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุตูุงูุฉ ุนุฏุงุฏ
                </div>
                <div class="dropdown-item" data-page="Print_Out_TMaint.html">
                  ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน ุตูุงูุฉ ุนุฏุงุฏ
                </div>
                <div class="dropdown-item" data-page="Re_Print_Out_SMaint.html">
                  ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุตูุงูุฉ ุนุฏุงุฏ
                </div>
                <div class="dropdown-item" data-page="Re_Print_Out_TMaint.html">
                  ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน ุตูุงูุฉ ุนุฏุงุฏ
                </div>

                <div class="dropdown-group" data-icon="๐">ุชูุงุฑูุฑ ุงูุตูุงูุฉ</div>
                <div class="dropdown-item" data-page="R_Entr_Maint.html">
                  ุชูุฑูุฑ ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ
                </div>
                <div class="dropdown-item" data-page="R_Maint.html">
                  ุชูุฑูุฑ ุตูุงูุฉ ุนุฏุงุฏ
                </div>

                <div class="dropdown-group" data-icon="๐๏ธ">ุงูุฃุฑุดูู</div>
                <div class="dropdown-item" data-page="R_Maint_Archive.html">
                  ุฃุฑุดูู ุงูุตูุงูุฉ
                </div>
                <div
                  class="dropdown-item"
                  data-page="Main_Dashboard.html"
                  data-icon="๐"
                >
                  ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
                </div>
              </div>
            </div>

            <input type="date" id="calib_date" class="calib_date" readonly />

            <div class="table-header-controls">
              <input id="searchInput" placeholder="๐ ุจุญุซ ุจุฑูู ุงูุนุฏุงุฏ" />
              <button id="exportBtn">
                <ion-icon name="download-outline"></ion-icon> ุชุตุฏูุฑ Excel
              </button>
            </div>
          </div>
        </section>

        <section class="table-wrapper">
          <div class="table-container">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>ู</th>
                  <th>ุฑูู ุงูุนุฏุงุฏ</th>
                  <th>ุณูุฉ ุงูุตูุน</th>
                  <th>ุงููุฑุงุกุฉ</th>
                  <th>ุงููุฏุฑุฉ</th>
                  <th>ููุน ุงูุนุฏุงุฏ</th>
                  <th>ููุน ุงูุชูุตูู</th>
                  <th>ุงููุทุงุน</th>
                  <th>ุงูููุฏุณุฉ</th>
                  <th>ุณุจุจ ุงูุฑูุน</th>
                  <th>ุชุงุฑูุฎ ุงูุฑูุน</th>
                  <th>ุชูุฑูุฑ ุงูููุฏุณุฉ</th>
                  <th>ุชุงุฑูุฎ ุฏุฎูู ุงูุตูุงูุฉ</th>
                  <th>ุชูุฑูุฑ ุงูุตูุงูุฉ</th>
                  <th>ุชุงุฑูุฎ ุงูุตูุงูุฉ</th>
                  <th>ููุงุญุธุงุช</th>
                  <th>ุงูุญุงูุฉ</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </section>

        <div class="row-counter-dashboard">
          <div class="dashboard-card">
            <h3>ุนุฏุฏ ุงูุณุฌูุงุช</h3>
            <span id="rowCountValue">0</span>
          </div>
        </div>

        <div class="scroll-buttons">
          <button id="scrollUp" class="scroll-btn" aria-label="ุชูุฑูุฑ ูุฃุนูู">
            <ion-icon name="chevron-up-outline"></ion-icon>
          </button>
          <button id="scrollDown" class="scroll-btn" aria-label="ุชูุฑูุฑ ูุฃุณูู">
            <ion-icon name="chevron-down-outline"></ion-icon>
          </button>
        </div>
      </div>

      <!-- LEFT SIDE : FORM -->
      <div class="left-side">
        <section class="glass">
          <div class="header-top">

            <label class="dark-toggle" title="Toggle dark mode">
              <input
                id="darkToggle"
                class="dark-toggle__input"
                type="checkbox"
                aria-label="Dark mode toggle"
                role="switch"
                aria-checked="false"
              />
              <span class="switch"></span>
              <span class="icon">๐</span>
            </label>
            
            <div class="logo">
              <ion-icon name="construct-outline"></ion-icon>
            </div>
            <div>
              ูุฒุงุฑุฉ ุงูููุฑุจุงุก ูุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ<br />
              ุงูุดุฑูุฉ ุงููุงุจุถุฉ ูููุฑุจุงุก ูุตุฑ<br />
              ุดุฑูุฉ ุดูุงู ุงูุฏูุชุง ูุชูุฒูุน ุงูููุฑุจุงุก
            </div>
          </div>

          <h1 class="title-main">ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ูุฃูุธูุฉ ุงูุนุฏุงุฏุงุช ุงูุญุฏูุซุฉ</h1>

          <h3>ุชุนุฏูู ุจูุงูุงุช ุงูุนุฏุงุฏุงุช ุงููุณุฌูุฉ ููุตูุงูุฉ</h3>

          <div class="form-grid">
            <input id="mno" placeholder="ุฑูู ุงูุนุฏุงุฏ" />
            <input id="year" placeholder="ุณูุฉ ุงูุตูุน" />
            <input id="mreading" placeholder="ุงููุฑุงุกุฉ ูุจู ุงููุญุต" />
            <input id="mpower" placeholder="ููุฉ ุงูุนุฏุงุฏ" />
            <select id="mtype" aria-label="ููุน ุงูุนุฏุงุฏ">
              <option value="">โพ ุงุฎุชุฑ ููุน ุงูุนุฏุงุฏ</option>
              <option>ุฌููุจุงู-ูุณุจู</option>
              <option>ุณููุฏู-ูุณุจู</option>
              <option>ุงููุตุฑูุฉ-ูุณุจู</option>
              <option>ุงุณูุฑุง-ูุณุจู</option>
              <option>ุฌูุฒุฉ ุจุงูุฑ-ูุณุจู</option>
              <option>ูููุงูููู</option>
              <option>ุฑููู</option>
              <option>ุนุฏุงุฏุงุช-ุฐููุฉ</option>
              <option>ุฃุฎุฑู</option>
            </select>
            <select id="mconn" aria-label="ููุน ุงูุชูุตูู">
              <option value="">โพููุน ุงูุชูุตูู</option>
              <option>ุฃุญุงุฏู</option>
              <option>ุซูุงุซู-ูุจุงุดุฑ</option>
              <option>ุซูุงุซู-ุบูุฑ ูุจุงุดุฑ</option>
            </select>
            <select id="keta3" aria-label="ุงููุทุงุน">
              <option value="">โพ ุงููุทุงุน</option>
              <option>ุฏููุงุท</option>
              <option>ุดูุงู-ุงูุฏููููุฉ</option>
              <option>ุฌููุจ-ุงูุฏููููุฉ</option>
              <option>ููุฑ ุงูุดูุฎ</option>
            </select>

            <select id="handsa" aria-label="ุงูููุฏุณุฉ">
              <option value="">โพ ุงูููุฏุณุฉ</option>
              <option>ููุฏุณุฉ ุดูุงู ุฏููุงุท</option>
              <option>ููุฏุณุฉ ุฌููุจ ุฏููุงุท</option>
              <option>ููุฏุณุฉ ุนุฒุจุฉ ุงูุจุฑุฌ</option>
              <option>ููุฏุณุฉ ููุฑ ุณุนุฏ</option>
              <option>ููุฏุณุฉ ููุฑ ุงูุจุทูุฎ</option>
              <option>ููุฏุณุฉ ุฑุงุณ ุงูุจุฑ</option>
              <option>ููุฏุณุฉ ุฏููุงุท ุงูุฌุฏูุฏุฉ</option>
              <option>ููุฏุณุฉ ุงูุฒุฑูุง</option>
              <option>ููุฏุณุฉ ูุงุฑุณููุฑ</option>
              <option>ููุฏุณุฉ ุงูุฑูุถุฉ</option>
              <option>ููุฏุณุฉ ุงูุดุนุฑุงุก</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ุดุฑุจูู</option>
              <option>ููุฏุณุฉ ูุฑู ุดุฑุจูู</option>
              <option>ููุฏุณุฉ ุฏูุฑูุณ</option>
              <option>ููุฏุณุฉ ุฌูุตุฉ</option>
              <option>ููุฏุณุฉ ูุฑู ุจููุงุณ</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ุจููุงุณ</option>
              <option>ููุฏุณุฉ ุงูุณุชุงูููู</option>
              <option>ููุฏุณุฉ ุจูู ุนุจูุฏ</option>
              <option>ููุฏุณุฉ ูููุฉ ุงููุตุฑ</option>
              <option>ููุฏุณุฉ ููุช ุณูุณูู</option>
              <option>ููุฏุณุฉ ุงูุฌูุงููุฉ</option>
              <option>ููุฏุณุฉ ูุฑู ุงูููุฒูุฉ</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ุงูููุฒูุฉ</option>
              <option>ููุฏุณุฉ ุงููุทุฑูุฉ</option>
              <option>ููุฏุณุฉ ุดุฑู ุงูููุตูุฑุฉ</option>
              <option>ููุฏุณุฉ ุบุฑุจ ุงูููุตูุฑุฉ</option>
              <option>ููุฏุณุฉ ุทูุฎุง</option>
              <option>ููุฏุณุฉ ูุจุฑูู</option>
              <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 1</option>
              <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 2</option>
              <option>ููุฏุณุฉ ุงุฌุง</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ุงูุณูุจูุงููู</option>
              <option>ููุฏุณุฉ ูุฑู ุงูุณูุจูุงููู</option>
              <option>ููุฏุณุฉ ุชูู ุงูุงูุฏูุฏ</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ููุช ุบูุฑ</option>
              <option>ููุฏุณุฉ ูุฑู ููุช ุบูุฑ</option>
              <option>ููุฏุณุฉ ููู ุงูููุฑ</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ููุฑ ุงูุดูุฎ</option>
              <option>ููุฏุณุฉ ุบุฑุจ ููุฑ ุงูุดูุฎ</option>
              <option>ููุฏุณุฉ ุดุฑู ููุฑ ุงูุดูุฎ</option>
              <option>ููุฏุณุฉ ูููู</option>
              <option>ููุฏุณุฉ ูุฑู ุณูุฏู ุณุงูู</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ุณูุฏู ุณุงูู</option>
              <option>ููุฏุณุฉ ุงูุฑูุงุถ</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ุฏุณูู</option>
              <option>ููุฏุณุฉ ูุฑู ุดูุงู ุฏุณูู</option>
              <option>ููุฏุณุฉ ูุฑู ุฌููุจ ุฏุณูู</option>
              <option>ููุฏุณุฉ ููู</option>
              <option>ููุฏุณุฉ ูุทูุจุณ</option>
              <option>ููุฏุณุฉ ูุฏููุฉ ุงูุญุงููู</option>
              <option>ููุฏุณุฉ ูุฑู ุงูุญุงููู</option>
              <option>ููุฏุณุฉ ุจููุง</option>
              <option>ููุฏุณุฉ ุจูุทูู</option>
              <option>ููุฏุณุฉ ุจุฑุฌ ุงูุจุฑูุณ</option>
            </select>
            <select id="removingfor" aria-label="ุณุจุจ ุงูุฑูุน">
              <option value="">ุณุจุจ ุงูุฑูุน</option>
              <option>ุงููุญุต</option>
              <option>ุงูุตูุงูุฉ</option>
              <option>ุงููุฏู ูุงูุจูุงุก</option>
              <option>ุชุตููุฉ ูุดุชุฑู</option>
              <option>ุฒูุงุฏุฉ ูุฏุฑุฉ</option>
              <option>ุงุญูุงู ุฑุจุงุนู</option>
              <option>ุชูุงุฒู</option>
              <option>ุฎุทุฉ ุงุญูุงู</option>
              <option>ุงุญูุงู ุนุฏู ุณุฏุงุฏ</option>
            </select>

            <select id="mremovingfor" aria-label="ุชูุฑูุฑ ูุญุต ุงูููุฏุณุฉ">
              <option value="">ุชูุฑูุฑ ูุญุต ุงูููุฏุณุฉ</option>
              <option>ุนุทู ุจุงูุจุทุงุฑูุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
              <option>
                ูุงุฑูุก ุงููุฑูุช ูุง ูุนูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>
                ุงูุนุฏุงุฏ ูุง ููุจู ุงูุดุญู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>
                ุงูุนุฏุงุฏ ูุง ูููู ุจุงูุชูุตูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>ุงูุดุงุดุฉ ุนุงุทูุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
              <option>
                ุงูุนุฏุงุฏ ูุญุชุงุฌ ููุชููุฆุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>ุชูุฑูุฑ ูุญุต ููุนุฏุงุฏ ูู ูุจู ุงูุดุฑูุฉ ุงูููุฑุฏุฉ</option>
              <option>
                ุชูู ุจุฌุณู/ุฑูุฒุชุฉ ุงูุนุฏุงุฏ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>ุฒูุงุฏุฉ ูุฏุฑุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
              <option>ุจุญุซ ูุฏููููุฉ ุจุงูุนุฏุงุฏ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
              <option>ุงูุนุฏุงุฏ ูุญุชุฑู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
              <option>ุงูุนุฏุงุฏ ูุง ูุนูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
              <option>
                ููุจุฉ ุงูุชูุงุนุจ ุชุนูู ุจุงุณุชูุฑุงุฑ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>
                ุงูุนุฏุงุฏ ูุนูู ุจุฏูู ุดุญู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>
                ุงูุนุฏุงุฏ ูุง ูุณุฌู ุงูุงุณุชููุงู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>
                ุงูุนุฏุงุฏ ูุณุฌู ุงุณุชููุงู ุจุฏูู ุญูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
              </option>
              <option>blocking</option>
            </select>

            <select id="maintreport" aria-label="ุชูุฑูุฑ ุงูุตูุงูุฉ">
              <option value="">โพ ุงุฎุชุฑ ุชูุฑูุฑ ุงูุตูุงูุฉ</option>
              <option>ุชุบููุฑ ุงูุจุทุงุฑูุฉ</option>
              <option>ุชุบููุฑ ูุงุฑูุก ุงููุฑูุช</option>
              <option>ุตูุงูุฉ / ุชุบููุฑ ุดุงุดุฉ ุงูุนุฏุงุฏ</option>
              <option>ุตูุงูุฉ/ ุชุบููุฑ ุงูุฑููุงู</option>
              <option>ุตูุงูุฉ / ุชุบููุฑ ูุญุฏุฉ ุงูุงุชุตุงู</option>
              <option>ุตูุงูุฉ / ุชุบููุฑ ุงูุจูุฑุฏุฉ ุงูุฏุงุฎููุฉ ููุนุฏุงุฏ</option>
              <option>ุชููุฆุฉ ุงูุนุฏุงุฏ</option>
              <option>ุชุบููุฑ ุฑูุฒุชุฉ ุงูุนุฏุงุฏ</option>
              <option>ุชุบููุฑ ุฌุณู ุงูุนุฏุงุฏ</option>
              <option>ุชุบููุฑ ุงูุนุฏุงุฏ ุจุงููุงูู</option>
            </select>
            <label for="uploaddate">ุชุงุฑูุฎ ุงูุฑูุน</label>
            <input type="date" id="uploaddate" placeholder="ุชุงุฑูุฎ ุงูุฑูุน" />
            <label for="enter_maint_date">ุชุงุฑูุฎ ุฏุฎูู ุงูุตูุงูุฉ</label>
            <input
              type="date"
              id="enter_maint_date"
              placeholder="ุชุงุฑูุฎ ุฏุฎูู ุงูุตูุงูุฉ"
            />

            <textarea
              id="notes"
              placeholder="ููุงุญุธุงุช"
            ></textarea>
          </div>

          <div class="buttons">
            <button id="editBtn" class="warning">ุชุนุฏูู</button>
            <button id="clearBtn" class="secondary">ุชูุฑูุบ</button>
            <button id="deleteBtn" class="danger">ุญุฐู</button>
          </div>
        </section>
      </div>
    </main>

    <script type="module">
      // ================= FIREBASE CONFIG =================
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        get,
        update,
        remove,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
        authDomain: "ndedc-meter-calib.firebaseapp.com",
        databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com",
        projectId: "ndedc-meter-calib",
        storageBucket: "ndedc-meter-calib.appspot.com",
        messagingSenderId: "185425429190",
        appId: "1:185425429190:web:dce85f29eea55ad9f54dc7",
        measurementId: "G-C6QEKW26MW",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ================= HELPERS =================
      const el = (id) => document.getElementById(id);
      let currentEditingKey = null;

      // ุฏุงูุฉ ุงูุชูุจูู ุงูุณุฑูุน (Toast) ูุทุงุจูุฉ ููููุฏ ุงูุฃูู
      const showToast = (title, icon = "success") => {
        Swal.fire({
          icon: icon,
          title: title,
          toast: true,
          position: "top-end",
          showConfirmButton: false,
          timer: 1500,
          timerProgressBar: true,
        });
      };

      // ================= INIT DATES =================
      el("uploaddate").value = new Date().toISOString().split("T")[0];
      el("enter_maint_date").value = new Date().toISOString().split("T")[0];
      el("calib_date").value = new Date().toISOString().split("T")[0];

      // ================= FETCH DATA =================
      async function fetchData(q = "") {
        const tbody = el("tableBody");
        tbody.innerHTML =
          "<tr><td colspan='16' style='text-align:center'>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</td></tr>";

        // ูุงุฌูุฉ ุชุญููู ูุทุงุจูุฉ ููููุฏ ุงูุฃูู
        Swal.fire({
          title: "ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช...",
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });

        try {
          const snap = await get(ref(db, "Maint"));
          tbody.innerHTML = "";

          if (!snap.exists()) {
            Swal.fire({
              icon: "info",
              title: "ุชูุจูู",
              text: "ูุง ุชูุฌุฏ ุจูุงูุงุช ุญุงููุงู ูู ุงููุธุงู",
              confirmButtonText: "ุญุณูุงู",
            });
            updateRowCount();
            return;
          }

          let i = 1;
          const query = q.toLowerCase();

          snap.forEach((c) => {
            const key = c.key;
            const d = c.val().otherdata || {};
            if (q && !d.MNO?.toLowerCase().includes(query)) return;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${i++}</td>
                    <td>${d.MNO || ""}</td>
                    <td>${d.YEAR || ""}</td>
                    <td>${d.MREADING || ""}</td>
                    <td>${d.MPower || ""}</td>
                    <td>${d.Mtype || ""}</td>
                    <td>${d.Connection || ""}</td>
                    <td>${d.Keta3 || ""}</td>
                    <td>${d.Handsa || ""}</td>
                    <td>${d.Removingfor || ""}</td>
                    <td>${d.Uploaddate || ""}</td>
                    <td>${d.Mremovingfor || ""}</td>
                    <td>${d.Enter_Maint_Date || ""}</td>
                    <td>${d.Maintreport || ""}</td>
                    <td>${d.Maint_Date || ""}</td>
                    <td>${d.Notes || ""}</td>
                    <td><span class="status">ุชุนุฏูู ุงูุตูุงูุฉ</span></td>
                `;

            tr.onclick = () => fillForm(d, key, tr);
            tbody.appendChild(tr);
          });

          Swal.close();
          updateRowCount();
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "ูุดู ุงูุงุชุตุงู",
            text: "ุชุนุฐุฑ ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุณูุฑูุฑุ ูุฑุฌู ุงูุชุญูู ูู ุงูุงุชุตุงู",
          });
        }
      }

      // ================= FILL FORM =================
      function fillForm(d, key, row) {
        currentEditingKey = key;

        document
          .querySelectorAll(".selected-row")
          .forEach((r) => r.classList.remove("selected-row"));
        row.classList.add("selected-row");

        el("mno").value = d.MNO || "";
        el("year").value = d.YEAR || "";
        el("mreading").value = d.MREADING || "";
        el("mpower").value = d.MPower || "";
        el("mtype").value = d.Mtype || "";
        el("mconn").value = d.Connection || "";
        el("keta3").value = d.Keta3 || "";
        el("handsa").value = d.Handsa || "";
        el("removingfor").value = d.Removingfor || "";
        el("mremovingfor").value = d.Mremovingfor || "";
        el("uploaddate").value = d.Uploaddate || "";
        el("enter_maint_date").value = d.Enter_Maint_Date || "";
        el("maintreport").value = d.Maintreport || "";
        el("notes").value = d.Notes || "";

        showToast(`ุชู ุงุฎุชูุงุฑ ุงูุนุฏุงุฏ: ${d.MNO}`, "info");
      }

      // ================= EDIT =================
      async function editData() {
        if (!currentEditingKey) {
          return Swal.fire({
            icon: "warning",
            title: "ุชูุจูู",
            text: "ูุฑุฌู ุงุฎุชูุงุฑ ุนุฏุงุฏ ูู ุงูุฌุฏูู ุฃููุงู ูุชุนุฏููู",
          });
        }

        const result = await Swal.fire({
          title: "ุชุญุฏูุซ ุงูุจูุงูุงุช",
          text: "ูู ุฃูุช ูุชุฃูุฏ ูู ุชุนุฏูู ุจูุงูุงุช ุงูุนุฏุงุฏ ูู ุงูุตูุงูุฉ ูุงูุฃุฑุดููุ",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#27ae60",
          cancelButtonColor: "#d33",
          confirmButtonText: "ูุนู",
          cancelButtonText: "ุฅูุบุงุก",
        });

        if (result.isConfirmed) {
          Swal.fire({
            title: "ุฌุงุฑู ุงูุชุญุฏูุซ...",
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading(),
          });

          const data = {
            MNO: el("mno").value,
            YEAR: el("year").value,
            MREADING: el("mreading").value,
            MPower: el("mpower").value,
            Mtype: el("mtype").value,
            Connection: el("mconn").value,
            Keta3: el("keta3").value,
            Handsa: el("handsa").value,
            Removingfor: el("removingfor").value,
            Mremovingfor: el("mremovingfor").value,
            Uploaddate: el("uploaddate").value,
            Enter_Maint_Date: el("enter_maint_date").value,
            Maint_Date: el("calib_date").value,
            Maintreport: el("maintreport").value,
            Notes: el("notes").value,
          };

          try {
            await update(ref(db, `Maint/${currentEditingKey}/otherdata`), data);
            await update(
              ref(db, `Archive_Maint/${currentEditingKey}/otherdata`),
              data,
            );

            Swal.fire({
              icon: "success",
              title: "ุชู ุจูุฌุงุญ",
              text: "ุชู ุชุนุฏูู ุจูุงูุงุช ุงูุนุฏุงุฏ ุจูุฌุงุญ",
              timer: 1500,
              showConfirmButton: false,
            });

            fetchData();
            clearForm();
          } catch (err) {
            Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญุฏูุซ: " + err.message, "error");
          }
        }
      }

      // ================= DELETE =================
      async function deleteData() {
        if (!currentEditingKey) {
          return Swal.fire({
            icon: "warning",
            title: "ุชูุจูู",
            text: "ูุฑุฌู ุงุฎุชูุงุฑ ุนุฏุงุฏ ููุญุฐู ุฃููุงู",
          });
        }

        const result = await Swal.fire({
          title: "ุญุฐู ุงูุจูุงูุงุชุ",
          text: "ูู ุชุชููู ูู ุงูุชุฑุงุฌุน ุนู ูุฐู ุงูุฎุทูุฉ ูู ุฌุฏูู ุงูุตูุงูุฉ!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "ูุนู",
          cancelButtonText: "ุฅูุบุงุก",
        });

        if (result.isConfirmed) {
          try {
            await remove(ref(db, "Maint/" + currentEditingKey));
            showToast("ุชู ุงูุญุฐู ุจูุฌุงุญ");
            clearForm();
            fetchData();
          } catch (err) {
            Swal.fire("ุฎุทุฃ", "ูุดู ุงูุญุฐู: " + err.message, "error");
          }
        }
      }

      // ================= CLEAR =================
      function clearForm() {
        currentEditingKey = null;
        document
          .querySelectorAll(
            ".left-side input, .left-side select, .left-side textarea",
          )
          .forEach((e) => (e.value = ""));

        el("uploaddate").value = new Date().toISOString().split("T")[0];
        showToast("ุชู ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ");
      }

      // ================= UPDATE ROW COUNT =================
      function updateRowCount() {
        const rows = document.querySelectorAll(
          "#tableBody tr:not([style*='display: none'])",
        );
        el("rowCountValue").textContent = rows.length;
      }

      // ================= SEARCH =================
      el("searchInput").addEventListener("input", (e) => {
        const val = e.target.value.toLowerCase();
        let visibleCount = 0;
        [...document.querySelectorAll("#tableBody tr")].forEach((r) => {
          const isVisible = r.innerText.toLowerCase().includes(val);
          r.style.display = isVisible ? "" : "none";
          if (isVisible) visibleCount++;
        });
        el("rowCountValue").textContent = visibleCount;
      });

      // ================= SCROLL =================
      el("scrollUp").onclick = () =>
        window.scrollTo({ top: 0, behavior: "smooth" });
      el("scrollDown").onclick = () =>
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        });

      // ================= EXPORT EXCEL =================
      function exportToExcel() {
        const rows = document.querySelectorAll(
          "#tableBody tr:not([style*='display: none'])",
        );
        if (
          rows.length === 0 ||
          rows[0].innerText.includes("ุฌุงุฑู ุชุญููู") ||
          rows[0].innerText.includes("ูุง ุชูุฌุฏ")
        ) {
          return Swal.fire({
            icon: "warning",
            title: "ูุง ุชูุฌุฏ ุจูุงูุงุช",
            text: "ูุง ูููู ุชุตุฏูุฑ ุฌุฏูู ูุงุฑุบ",
          });
        }

        Swal.fire({
          title: "ุชุตุฏูุฑ ุงูุจูุงูุงุช",
          text: "ูู ุชุฑูุฏ ุชุตุฏูุฑ ุงูุฌุฏูู ุงูุญุงูู ุฅูู ููู Excelุ",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#27ae60",
          confirmButtonText: "ูุนู",
          cancelButtonText: "ุฅูุบุงุก",
        }).then((result) => {
          if (result.isConfirmed) {
            try {
              const table = el("dataTable");
              const ws = XLSX.utils.table_to_sheet(table);
              const wb = XLSX.utils.book_new();
              XLSX.utils.book_append_sheet(wb, ws, "ุจูุงูุงุช ุงูุตูุงูุฉ");

              const filename = `ุจูุงูุงุช_ุงูุตูุงูุฉ_${new Date().toISOString().split("T")[0]}.xlsx`;
              XLSX.writeFile(wb, filename);

              Swal.fire({
                icon: "success",
                title: "ุชู ุงูุชุตุฏูุฑ!",
                text: "ุชู ุญูุธ ููู Excel ุจูุฌุงุญ",
                timer: 1500,
                showConfirmButton: false,
              });
            } catch (err) {
              Swal.fire(
                "ุฎุทุฃ",
                "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุตุฏูุฑ: " + err.message,
                "error",
              );
            }
          }
        });
      }

      // ================= EVENT LISTENERS =================
      el("editBtn").onclick = editData;
      el("clearBtn").onclick = clearForm;
      el("deleteBtn").onclick = deleteData;
      el("exportBtn").onclick = exportToExcel;

      // ================= INITIAL FETCH =================
      fetchData();

      /* ================= SCROLL FUNCTIONS ================= */
      function scrollUp() {
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
      }

      function scrollDown() {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        });
      }

      // ุฑุจุท ุงูุฃุฒุฑุงุฑ ุจุงูุฏูุงู
      document.querySelectorAll("#scrollUp").forEach((btn) => {
        btn.addEventListener("click", scrollUp);
      });

      document.querySelectorAll("#scrollDown").forEach((btn) => {
        btn.addEventListener("click", scrollDown);
      });

      // Dropdown Menu Functionality
      const btn = document.getElementById("dropdownBtn");
      const menu = document.getElementById("dropdownMenu");

      btn.addEventListener("click", () => {
        menu.style.display = menu.style.display === "block" ? "none" : "block";
      });

      document.querySelectorAll(".dropdown-item").forEach((item) => {
        item.addEventListener("click", () => {
          const page = item.dataset.page;
          window.location.href = page;
        });
      });

      // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงููุงุฆูุฉ
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".modern-dropdown")) {
          menu.style.display = "none";
        }
      });
    </script>
  </body>
</html>

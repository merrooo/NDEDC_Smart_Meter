<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุธุงู ุฅุฏุงุฑุฉ ุชุณุฌูู - ุงูุชูุงุนุจุงุช</title>

  <link rel="stylesheet" href="Ayat.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>

  <label class="dark-toggle" onclick="document.body.classList.toggle('dark-mode')">
    <span class="icon">๐</span>
    <div class="switch"></div>
    <span class="icon">โ๏ธ</span>
  </label>

  <div class="entry-card">
    <h2>โก ุชุณุฌูู ุจูุงูุงุช ุนุฏุงุฏ - ุงูุชูุงุนุจุงุช</h2>

    <button class="btn-excel" id="uploadBtn" onclick="window.promptPassword()">
      ๐ฅ ุฑูุน Excel
    </button>
    <input type="file" id="excelFile" accept=".xls,.xlsx" hidden />

    <div class="inputs-grid">
      <select id="keta3" aria-label="ุงููุทุงุน">
        <option value="">ุงููุทุงุน</option>
        <option>ุฏููุงุท</option>
        <option>ุดูุงู ุงูุฏููููุฉ</option>
        <option>ุฌููุจ ุงูุฏููููุฉ</option>
        <option>ููุฑ ุงูุดูุฎ</option>
      </select>

      <select id="handsa" aria-label="ุงูููุฏุณุฉ">
        <option value="">ุงูููุฏุณุฉ</option>
        <option>ููุฏุณุฉ ุดูุงู ุฏููุงุท</option>
        <option>ููุฏุณุฉ ุฌููุจ ุฏููุงุท</option>
        <option>ููุฏุณุฉ ุนุฒุจุฉ ุงูุจุฑุฌ</option>
        <option>ููุฏุณุฉ ููุฑ ุณุนุฏ</option>
        <option>ููุฏุณุฉ ููุฑ ุงูุจุทูุฎ</option>
        <option>ููุฏุณุฉ ุฑุงุณ ุงูุจุฑ</option>
        <option>ููุฏุณุฉ ุฏููุงุท ุงูุฌุฏูุฏุฉ</option>
        <option>ููุฏุณุฉ ุงูุฒุฑูุง</option>
        <option>ููุฏุณุฉ ูุงุฑุณููุฑ</option>
        <option>ููุฏุณุฉ ุงูุฑูุถุฉ</option>
        <option>ููุฏุณุฉ ุงูุดุนุฑุงุก</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ุดุฑุจูู</option>
        <option>ููุฏุณุฉ ูุฑู ุดุฑุจูู</option>
        <option>ููุฏุณุฉ ุฏูุฑูุณ</option>
        <option>ููุฏุณุฉ ุฌูุตุฉ</option>
        <option>ููุฏุณุฉ ูุฑู ุจููุงุณ</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ุจููุงุณ</option>
        <option>ููุฏุณุฉ ุงูุณุชุงูููู</option>
        <option>ููุฏุณุฉ ุจูู ุนุจูุฏ</option>
        <option>ููุฏุณุฉ ูููุฉ ุงููุตุฑ</option>
        <option>ููุฏุณุฉ ููุช ุณูุณูู</option>
        <option>ููุฏุณุฉ ุงูุฌูุงููุฉ</option>
        <option>ููุฏุณุฉ ูุฑู ุงูููุฒูุฉ</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ุงูููุฒูุฉ</option>
        <option>ููุฏุณุฉ ุงููุทุฑูุฉ</option>
        <option>ููุฏุณุฉ ุดุฑู ุงูููุตูุฑุฉ</option>
        <option>ููุฏุณุฉ ุบุฑุจ ุงูููุตูุฑุฉ</option>
        <option>ููุฏุณุฉ ุทูุฎุง</option>
        <option>ููุฏุณุฉ ูุจุฑูู</option>
        <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 1</option>
        <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 2</option>
        <option>ููุฏุณุฉ ุงุฌุง</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ุงูุณูุจูุงููู</option>
        <option>ููุฏุณุฉ ูุฑู ุงูุณูุจูุงููู</option>
        <option>ููุฏุณุฉ ุชูู ุงูุงูุฏูุฏ</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ููุช ุบูุฑ</option>
        <option>ููุฏุณุฉ ูุฑู ููุช ุบูุฑ</option>
        <option>ููุฏุณุฉ ููู ุงูููุฑ</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ููุฑ ุงูุดูุฎ</option>
        <option>ููุฏุณุฉ ุบุฑุจ ููุฑ ุงูุดูุฎ</option>
        <option>ููุฏุณุฉ ุดุฑู ููุฑ ุงูุดูุฎ</option>
        <option>ููุฏุณุฉ ูููู</option>
        <option>ููุฏุณุฉ ูุฑู ุณูุฏู ุณุงูู</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ุณูุฏู ุณุงูู</option>
        <option>ููุฏุณุฉ ุงูุฑูุงุถ</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ุฏุณูู</option>
        <option>ููุฏุณุฉ ูุฑู ุดูุงู ุฏุณูู</option>
        <option>ููุฏุณุฉ ูุฑู ุฌููุจ ุฏุณูู</option>
        <option>ููุฏุณุฉ ููู</option>
        <option>ููุฏุณุฉ ูุทูุจุณ</option>
        <option>ููุฏุณุฉ ูุฏููุฉ ุงูุญุงููู</option>
        <option>ููุฏุณุฉ ูุฑู ุงูุญุงููู</option>
        <option>ููุฏุณุฉ ุจููุง</option>
        <option>ููุฏุณุฉ ุจูุทูู</option>
        <option>ููุฏุณุฉ ุจุฑุฌ ุงูุจุฑูุณ</option>
      </select>

      <select id="nashattype" onchange="window.checkNewOption(this)" aria-label="ููุน ุงููุดุงุท">
        <option value="">ููุน ุงููุดุงุท</option>
        <option>ููุฒูู</option>
        <option>ุชุฌุงุฑู</option>
        <option>ููู ูุญุฑูุฉ</option>
        <option>ููุฏู ูุฎุงูู</option>
        <option>ุฑู</option>
        <option>ูุฒุงุฑุน</option>
        <option>ูุณุงุฌุฏ</option>
        <option>ุงุณุชุซูุงุฑ ุตูุงุนุฉ</option>
        <option>ูุจุงุฑ</option>
        <option>ูุตุงูุญ ุญููููุฉ</option>
        <option>ูุตุงูุญ ุญููููู ุงุฎุฑู</option>
        <option value="ADD_NEW" class="add-new-option">
          โ ุฅุถุงูุฉ ููุน ุฌุฏูุฏ...
        </option>
      </select>

      <select id="mtype" onchange="window.checkNewOption(this)" aria-label="ููุน ุงูุนุฏุงุฏ">
        <option value="">ุงุฎุชุฑ ููุน ุงูุนุฏุงุฏ</option>
        <option>ุงุณูุฑุง ุงุญุงุฏู</option>
        <option>ุงููุตุฑูู ุงุญุงุฏู</option>
        <option>ุฌููุจุงู ุซูุงุซู ูุจุงุดุฑ</option>
        <option>ุฌููุจุงู ุงุญุงุฏู</option>
        <option>ุฌููุจุงู ุซูุงุซู ุบูุฑ ูุจุงุดุฑ</option>
        <option value="ADD_NEW" class="add-new-option">
          โ ุฅุถุงูุฉ ููุน ุฌุฏูุฏ...
        </option>
      </select>

      <input id="mno" placeholder="ุฑูู ุงูุนุฏุงุฏ" />
      <input type="date" class="calib_date" id="calib_date" />
      <input id="mname" placeholder="ุงุณู ุงููุดุชุฑู" />
      <input id="mco" placeholder="ููุฏ ุงููุดุชุฑู" />

      <div class="full-width-container">
        <textarea id="munip" placeholder="ูุชูุฌุฉ ุงููุญุต"></textarea>
      </div>
    </div>

    <br />
    <button class="btn-save" id="saveBtn" onclick="window.quickSave()">
      ๐พ ุญูุธ
    </button>
    <button class="btn-view" id="viewBtn" onclick="window.showData()">
      ๐ ุนุฑุถ
    </button>
  </div>

  <template id="tableTemplate">
    <div dir="rtl" class="data-modal-container">
      <div class="table-controls">
        <div class="controls-left">
          <span>ุฅุฌูุงูู ุงูุณุฌูุงุช: <b id="rowCount">0</b></span>
          <span id="duplicateCount" style="color: #dc3545; margin-right: 20px; display: none;">
            ๐ด <b id="duplicateNum">0</b> ุฃุฑูุงู ููุฑุฑุฉ
          </span>
        </div>
        <div class="controls-right">
          <button class="btn-excel" onclick="window.exportExcel()">
            ๐ ุชุตุฏูุฑ Excel
          </button>
          <button class="btn-refresh" onclick="window.loadDataForModal()">
            ๐ ุชุญุฏูุซ
          </button>
          <button class="btn-clear-filters" onclick="window.clearFilters()">
            โ ูุณุญ ุงูููุงุชุฑ
          </button>
        </div>
      </div>

      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>ู</th>
              <th>ุงููุทุงุน</th>
              <th>ุงูููุฏุณุฉ</th>
              <th>ุชุงุฑูุฎ ุงููุญุต</th>
              <th>ุงุณู ุงููุดุชุฑู</th>
              <th>ููุฏ ุงููุดุชุฑู</th>
              <th>ุงููุดุงุท</th>
              <th>ููุน ุงูุนุฏุงุฏ</th>
              <th>ุฑูู ุงูุนุฏุงุฏ</th>
              <th>ูุชูุฌุฉ ุงููุญุต</th>
              <th>ุฅุฌุฑุงุก</th>
            </tr>
            <!-- ุตู ุงูููุงุชุฑ -->
            <tr class="filter-row">
              <th>-</th>
              <th>
                <select id="f0" class="filter-select" onchange="window.filterTable()" aria-label="ููุชุฑ ุงููุทุงุน">
                  <option value="">ุงููู</option>
                  <option>ุฏููุงุท</option>
                  <option>ุดูุงู ุงูุฏููููุฉ</option>
                  <option>ุฌููุจ ุงูุฏููููุฉ</option>
                  <option>ููุฑ ุงูุดูุฎ</option>
                </select>
              </th>
              <th>
                <select id="f1" class="filter-select" onchange="window.filterTable()" aria-label="ููุชุฑ ุงูููุฏุณุฉ">
                  <option value="">ุงููู</option>
                  <option>ููุฏุณุฉ ุดูุงู ุฏููุงุท</option>
                  <option>ููุฏุณุฉ ุฌููุจ ุฏููุงุท</option>
                  <option>ููุฏุณุฉ ุนุฒุจุฉ ุงูุจุฑุฌ</option>
                  <option>ููุฏุณุฉ ููุฑ ุณุนุฏ</option>
                  <option>ููุฏุณุฉ ููุฑ ุงูุจุทูุฎ</option>
                  <option>ููุฏุณุฉ ุฑุงุณ ุงูุจุฑ</option>
                  <option>ููุฏุณุฉ ุฏููุงุท ุงูุฌุฏูุฏุฉ</option>
                  <option>ููุฏุณุฉ ุงูุฒุฑูุง</option>
                  <option>ููุฏุณุฉ ูุงุฑุณููุฑ</option>
                  <option>ููุฏุณุฉ ุงูุฑูุถุฉ</option>
                  <option>ููุฏุณุฉ ุงูุดุนุฑุงุก</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ุดุฑุจูู</option>
                  <option>ููุฏุณุฉ ูุฑู ุดุฑุจูู</option>
                  <option>ููุฏุณุฉ ุฏูุฑูุณ</option>
                  <option>ููุฏุณุฉ ุฌูุตุฉ</option>
                  <option>ููุฏุณุฉ ูุฑู ุจููุงุณ</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ุจููุงุณ</option>
                  <option>ููุฏุณุฉ ุงูุณุชุงูููู</option>
                  <option>ููุฏุณุฉ ุจูู ุนุจูุฏ</option>
                  <option>ููุฏุณุฉ ูููุฉ ุงููุตุฑ</option>
                  <option>ููุฏุณุฉ ููุช ุณูุณูู</option>
                  <option>ููุฏุณุฉ ุงูุฌูุงููุฉ</option>
                  <option>ููุฏุณุฉ ูุฑู ุงูููุฒูุฉ</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ุงูููุฒูุฉ</option>
                  <option>ููุฏุณุฉ ุงููุทุฑูุฉ</option>
                  <option>ููุฏุณุฉ ุดุฑู ุงูููุตูุฑุฉ</option>
                  <option>ููุฏุณุฉ ุบุฑุจ ุงูููุตูุฑุฉ</option>
                  <option>ููุฏุณุฉ ุทูุฎุง</option>
                  <option>ููุฏุณุฉ ูุจุฑูู</option>
                  <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 1</option>
                  <option>ููุฏุณุฉ ูุฑู ุงูููุตูุฑุฉ 2</option>
                  <option>ููุฏุณุฉ ุงุฌุง</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ุงูุณูุจูุงููู</option>
                  <option>ููุฏุณุฉ ูุฑู ุงูุณูุจูุงููู</option>
                  <option>ููุฏุณุฉ ุชูู ุงูุงูุฏูุฏ</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ููุช ุบูุฑ</option>
                  <option>ููุฏุณุฉ ูุฑู ููุช ุบูุฑ</option>
                  <option>ููุฏุณุฉ ููู ุงูููุฑ</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ููุฑ ุงูุดูุฎ</option>
                  <option>ููุฏุณุฉ ุบุฑุจ ููุฑ ุงูุดูุฎ</option>
                  <option>ููุฏุณุฉ ุดุฑู ููุฑ ุงูุดูุฎ</option>
                  <option>ููุฏุณุฉ ูููู</option>
                  <option>ููุฏุณุฉ ูุฑู ุณูุฏู ุณุงูู</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ุณูุฏู ุณุงูู</option>
                  <option>ููุฏุณุฉ ุงูุฑูุงุถ</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ุฏุณูู</option>
                  <option>ููุฏุณุฉ ูุฑู ุดูุงู ุฏุณูู</option>
                  <option>ููุฏุณุฉ ูุฑู ุฌููุจ ุฏุณูู</option>
                  <option>ููุฏุณุฉ ููู</option>
                  <option>ููุฏุณุฉ ูุทูุจุณ</option>
                  <option>ููุฏุณุฉ ูุฏููุฉ ุงูุญุงููู</option>
                  <option>ููุฏุณุฉ ูุฑู ุงูุญุงููู</option>
                  <option>ููุฏุณุฉ ุจููุง</option>
                  <option>ููุฏุณุฉ ุจูุทูู</option>
                  <option>ููุฏุณุฉ ุจุฑุฌ ุงูุจุฑูุณ</option>
                </select>
              </th>
              <th class="filter-date-col">
                <div class="date-filter-container">
                  <input type="date" id="f2" class="filter-input" onchange="window.filterTable()" title="ุงูุชุงุฑูุฎ ูู" />
                  <input type="date" id="f3" class="filter-input" onchange="window.filterTable()" title="ุงูุชุงุฑูุฎ ุฅูู" />
                </div>
              </th>
              <th>
                <input type="text" id="f4" class="filter-input" placeholder="๐" onkeyup="window.filterTable()" />
              </th>
              <th>
                <input type="text" id="f5" class="filter-input" placeholder="๐" onkeyup="window.filterTable()" />
              </th>
              <th>
                <select id="f6" class="filter-select" onchange="window.filterTable()" aria-label="ููุชุฑ ุงููุดุงุท">
                  <option value="">ุงููู</option>
                  <option>ููุฒูู</option>
                  <option>ุชุฌุงุฑู</option>
                  <option>ููู ูุญุฑูุฉ</option>
                  <option>ููุฏู ูุฎุงูู</option>
                  <option>ุฑู</option>
                  <option>ูุฒุงุฑุน</option>
                  <option>ูุณุงุฌุฏ</option>
                  <option>ุงุณุชุซูุงุฑ ุตูุงุนุฉ</option>
                  <option>ูุจุงุฑ</option>
                  <option>ูุตุงูุญ ุญููููุฉ</option>
                  <option>ูุตุงูุญ ุญููููู ุงุฎุฑู</option>
                </select>
              </th>
              <th>
                <select id="f7" class="filter-select" onchange="window.filterTable()" aria-label="ููุชุฑ ููุน ุงูุนุฏุงุฏ">
                  <option value="">ุงููู</option>
                  <option>ุงุณูุฑุง ุงุญุงุฏู</option>
                  <option>ุงููุตุฑูู ุงุญุงุฏู</option>
                  <option>ุฌููุจุงู ุซูุงุซู ูุจุงุดุฑ</option>
                  <option>ุฌููุจุงู ุงุญุงุฏู</option>
                  <option>ุฌููุจุงู ุซูุงุซู ุบูุฑ ูุจุงุดุฑ</option>
                </select>
              </th>
              <th>
                <input type="text" id="f8" class="filter-input" placeholder="๐" onkeyup="window.filterTable()" />
              </th>
              <th>
                <input type="text" id="f9" class="filter-input" placeholder="๐" onkeyup="window.filterTable()" />
              </th>
              <th>-</th>
            </tr>
          </thead>
          <tbody id="modalBody"></tbody>
        </table>
      </div>

      <div class="pagination-controls">
        <button id="prevBtn" class="btn-pagination" onclick="window.prevPage()" disabled>
          โฌ๏ธ ุงูุณุงุจู
        </button>
        <span id="pageInfo" class="page-info">ุงูุตูุญุฉ 1 ูู 1</span>
        <button id="nextBtn" class="btn-pagination" onclick="window.nextPage()" disabled>
          ุงูุชุงูู โก๏ธ
        </button>
      </div>
    </div>
  </template>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
      set,
    } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

    // --- 1. Firebase Initialization ---
    const app = initializeApp({
      apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
      databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com",
    });
    const db = getDatabase(app);
    let currentEditIndex = null;
    let currentEditOriginalIndex = null;

    // Pagination & data state
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    // --- 2. Helper: Clear Form & Reset UI ---
    window.resetUI = () => {
      currentEditIndex = null;
      currentEditOriginalIndex = null;
      const saveBtn = document.getElementById("saveBtn");
      saveBtn.innerHTML = "๐พ ุญูุธ";
      saveBtn.style.background = "";
      document.querySelectorAll("input, select, textarea").forEach((el) => {
        if (el.id !== "keta3" && el.id !== "handsa") {
          el.value = "";
        }
      });
    };

    // --- 3. Helper: Collect Data from Form ---
    const getFormData = () => {
      return {
        keta3: document.getElementById("keta3").value,
        handsa: document.getElementById("handsa").value,
        calibrationdate: document.getElementById("calib_date").value,
        metername: document.getElementById("mname").value.trim(),
        metercode: document.getElementById("mco").value.trim(),
        nashattype: document.getElementById("nashattype").value,
        metertype: document.getElementById("mtype").value,
        meternumber: document.getElementById("mno").value.trim(),
        metermunip: document.getElementById("munip").value.trim(),
      };
    };

    // --- 4. Main Function: Save or Update ---
    window.quickSave = async () => {
      const saveBtn = document.getElementById("saveBtn");
      const fields = getFormData();
      const isAllFilled = Object.values(fields).every((val) => val !== "");
      if (!isAllFilled) {
        return Swal.fire("ุชูุจูู", "ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ", "warning");
      }

      saveBtn.disabled = true;
      const originalBtnText = saveBtn.innerHTML;
      saveBtn.innerHTML = "โ ุฌุงุฑู ุงููุนุงูุฌุฉ...";

      try {
        const snap = await get(ref(db, "Ayat/meterdata"));
        let list = snap.exists() ? snap.val() : [];
        if (!Array.isArray(list)) {
          list = [];
        }

        // Check for duplicate meter number (excluding current edited item)
        const existingNumbers = new Set();
        list.forEach((item, index) => {
          if (item && item.meternumber && index !== currentEditOriginalIndex) {
            const cleanNum = String(item.meternumber).replace(/\D/g, '').trim();
            if (cleanNum) existingNumbers.add(cleanNum);
          }
        });

        const cleanedMeterNo = String(fields.meternumber).replace(/\D/g, '').trim();

        if (existingNumbers.has(cleanedMeterNo) && currentEditOriginalIndex === null) {
          const confirmDup = await Swal.fire({
            title: "ุชูุจูู: ุฑูู ุงูุนุฏุงุฏ ููุฑุฑ",
            text: `ุฑูู ุงูุนุฏุงุฏ (${cleanedMeterNo}) ููุฌูุฏ ุจุงููุนู ูู ุงููุธุงู. ูู ุชุฑูุฏ ุงูุงุณุชูุฑุงุฑุ`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "ูุนูุ ุญูุธ",
            cancelButtonText: "ุฅูุบุงุก",
          });
          if (!confirmDup.isConfirmed) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
            return;
          }
        }

        let dateVal = fields.calibrationdate;
        if (dateVal.includes("-") && dateVal.split("-")[0].length === 4) {
          const [y, m, d] = dateVal.split("-");
          dateVal = `${d}-${m}-${y}`;
        }

        const finalData = { ...fields, calibrationdate: dateVal };

        // Clean data before saving
        Object.keys(finalData).forEach(key => {
          if (finalData[key] === undefined || finalData[key] === null) {
            finalData[key] = "";
          }
          finalData[key] = String(finalData[key]).trim();
        });

        if (currentEditOriginalIndex !== null && currentEditOriginalIndex >= 0 && currentEditOriginalIndex < list.length) {
          // ุชุญุฏูุซ ุณุฌู ููุฌูุฏ
          list[currentEditOriginalIndex] = finalData;
        } else {
          // ุฅุถุงูุฉ ุณุฌู ุฌุฏูุฏ
          list.push(finalData);
        }

        await set(ref(db, "Ayat/meterdata"), list);
        window.resetUI();

        // Refresh modal if it's open
        try {
          const swalContainer = document.querySelector('.swal2-container');
          if (swalContainer && swalContainer.style.display !== 'none') {
            await loadDataForModal();
          }
        } catch (refreshError) {
          console.log("Could not refresh modal, might be closed");
        }

        Swal.fire("ุชู ุจูุฌุงุญ", "ุชู ุญูุธ ูุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงููุงุนุฏุฉ", "success");
      } catch (error) {
        console.error("Error in quickSave:", error);
        Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช", "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = "๐พ ุญูุธ";
      }
    };

    // --- 5. Action: Edit Row ---
    window.editRow = async (filteredIndex) => {
      try {
        if (filteredIndex < 0 || filteredIndex >= filteredData.length) {
          Swal.fire("ุฎุทุฃ", "ุงูุณุฌู ุบูุฑ ููุฌูุฏ", "error");
          return;
        }

        const item = filteredData[filteredIndex];

        const originalIndex = item.__originalIndex !== undefined ? item.__originalIndex : filteredIndex;

        const snap = await get(ref(db, "Ayat/meterdata"));
        if (!snap.exists()) {
          Swal.fire("ุฎุทุฃ", "ูุง ุชูุฌุฏ ุจูุงูุงุช", "error");
          return;
        }

        const allDataFromDB = snap.val();
        const list = Array.isArray(allDataFromDB) ? allDataFromDB : Object.values(allDataFromDB);

        if (originalIndex < 0 || originalIndex >= list.length) {
          Swal.fire("ุฎุทุฃ", "ุงูุณุฌู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช", "error");
          return;
        }

        const d = list[originalIndex];

        let formattedForInput = "";
        if (d.calibrationdate && d.calibrationdate.includes("-")) {
          const parts = d.calibrationdate.split("-");
          if (parts.length === 3) {
            if (parts[0].length === 2) {
              formattedForInput = `${parts[2]}-${parts[1]}-${parts[0]}`;
            } else {
              formattedForInput = d.calibrationdate;
            }
          } else {
            formattedForInput = d.calibrationdate;
          }
        }

        document.getElementById("keta3").value = d.keta3 || "";
        document.getElementById("handsa").value = d.handsa || "";
        document.getElementById("calib_date").value = formattedForInput;
        document.getElementById("mname").value = d.metername || "";
        document.getElementById("mno").value = d.meternumber || "";
        document.getElementById("mco").value = d.metercode || "";
        document.getElementById("nashattype").value = d.nashattype || "";
        document.getElementById("mtype").value = d.metertype || "";
        document.getElementById("munip").value = d.metermunip || "";

        currentEditOriginalIndex = originalIndex;
        currentEditIndex = filteredIndex;

        const saveBtn = document.getElementById("saveBtn");
        saveBtn.innerHTML = "๐ ุชุญุฏูุซ ุงูุจูุงูุงุช";
        saveBtn.style.background = "linear-gradient(135deg, #f39c12, #e67e22)";

        try {
          const swalContainer = document.querySelector('.swal2-container');
          if (swalContainer && swalContainer.style.display !== 'none') {
            Swal.close();
          }
        } catch (closeError) {
          console.log("Could not close modal, might already be closed");
        }

        window.scrollTo({ top: 0, behavior: "smooth" });

        Swal.fire({
          title: "ุฌุงูุฒ ููุชุนุฏูู",
          text: "ุชู ุชุญููู ุจูุงูุงุช ุงูุณุฌู ูููููุฐุฌ. ูู ุจุฅุฌุฑุงุก ุงูุชุนุฏููุงุช ุงููุทููุจุฉ ุซู ุงุถุบุท ุนูู ุฒุฑ 'ุชุญุฏูุซ ุงูุจูุงูุงุช'",
          icon: "info",
          confirmButtonText: "ุญุณูุงู",
          timer: 3000,
          timerProgressBar: true
        });

      } catch (error) {
        console.error("Error in editRow:", error);
        Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช ููุชุนุฏูู", "error");
      }
    };

    // --- 6. Action: Delete Row ---
    window.deleteRow = async (filteredIndex) => {
      try {
        if (filteredIndex < 0 || filteredIndex >= filteredData.length) {
          Swal.fire("ุฎุทุฃ", "ุงูุณุฌู ุบูุฑ ููุฌูุฏ", "error");
          return;
        }

        const item = filteredData[filteredIndex];
        const originalIndex = item.__originalIndex !== undefined ? item.__originalIndex : filteredIndex;

        const confirmDel = await Swal.fire({
          title: "ุญุฐู ุงูุณุฌูุ",
          html: `ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุญุฐู ูุฐุง ุงูุณุฌูุ<br><br>
                 <strong>ุฑูู ุงูุนุฏุงุฏ:</strong> ${item.meternumber || 'ุบูุฑ ูุนุฑูู'}<br>
                 <strong>ุงุณู ุงููุดุชุฑู:</strong> ${item.metername || 'ุบูุฑ ูุนุฑูู'}`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "ูุนูุ ุงุญุฐู",
          cancelButtonText: "ุฅูุบุงุก"
        });

        if (confirmDel.isConfirmed) {
          const snap = await get(ref(db, "Ayat/meterdata"));
          let list = snap.val();
          if (!Array.isArray(list)) {
            list = Object.values(list);
          }

          if (originalIndex < 0 || originalIndex >= list.length) {
            Swal.fire("ุฎุทุฃ", "ุงูุณุฌู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช", "error");
            return;
          }

          const deletedItem = list[originalIndex];
          list.splice(originalIndex, 1);
          await set(ref(db, "Ayat/meterdata"), list);

          if (currentEditOriginalIndex === originalIndex) {
            window.resetUI();
          }

          await loadDataForModal();

          Swal.fire("ุชู ุงูุญุฐู", `ุชู ุญุฐู ุนุฏุงุฏ ุฑูู ${deletedItem.meternumber || 'ุบูุฑ ูุนุฑูู'}`, "success");
        }
      } catch (error) {
        console.error("Error in deleteRow:", error);
        Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู", "error");
      }
    };

    // --- 7. Show Data Modal ---
    window.showData = async () => {
      Swal.fire({
        title: "๐ ุณุฌู ุงูุจูุงูุงุช",
        html: document.getElementById("tableTemplate").innerHTML,
        width: "98%",
        heightAuto: false,
        showConfirmButton: false,
        showCloseButton: true,
        allowOutsideClick: false,
        didOpen: () => {
          loadDataForModal();
        }
      });
    };

    // --- 8. Load data for modal ---
    async function loadDataForModal() {
      try {
        const snap = await get(ref(db, "Ayat/meterdata"));

        if (!snap.exists()) {
          allData = [];
          filteredData = [];
          updateTableUI([]);
          return;
        }

        const data = snap.val();
        allData = Array.isArray(data) ? data : Object.values(data);

        filteredData = allData.map((d, i) => ({
          ...d,
          __idx: i,
          __originalIndex: i
        }));

        filteredData.sort((a, b) => {
          const dateA = parseDateForSort(a.calibrationdate);
          const dateB = parseDateForSort(b.calibrationdate);
          return dateB - dateA;
        });

        currentPage = 1;
        renderPage();
      } catch (error) {
        console.error("Error loading data:", error);
        Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช", "error");
      }
    }

    function parseDateForSort(dateStr) {
      if (!dateStr) return new Date(0);
      const parts = dateStr.split("-");
      if (parts.length === 3) {
        if (parts[0].length === 2) {
          return new Date(parts[2], parts[1] - 1, parts[0]);
        } else {
          return new Date(parts[0], parts[1] - 1, parts[2]);
        }
      }
      return new Date(dateStr);
    }

    function renderPage() {
      const body = document.getElementById("modalBody");
      if (!body) return;

      body.innerHTML = "";

      if (filteredData.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="11" style="text-align: center; padding: 40px;">
              <div style="color: #6c757d; font-size: 16px;">
                ๐ญ ูุง ุชูุฌุฏ ุจูุงูุงุช
              </div>
            </td>
          </tr>`;
        updateTableUI([]);
        return;
      }

      const start = (currentPage - 1) * itemsPerPage;
      const pageItems = filteredData.slice(start, start + itemsPerPage);

      const meterNumberCounts = {};
      filteredData.forEach(item => {
        if (item.meternumber) {
          const cleanNum = String(item.meternumber).trim();
          if (cleanNum) {
            meterNumberCounts[cleanNum] = (meterNumberCounts[cleanNum] || 0) + 1;
          }
        }
      });

      body.innerHTML = pageItems.map((d, idx) => {
        const isDuplicate = meterNumberCounts[String(d.meternumber || '').trim()] > 1;
        const rowClass = isDuplicate ? 'duplicate-row' : '';
        const filteredIndex = start + idx;

        return `
          <tr class="${rowClass}" data-idx="${filteredIndex}">
            <td class="row-index">${start + idx + 1}</td>
            <td>${d.keta3 || ""}</td>
            <td>${d.handsa || ""}</td>
            <td>${d.calibrationdate || ""}</td>
            <td>${d.metername || ""}</td>
            <td>${d.metercode || ""}</td>
            <td>${d.nashattype || ""}</td>
            <td>${d.metertype || ""}</td>
            <td><strong>${d.meternumber || ""}</strong>${isDuplicate ? ' ๐ด' : ''}</td>
            <td>${d.metermunip || ""}</td>
            <td class="action-buttons">
              <button class="btn-edit" onclick="window.editRow(${filteredIndex})" title="ุชุนุฏูู">โ๏ธ</button>
              <button class="btn-del" onclick="window.deleteRow(${filteredIndex})" title="ุญุฐู">๐</button>
            </td>
          </tr>`;
      }).join("");

      updateTableUI(pageItems);
    }

    function updateTableUI(pageItems) {
      document.getElementById("rowCount").innerText = filteredData.length;

      const duplicateCount = countDuplicates();
      const duplicateSpan = document.getElementById("duplicateCount");
      const duplicateNum = document.getElementById("duplicateNum");

      if (duplicateCount > 0) {
        duplicateSpan.style.display = "inline";
        duplicateNum.innerText = duplicateCount;
      } else {
        duplicateSpan.style.display = "none";
      }

      updatePaginationControls();
    }

    function countDuplicates() {
      const meterNumbers = filteredData
        .map(item => String(item.meternumber || '').trim())
        .filter(num => num);

      const counts = {};
      meterNumbers.forEach(num => {
        counts[num] = (counts[num] || 0) + 1;
      });

      return Object.values(counts).filter(count => count > 1).length;
    }

    function updatePaginationControls() {
      const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
      const pageInfo = document.getElementById("pageInfo");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      if (pageInfo) pageInfo.textContent = `ุงูุตูุญุฉ ${currentPage} ูู ${totalPages}`;
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    window.nextPage = () => {
      const totalPages = Math.max(1, Math.ceil(filteredData.length / itemsPerPage));
      if (currentPage < totalPages) {
        currentPage++;
        renderPage();
      }
    };

    window.prevPage = () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    };

    // --- 9. Filter Function ---
    window.filterTable = () => {
      const filters = {
        keta3: document.getElementById("f0").value,
        handsa: document.getElementById("f1").value,
        dateFrom: document.getElementById("f2").value,
        dateTo: document.getElementById("f3").value,
        name: document.getElementById("f4").value.toLowerCase(),
        code: document.getElementById("f5").value.toLowerCase(),
        nashat: document.getElementById("f6").value,
        mType: document.getElementById("f7").value,
        mNo: document.getElementById("f8").value.toLowerCase(),
        munip: document.getElementById("f9").value.toLowerCase(),
      };

      filteredData = allData.map((d, i) => ({
        ...d,
        __idx: i,
        __originalIndex: i
      })).filter((d) => {
        let dateMatch = true;
        if (filters.dateFrom || filters.dateTo) {
          const rowDate = parseDateForSort(d.calibrationdate || "");

          if (filters.dateFrom) {
            const fromDate = new Date(filters.dateFrom);
            if (rowDate < fromDate) dateMatch = false;
          }

          if (filters.dateTo && dateMatch) {
            const toDate = new Date(filters.dateTo);
            toDate.setHours(23, 59, 59, 999);
            if (rowDate > toDate) dateMatch = false;
          }
        }

        return (
          (filters.keta3 === "" || d.keta3 === filters.keta3) &&
          (filters.handsa === "" || d.handsa === filters.handsa) &&
          dateMatch &&
          (d.metername || "").toLowerCase().includes(filters.name) &&
          (d.metercode || "").toLowerCase().includes(filters.code) &&
          (filters.nashat === "" || d.nashattype === filters.nashat) &&
          (filters.mType === "" || d.metertype === filters.mType) &&
          (d.meternumber || "").toLowerCase().includes(filters.mNo) &&
          (d.metermunip || "").toLowerCase().includes(filters.munip)
        );
      });

      currentPage = 1;
      renderPage();
    };

    // Clear filters
    window.clearFilters = () => {
      ['f0', 'f1', 'f2', 'f3', 'f4', 'f5', 'f6', 'f7', 'f8', 'f9'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      window.filterTable();
    };

    // --- 10. Excel Exports & Import ---
    window.exportExcel = () => {
      if (!filteredData || filteredData.length === 0) {
        return Swal.fire("ุชูุจูู", "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุตุฏูุฑูุง", "warning");
      }

      const exportData = [
        ["ู", "ุงููุทุงุน", "ุงูููุฏุณุฉ", "ุชุงุฑูุฎ ุงููุญุต", "ุงุณู ุงููุดุชุฑู", "ููุฏ ุงููุดุชุฑู", "ุงููุดุงุท", "ููุน ุงูุนุฏุงุฏ", "ุฑูู ุงูุนุฏุงุฏ", "ูุชูุฌุฉ ุงููุญุต"]
      ];

      filteredData.forEach((d, i) => {
        exportData.push([
          i + 1,
          d.keta3 || "",
          d.handsa || "",
          d.calibrationdate || "",
          d.metername || "",
          d.metercode || "",
          d.nashattype || "",
          d.metertype || "",
          d.meternumber || "",
          d.metermunip || ""
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ุจูุงูุงุช ุงูุชูุงุนุจุงุช");

      const date = new Date().toLocaleDateString('ar-EG').replace(/\//g, '-');
      XLSX.writeFile(wb, `ุณุฌู_ุงูุชูุงุนุจุงุช_${date}.xlsx`);

      Swal.fire("ุชู ุงูุชุตุฏูุฑ", `ุชู ุชุตุฏูุฑ ${filteredData.length} ุณุฌู`, "success");
    };

    window.promptPassword = () => {
      Swal.fire({
        title: "ูููุฉ ูุฑูุฑ ุงููุธุงู",
        input: "password",
        inputPlaceholder: "ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ",
        showCancelButton: true,
        confirmButtonText: "ุฏุฎูู",
        cancelButtonText: "ุฅูุบุงุก"
      }).then((r) => {
        if (r.value === "1") {
          document.getElementById("excelFile").click();
        } else if (r.value) {
          Swal.fire("ุฎุทุฃ", "ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ", "error");
        }
      });
    };

    // --- 11. Excel Upload Function - FIXED VERSION ---
    document.getElementById("excelFile").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const loadingSwal = Swal.fire({
        title: 'ุฌุงุฑู ูุนุงูุฌุฉ ุงูููู...',
        html: 'ูุฑุฌู ุงูุงูุชุธุงุฑ ุฃุซูุงุก ูุฑุงุกุฉ ุงูููู',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        const reader = new FileReader();

        reader.onload = async function (event) {
          try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
              defval: "",
              raw: false,
              dateNF: 'yyyy-mm-dd'
            });

            if (!jsonData || jsonData.length === 0) {
              await loadingSwal.close();
              Swal.fire("ุชูุจูู", "ุงูููู ูุงุฑุบ ุฃู ูุง ูุญุชูู ุนูู ุจูุงูุงุช", "warning");
              document.getElementById("excelFile").value = "";
              return;
            }

            const snap = await get(ref(db, "Ayat/meterdata"));
            let currentList = [];
            if (snap.exists()) {
              const data = snap.val();
              currentList = Array.isArray(data) ? data : Object.values(data);
            }

            const cleanMeterNumber = (val) => {
              if (val === null || val === undefined || val === "") return "";
              return String(val).replace(/\D/g, '').trim();
            };

            const getValue = (row, colNames) => {
              for (const col of colNames) {
                if (row[col] !== undefined && row[col] !== null && row[col] !== "") {
                  return String(row[col]).trim();
                }
              }
              return "";
            };

            const meterNoCols = ["ุฑูู ุงูุนุฏุงุฏ", "meternumber", "Meter No", "meter_no", "ุฑูู", "ุงูุนุฏุงุฏ", "meter"];
            const nameCols = ["ุงุณู ุงููุดุชุฑู", "metername", "Name", "ุงุณู", "ุงููุดุชุฑู"];
            const codeCols = ["ููุฏ ุงููุดุชุฑู", "metercode", "Code", "ููุฏ"];
            const sectorCols = ["ุงููุทุงุน", "keta3", "Sector", "ุงูููุทูุฉ"];
            const handsaCols = ["ุงูููุฏุณุฉ", "handsa", "Engineering", "ุงููููุฏุณูุฉ"];
            const dateCols = ["ุชุงุฑูุฎ ุงููุญุต", "calibrationdate", "Date", "ุงูุชุงุฑูุฎ", "ุชุงุฑูุฎ"];
            const typeCols = ["ููุน ุงูุนุฏุงุฏ", "metertype", "Type", "ุงูููุน"];
            const nashatCols = ["ุงููุดุงุท", "nashattype", "Activity", "ููุน ุงููุดุงุท"];
            const resultCols = ["ูุชูุฌุฉ ุงููุญุต", "metermunip", "Result", "ุงููุชูุฌุฉ", "ุงูุชูุงุนุจ"];

            const newData = [];
            const duplicates = [];
            const fileDuplicates = new Set();
            const seenInFile = new Set();

            const existingNumbers = new Set();
            currentList.forEach(item => {
              if (item && item.meternumber) {
                const cleanNum = cleanMeterNumber(item.meternumber);
                if (cleanNum) existingNumbers.add(cleanNum);
              }
            });

            for (let i = 0; i < jsonData.length; i++) {
              const row = jsonData[i];

              const rawMeterNo = getValue(row, meterNoCols);
              const cleanedMeterNo = cleanMeterNumber(rawMeterNo);

              if (!cleanedMeterNo) continue;

              if (seenInFile.has(cleanedMeterNo)) {
                fileDuplicates.add(cleanedMeterNo);
                continue;
              }
              seenInFile.add(cleanedMeterNo);

              if (existingNumbers.has(cleanedMeterNo)) {
                duplicates.push({
                  row: i + 2,
                  meterNo: cleanedMeterNo,
                  name: getValue(row, nameCols) || "ุจุฏูู ุงุณู"
                });
                continue;
              }

              const newRecord = {
                keta3: getValue(row, sectorCols) || "",
                handsa: getValue(row, handsaCols) || "",
                calibrationdate: getValue(row, dateCols) || "",
                metername: getValue(row, nameCols) || "",
                metercode: getValue(row, codeCols) || "",
                nashattype: getValue(row, nashatCols) || "",
                metertype: getValue(row, typeCols) || "",
                meternumber: cleanedMeterNo,
                metermunip: getValue(row, resultCols) || ""
              };

              Object.keys(newRecord).forEach(key => {
                if (newRecord[key] === undefined || newRecord[key] === null) {
                  newRecord[key] = "";
                }
                newRecord[key] = String(newRecord[key]).trim();
              });

              newData.push(newRecord);
              existingNumbers.add(cleanedMeterNo);
            }

            let addedCount = 0;
            if (newData.length > 0) {
              const updatedList = [...currentList, ...newData];
              await set(ref(db, "Ayat/meterdata"), updatedList);
              addedCount = newData.length;
            }

            await loadingSwal.close();

            let resultHtml = `<div dir="rtl" style="text-align: right;">`;

            if (addedCount > 0) {
              resultHtml += `
                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c3e6cb;">
                  <h5 style="color: #155724; margin: 0 0 10px 0; font-size: 18px;">โ ุชูุช ุงูุฅุถุงูุฉ ุจูุฌุงุญ</h5>
                  <p style="font-size: 20px; font-weight: bold; color: #155724; margin: 0;">ุชู ุฅุถุงูุฉ ${addedCount} ุนุฏุงุฏ ุฌุฏูุฏ</p>
                </div>`;
            } else {
              resultHtml += `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeaa7;">
                  <h5 style="color: #856404; margin: 0 0 10px 0; font-size: 18px;">โ๏ธ ูู ุชุชู ุฅุถุงูุฉ ุจูุงูุงุช ุฌุฏูุฏุฉ</h5>
                  <p style="margin: 0;">ุฌููุน ุงูุจูุงูุงุช ุฅูุง ููุฑุฑุฉ ุฃู ุบูุฑ ุตุงูุญุฉ</p>
                </div>`;
            }

            if (duplicates.length > 0 || fileDuplicates.size > 0) {
              resultHtml += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px; border: 1px solid #e9ecef;">`;

              if (duplicates.length > 0) {
                resultHtml += `<p style="color: #dc3545; margin: 0 0 10px 0; font-weight: bold;">โ ${duplicates.length} ุนุฏุงุฏ ููุฌูุฏ ูุณุจูุงู ูู ุงููุธุงู</p>`;
              }

              if (fileDuplicates.size > 0) {
                resultHtml += `<p style="color: #fd7e14; margin: 0; font-weight: bold;">๐ ${fileDuplicates.size} ุนุฏุงุฏ ููุฑุฑ ุฏุงุฎู ุงูููู</p>`;
              }

              resultHtml += `</div>`;
            }

            resultHtml += `</div>`;

            Swal.fire({
              icon: addedCount > 0 ? "success" : "info",
              title: addedCount > 0 ? "ุชูุช ุงููุนุงูุฌุฉ ุจูุฌุงุญ" : "ููุงุญุธุฉ",
              html: resultHtml,
              confirmButtonText: "ุญุณูุงู",
              width: 500,
              didClose: () => {
                try {
                  const swalContainer = document.querySelector('.swal2-container');
                  if (swalContainer && swalContainer.style.display !== 'none') {
                    loadDataForModal();
                  }
                } catch (refreshError) {
                  console.log("Could not refresh modal");
                }
              }
            });

          } catch (error) {
            await loadingSwal.close();
            console.error("Error processing data:", error);
            Swal.fire("ุฎุทุฃ", `ุญุฏุซ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุจูุงูุงุช: ${error.message}`, "error");
          }

          document.getElementById("excelFile").value = "";
        };

        reader.onerror = async function () {
          await loadingSwal.close();
          Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู", "error");
          document.getElementById("excelFile").value = "";
        };

        reader.readAsArrayBuffer(file);

      } catch (error) {
        await loadingSwal.close();
        console.error("Error uploading file:", error);
        Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ูู ุฑูุน ุงูููู", "error");
        document.getElementById("excelFile").value = "";
      }
    });

    // --- 12. Dynamic Options ---
    window.checkNewOption = async (el) => {
      if (el.value === "ADD_NEW") {
        const { value: val } = await Swal.fire({
          title: "ุฅุถุงูุฉ ููุน ุฌุฏูุฏ",
          input: "text",
          inputPlaceholder: "ุงูุชุจ ุงูููุน ุงูุฌุฏูุฏ ููุง...",
          showCancelButton: true,
          confirmButtonText: "ุฅุถุงูุฉ",
          cancelButtonText: "ุฅูุบุงุก"
        });

        if (val && val.trim()) {
          const opt = new Option(val, val);
          el.add(opt, el.options[el.options.length - 1]);
          el.value = val;
        } else {
          el.value = "";
        }
      }
    };

    // --- Dark Mode ---
    window.toggleDarkMode = (on) => {
      document.body.classList.toggle('dark-mode', !!on);
      localStorage.setItem('darkMode', on ? '1' : '0');
    };

    (function () {
      const on = localStorage.getItem('darkMode') === '1';
      const cb = document.getElementById('darkToggle');
      if (cb) cb.checked = on;
      document.body.classList.toggle('dark-mode', on);
    })();
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ุงุณุชูุงู ุนุฏุงุฏุงุช ูู ุงููุญุต</title>

    <link rel="stylesheet" href="Recived_Calib.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
</head>

<body>
    <main class="app">

        <!-- ================= RIGHT SIDE ================= -->
        <div class="right-side">

            <section class="table-top-section">
                <div class="table-header">
                    <h3>ุงุณุชูุงู ุนุฏุงุฏุงุช ูู ุงููุญุต</h3>


                    <div class="modern-dropdown">
                        <button class="dropdown-btn" id="dropdownBtn">
                            โพ ุงุฎุชุฑ ุงูุตูุญุฉ ููุงูุชูุงู
                        </button>

                        <div class="dropdown-menu" id="dropdownMenu">
                            <div class="dropdown-group" data-icon="๐">ุงููุญุต</div>
                            <div class="dropdown-item" data-page="Entr_Calib.html">ุฏุฎูู ูุญุต ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Calib.html">ูุญุต ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Edite_Calib.html">ุชุนุฏูู ุจูุงูุงุช ูุญุต ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Print_Out_Calib.html">ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Recived_Calib.html">ุชุณููู ุนุฏุงุฏ</div>

                            <div class="dropdown-group" data-icon="๐">ุชูุงุฑูุฑ ุงููุญุต</div>
                            <div class="dropdown-item" data-page="R_Entr_Calib.html">ุชูุฑูุฑ ุฏุฎูู ูุญุต ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="R_Calib.html">ุชูุฑูุฑ ูุญุต ุนุฏุงุฏ</div>

                            <div class="dropdown-group" data-icon="๐๏ธ">ุงูุตูุงูุฉ</div>
                            <div class="dropdown-item" data-page="Entr_Maint.html">ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Maint.html">ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Edite_Maint.html">ุชุนุฏูู ุจูุงูุงุช ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Print_Out_SMaint.html">ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุตูุงูุฉ ุนุฏุงุฏ
                            </div>
                            <div class="dropdown-item" data-page="Print_Out_TMaint.html">ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน ุตูุงูุฉ ุนุฏุงุฏ
                            </div>

                            <div class="dropdown-group" data-icon="๐">ุชูุงุฑูุฑ ุงูุตูุงูุฉ</div>
                            <div class="dropdown-item" data-page="R_Entr_Maint.html">ุชูุฑูุฑ ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="R_Maint.html">ุชูุฑูุฑ ุตูุงูุฉ ุนุฏุงุฏ</div>

                            <div class="dropdown-group" data-icon="โป๏ธ">ุงูุชูููู</div>
                            <div class="dropdown-item" data-page="Takheen.html">ุชูููู ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Edite_Takheen.html">ุชุนุฏูู ุจูุงูุงุช ุชูููู ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="R_Takheen.html">ุชูุฑูุฑ ุชูููู ุนุฏุงุฏ</div>

                            <div class="dropdown-group" data-icon="๐๏ธ">ุงูุฃุฑุดูู</div>
                            <div class="dropdown-item" data-page="R_Calib_Archive.html">ุฃุฑุดูู ุงููุญุต</div>
                            <div class="dropdown-item" data-page="R_Maint_Archive.html">ุฃุฑุดูู ุงูุตูุงูุฉ</div>
                            <div class="dropdown-item" data-page="Re_Print_Out_Calib.html">ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุนุฏุงุฏ
                            </div>
                            <div class="dropdown-item" data-page="Re_Print_Out_SMaint.html">ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุตูุงูุฉ
                                ุนุฏุงุฏ</div>
                            <div class="dropdown-item" data-page="Re_Print_Out_TMaint.html">ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน ุตูุงูุฉ
                                ุนุฏุงุฏ</div>

                            <div class="dropdown-item" data-page="Main_Dashboard.html" data-icon="๐">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
                            </div>
                        </div>
                    </div>


                    <input type="date" id="current_date" class="current_date" readonly>
                </div>
                <div class="table-header-controls">
                    <input id="searchInput" placeholder="๐ ุจุญุซ ุจุฑูู ุงูุนุฏุงุฏ">
                    <label class="checkbox-wrapper">
                        ุงูุจุญุซ ูู ุงูุตูุงูุฉ
                        <input type="checkbox" id="maintSearchCheckbox">
                    </label>
                </div>
            </section>

            <!-- First Table -->
            <section class="table-wrapper">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ู</th>
                                <th>ููุน ุงููุธุงู</th>
                                <th>ุฑูู ุงูุนุฏุงุฏ</th>
                                <th>ููุฏ ุงููุดุชุฑู</th>
                                <th>ุงุณู ุงููุดุชุฑู</th>
                                <th>ููุน ุงูุนุฏุงุฏ</th>
                                <th>ููุน ุงูุชูุตูู</th>
                                <th>ุงูุฌูุฏ</th>
                                <th>ุฑูู ุงูุญุณุงุจ</th>
                                <th>ููุงู ุงูุชุฑููุจ</th>
                                <th>ุณูุฉ ุงูุตูุน</th>
                                <th>ุงููุฑุงุกุฉ</th>
                                <th>ุงููุฏุฑุฉ</th>
                                <th>ุงููุทุงุน</th>
                                <th>ุงูููุฏุณุฉ</th>
                                <th>ููุน ุงููุดุงุท</th>
                                <th>ุณุจุจ ุงูุฑูุน</th>
                                <th>ุชุงุฑูุฎ ุงูุฑูุน</th>
                                <th>ุชูุฑูุฑ ูุญุต ุงูููุฏุณุฉ</th>
                                <th>ุชุงุฑูุฎ ุฏุฎูู ุงููุญุต</th>
                                <th>ุฏุงุฆู- ูุคูุช</th>
                                <th>ุญุงูุฉ ุงูุฑุตุงุต</th>
                                <th>ูุณุจุฉ ุงูุฎุทุฃ</th>
                                <th>%</th>
                                <th>ุงูุชูุงุนุจ</th>
                                <th>ุณููู</th>
                                <th>ุนุงุทู</th>
                                <th>ุงูุชููุฆุฉ</th>
                                <th>ุงูุตูุงูุฉ</th>
                                <th>ุงูุฅุญูุงู ูุงูุชุฑููุจ</th>
                                <th>ุชุงุฑูุฎ ุงููุญุต</th>
                                <th>ููุงุญุธุงุช</th>
                                <th>ุญุงูุฉ ุงูุนุฏุงุฏ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody1"></tbody>
                    </table>
                </div>
            </section>

            <!-- Second Table -->
            <section class="table-wrapper">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ู</th>
                                <th>ููุน ุงููุธุงู</th>
                                <th>ุฑูู ุงูุนุฏุงุฏ</th>
                                <th>ููุฏ ุงููุดุชุฑู</th>
                                <th>ุงุณู ุงููุดุชุฑู</th>
                                <th>ููุน ุงูุนุฏุงุฏ</th>
                                <th>ููุน ุงูุชูุตูู</th>
                                <th>ุงูุฌูุฏ</th>
                                <th>ุณูุฉ ุงูุตูุน</th>
                                <th>ุงููุฏุฑุฉ</th>
                                <th>ุงููุทุงุน</th>
                                <th>ุงูููุฏุณุฉ</th>
                                <th>ุฑูู ุงูุจุทุงูุฉ</th>
                                <th>ุงุณู ุงููุณุชูู</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody2"></tbody>
                    </table>
                </div>
            </section>

            <div class="row-counter-dashboard">
                <div class="dashboard-card">
                    <h3>ุนุฏุฏ ุงูุณุฌูุงุช</h3>
                    <span id="rowCountValue">0</span>
                </div>
            </div>

            <div class="scroll-buttons">
                <button id="scrollUp" class="scroll-btn" title="ุฅูู ุงูุฃุนูู">
                    <ion-icon name="chevron-up-outline"></ion-icon>
                </button>
                <button id="scrollDown" class="scroll-btn" title="ุฅูู ุงูุฃุณูู">
                    <ion-icon name="chevron-down-outline"></ion-icon>
                </button>
            </div>
        </div>

        <!-- ================= LEFT SIDE ================= -->
        <div class="left-side">
            <section class="glass">

                <div class="header-top">
                    <div class="logo"><ion-icon name="flash-outline"></ion-icon></div>
                    <div class="header-text">
                        ูุฒุงุฑุฉ ุงูููุฑุจุงุก ูุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ<br>
                        ุงูุดุฑูุฉ ุงููุงุจุถุฉ ูููุฑุจุงุก ูุตุฑ<br>
                        ุดุฑูุฉ ุดูุงู ุงูุฏูุชุง ูุชูุฒูุน ุงูููุฑุจุงุก
                    </div>
                </div>

                <h1 class="title-main">ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ูุฃูุธูุฉ ุงูุนุฏุงุฏุงุช ุงูุญุฏูุซุฉ</h1>

                <div class="form-grid">
                    <input id="reciver" placeholder="ุงุณู ุงููุณุชูู">
                    <input id="betaka" placeholder="ุฑูู ุงูุจุทุงูุฉ">
                    <input id="keta3" placeholder="ุงููุทุงุน" readonly>
                    <input id="handsa" placeholder="ุงูููุฏุณุฉ" readonly>
                </div>

                <div class="buttons">
                    <button id="saveBtn" class="primary">ุฎุฑูุฌ ูู ุงููุญุต</button>
                    <button id="clearBtn" class="secondary">ุชูุฑูุบ</button>
                </div>

            </section>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
        import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

        // Firebase Configuration
        const app = initializeApp({
            apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
            authDomain: "ndedc-meter-calib.firebaseapp.com",
            databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com"
        });
        const db = getDatabase(app);

        // DOM Elements
        const tableBody1 = document.getElementById("tableBody1");
        const tableBody2 = document.getElementById("tableBody2");
        const searchInput = document.getElementById("searchInput");
        const rowCountValue = document.getElementById("rowCountValue");
        const current_date = document.getElementById("current_date");
        const reciver = document.getElementById("reciver");
        const betaka = document.getElementById("betaka");
        const keta3 = document.getElementById("keta3");
        const handsa = document.getElementById("handsa");
        const clearBtn = document.getElementById("clearBtn");
        const maintSearchCheckbox = document.getElementById("maintSearchCheckbox");
        const saveBtn = document.getElementById("saveBtn");

        let filteredData = [];
        let selectedMeterData = null;
        let currentSourceNode = "Calib"; // Tracks where the data came from

        // 1. Search Function
        const performSearch = async () => {
            const value = searchInput.value.trim();

            // Reset UI
            tableBody1.innerHTML = "";
            tableBody2.innerHTML = "";
            rowCountValue.textContent = "0";
            selectedMeterData = null;
            keta3.value = "";
            handsa.value = "";

            if (!value) {
                filteredData = [];
                return;
            }

            // Determine path based on checkbox
            currentSourceNode = maintSearchCheckbox.checked ? "Reciever_Calib" : "Calib";

            try {
                const snap = await get(ref(db, currentSourceNode));
                filteredData = [];

                if (snap.exists()) {
                    snap.forEach(child => {
                        const rawData = child.val();
                        const d = rawData.otherdata || rawData;
                        if (d.MNO && d.MNO.includes(value)) {
                            filteredData.push(d);
                        }
                    });
                }
                renderTables(maintSearchCheckbox.checked);
            } catch (error) {
                console.error(error);
                Swal.fire("ุฎุทุฃ", "ูุดู ุฌูุจ ุงูุจูุงูุงุช", "error");
            }
        };

        // 2. Render Function
        function renderTables(isSecondTable = false) {
            tableBody1.innerHTML = "";
            tableBody2.innerHTML = "";

            const wrapper1 = tableBody1.closest(".table-wrapper");
            const wrapper2 = tableBody2.closest(".table-wrapper");

            wrapper1.style.display = isSecondTable ? "none" : "block";
            wrapper2.style.display = isSecondTable ? "block" : "none";

            filteredData.forEach((d, i) => {
                const rowDataString = JSON.stringify(d).replace(/'/g, "&apos;");
                let rowHtml = "";

                if (isSecondTable) {
                    rowHtml = `
                <tr onclick='selectMeter(${rowDataString})' style="cursor:pointer">
                    <td>${i + 1}</td>
                    <td>${d.Type || ""}</td>
                    <td>${d.MNO || ""}</td>
                    <td>${d.MCO || ""}</td>
                    <td>${d.MNAME || ""}</td>
                    <td>${d.Mtype || ""}</td>
                    <td>${d.Connection || ""}</td>
                    <td>${d.Voltage || ""}</td>
                    <td>${d.YEAR || ""}</td>
                    <td>${d.MPOWER || ""}</td>
                    <td>${d.Keta3 || ""}</td>
                    <td>${d.Handsa || ""}</td>
                    <td>${d.Betaka || ""}</td>
                    <td>${d.Reciver || ""}</td>
                </tr>`;
                    tableBody2.innerHTML += rowHtml;
                } else {
                    rowHtml = `
                <tr onclick='selectMeter(${rowDataString})' style="cursor:pointer">
                    <td>${i + 1}</td>
                    <td>${d.Type || ""}</td>
                    <td>${d.MNO || ""}</td>
                    <td>${d.MCO || ""}</td>
                    <td>${d.MNAME || ""}</td>
                    <td>${d.Mtype || ""}</td>
                    <td>${d.Connection || ""}</td>
                    <td>${d.Voltage || ""}</td>
                    <td>${d.ACCNO || ""}</td>
                    <td>${d.PLACE || ""}</td>
                    <td>${d.YEAR || ""}</td>
                    <td>${d.MREADING || ""}</td>
                    <td>${d.MPOWER || ""}</td>
                    <td>${d.Keta3 || ""}</td>
                    <td>${d.Handsa || ""}</td>
                    <td>${d.Nashattype || ""}</td>
                    <td>${d.Removingfor || ""}</td>
                    <td>${d.Uploaddate || ""}</td>
                    <td>${d.Mremovingfor || ""}</td>
                    <td>${d.Enter_Calib_Date || ""}</td>
                    <td>${d.Mstat || ""}</td>
                    <td>${d.Rosas || ""}</td>
                    <td>${d.Error || ""}</td>
                    <td>${d.Errperc || ""}</td>
                    <td>${d.Munip || ""}</td>
                    <td>${d.Mgood || ""}</td>
                    <td>${d.Crab || ""}</td>
                    <td>${d.Format || ""}</td>
                    <td>${d.Maintain || ""}</td>
                    <td>${d.Reinf || ""}</td>
                    <td>${d.CalibDate || ""}</td>
                    <td>${d.Notes || ""}</td>
                    <td><span class="status">ุฌุงูุฒ ููุงุณุชูุงู</span></td>
                </tr>`;
                    tableBody1.innerHTML += rowHtml;
                }
            });
            rowCountValue.textContent = filteredData.length;
        }

        // 3. Select Meter
        window.selectMeter = (d) => {
            selectedMeterData = d;
            keta3.value = d.Keta3 || "";
            handsa.value = d.Handsa || "";
            reciver.value = d.Reciver || "";
            betaka.value = d.Betaka || "";
            highlightSelectedRow(d.MNO);
        };

        function highlightSelectedRow(mno) {
            [tableBody1, tableBody2].forEach(tbody => {
                Array.from(tbody.rows).forEach(row => {
                    row.style.backgroundColor = row.cells[2].textContent === mno ? "#d1e7dd" : "";
                });
            });
        }

        // 4. Save/Exit Function
        saveBtn.addEventListener("click", async () => {
            if (!selectedMeterData) return Swal.fire("ุชูุจูู", "ุงุฎุชุฑ ุนุฏุงุฏ ุฃููุงู", "warning");

            // --- NEW RESTRICTION ---
            // Check if the current source is the Maintenance table (Reciever_Calib)
            if (currentSourceNode === "Reciever_Calib") {
                return Swal.fire({
                    icon: "error",
                    title: "ุบูุฑ ูุณููุญ",
                    text: "ูุฐุง ุงูุนุฏุงุฏ ุชู ุงุณุชูุงูู ูุณุจูุงู ูู ุงูุตูุงูุฉ. ูุง ูููู ุญูุธู ูุฑุฉ ุฃุฎุฑู.",
                    confirmButtonText: "ููุงูู"
                });
            }
            // -----------------------

            if (!reciver.value.trim() || !betaka.value.trim()) return Swal.fire("ุชูุจูู", "ูุฑุฌู ุฅุฏุฎุงู ุงูุจูุงูุงุช", "warning");

            try {
                // Save to Reciever_Calib (The Final Received Destination)
                await set(ref(db, "Reciever_Calib/" + selectedMeterData.MNO), {
                    otherdata: {
                        ...selectedMeterData,
                        Reciver: reciver.value.trim(),
                        Betaka: betaka.value.trim(),
                        ExitDate: current_date.value
                    }
                });

                // Delete from the original node (Calib)
                await remove(ref(db, currentSourceNode + "/" + selectedMeterData.MNO));

                exportSingleMeterToExcel(selectedMeterData);
                Swal.fire("ุชู", "ุชู ุฎุฑูุฌ ุงูุนุฏุงุฏ ุจูุฌุงุญ", "success");
                clearBtn.click(); // Reset form
            } catch (error) {
                console.error(error);
                Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ", "error");
            }
        });

        // 5. Excel Export
        function exportSingleMeterToExcel(d) {
            const data = [{
                "ุฑูู ุงูุนุฏุงุฏ": d.MNO || "",
                "ุงุณู ุงููุดุชุฑู": d.MNAME || "",
                "ุงุณู ุงููุณุชูู": reciver.value.trim(),
                "ุฑูู ุงูุจุทุงูุฉ": betaka.value.trim(),
                "ุชุงุฑูุฎ ุงูุฎุฑูุฌ": current_date.value
            }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ุงุณุชูุงู");
            XLSX.writeFile(wb, `ุงุณุชูุงู_${d.MNO}.xlsx`);
        }

        // 6. Listeners
        searchInput.addEventListener("input", performSearch);
        maintSearchCheckbox.addEventListener("change", performSearch);

        clearBtn.addEventListener("click", () => {
            searchInput.value = "";
            reciver.value = "";
            betaka.value = "";
            keta3.value = "";
            handsa.value = "";
            tableBody1.innerHTML = "";
            tableBody2.innerHTML = "";
            rowCountValue.textContent = "0";
            selectedMeterData = null;
        });

        document.addEventListener("DOMContentLoaded", () => {
            current_date.value = new Date().toISOString().split("T")[0];
        });

        document.getElementById("scrollUp").addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
        document.getElementById("scrollDown").addEventListener("click", () => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }));


        // Dropdown Menu Functionality
        const btn = document.getElementById("dropdownBtn");
        const menu = document.getElementById("dropdownMenu");

        btn.addEventListener("click", () => {
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        });

        document.querySelectorAll('.dropdown-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                window.open(page, '_blank'); // ูุชุญ ูู ุชุจููุจ ุฌุฏูุฏ
            });
        });

        // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงููุงุฆูุฉ
        document.addEventListener("click", e => {
            if (!e.target.closest(".modern-dropdown")) {
                menu.style.display = "none";
            }
        });



    </script>
</body>

</html>
<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <script src="gatekeeper.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ูุธุงู ุงููุญุต ูุงููุนุงูุฑุฉ</title>
  <link rel="stylesheet" href="G1_Calib.css" />

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
</head>

<body>

  <main class="app">
    <!-- RIGHT SIDE: TABLE -->
    <div class="right-side">
      <section class="table-top-section">
        <div class="table-header">
          <ion-icon name="list-outline"></ion-icon>


          <div class="modern-dropdown">
            <button class="dropdown-btn" id="dropdownBtn">
              โพ ุงุฎุชุฑ ููุฃูุชูุงู
            </button>

            <div class="dropdown-menu" id="dropdownMenu">
              <div class="dropdown-group" data-icon="๐">ุงููุญุต</div>
              <div class="dropdown-item" data-page="Entr_Calib.html">
                ุฏุฎูู ูุญุต ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Calib.html">ูุญุต ุนุฏุงุฏ</div>
              <div class="dropdown-item" data-page="Edite_Calib.html">
                ุชุนุฏูู ุจูุงูุงุช ูุญุต ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Print_Out_Calib.html">
                ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Recived_Calib.html">
                ุชุณููู ุนุฏุงุฏ
              </div>

              <div class="dropdown-group" data-icon="๐">ุชูุงุฑูุฑ ุงููุญุต</div>
              <div class="dropdown-item" data-page="R_Entr_Calib.html">
                ุชูุฑูุฑ ุฏุฎูู ูุญุต ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="R_Calib.html">
                ุชูุฑูุฑ ูุญุต ุนุฏุงุฏ
              </div>

              <div class="dropdown-group" data-icon="๐๏ธ">ุงูุตูุงูุฉ</div>
              <div class="dropdown-item" data-page="Entr_Maint.html">
                ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Maint.html">
                ุตูุงูุฉ ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Edite_Maint.html">
                ุชุนุฏูู ุจูุงูุงุช ุตูุงูุฉ ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Print_Out_SMaint.html">
                ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุตูุงูุฉ ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Print_Out_TMaint.html">
                ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน ุตูุงูุฉ ุนุฏุงุฏ
              </div>

              <div class="dropdown-group" data-icon="๐">ุชูุงุฑูุฑ ุงูุตูุงูุฉ</div>
              <div class="dropdown-item" data-page="R_Entr_Maint.html">
                ุชูุฑูุฑ ุฏุฎูู ุตูุงูุฉ ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="R_Maint.html">
                ุชูุฑูุฑ ุตูุงูุฉ ุนุฏุงุฏ
              </div>

              <div class="dropdown-group" data-icon="โป๏ธ">ุงูุชูููู</div>
              <div class="dropdown-item" data-page="Takheen.html">
                ุชูููู ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Edite_Takheen.html">
                ุชุนุฏูู ุจูุงูุงุช ุชูููู ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="R_Takheen.html">
                ุชูุฑูุฑ ุชูููู ุนุฏุงุฏ
              </div>

              <div class="dropdown-group" data-icon="๐๏ธ">ุงูุฃุฑุดูู</div>
              <div class="dropdown-item" data-page="R_Calib_Archive.html">
                ุฃุฑุดูู ุงููุญุต
              </div>
              <div class="dropdown-item" data-page="R_Maint_Archive.html">
                ุฃุฑุดูู ุงูุตูุงูุฉ
              </div>
              <div class="dropdown-item" data-page="Re_Print_Out_Calib.html">
                ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Re_Print_Out_SMaint.html">
                ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุญุต ุตูุงูุฉ ุนุฏุงุฏ
              </div>
              <div class="dropdown-item" data-page="Re_Print_Out_TMaint.html">
                ุฅุนุงุฏุฉ ุทุจุงุนุฉ ุชูุฑูุฑ ูุฌูุน ุตูุงูุฉ ุนุฏุงุฏ
              </div>

              <div class="dropdown-item" data-page="Main_Dashboard.html" data-icon="๐">
                ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
              </div>
            </div>
          </div>

          <input type="date" class="calib_date" id="calib_date" readonly />
          <div class="table-header-controls">
            <input id="searchInput" placeholder="๐ ุจุญุซ..." />
            <button id="exportBtn">
              <ion-icon name="download-outline"></ion-icon> ุชุตุฏูุฑ Excel
            </button>
          </div>
        </div>
      </section>

      <section class="table-wrapper">
        <div class="table-container">
          <table id="dataTable">
            <thead>
              <tr>
                <th>ู</th>
                <th>ููุน ุงููุธุงู</th>
                <th>ุฑูู ุงูุนุฏุงุฏ</th>
                <th>ููุฏ ุงููุดุชุฑู</th>
                <th>ุงุณู ุงููุดุชุฑู</th>
                <th>ููุน ุงูุนุฏุงุฏ</th>
                <th>ููุน ุงูุชูุตูู</th>
                <th>ุงูุฌูุฏ</th>
                <th>ุฑูู ุงูุญุณุงุจ</th>
                <th>ููุงู ุงูุชุฑููุจ</th>
                <th>ุณูุฉ ุงูุตูุน</th>
                <th>ุงููุฑุงุกุฉ</th>
                <th>ุงููุฏุฑุฉ</th>
                <th>ุงููุทุงุน</th>
                <th>ุงูููุฏุณุฉ</th>
                <th>ููุน ุงููุดุงุท</th>
                <th>ุณุจุจ ุงูุฑูุน</th>
                <th>ุชุงุฑูุฎ ุงูุฑูุน</th>
                <th>ุชูุฑูุฑ ูุญุต ุงูููุฏุณุฉ</th>
                <th>ุชุงุฑูุฎ ุฏุฎูู ุงููุญุต</th>
                <th>ููุงุญุธุงุช</th>
                <th>ุญุงูุฉ ุงูุนุฏุงุฏ</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </section>

      <div class="row-counter-dashboard" id="rowCount">
        <div class="dashboard-card">
          <h3>ุนุฏุฏ ุงูุณุฌูุงุช</h3>
          <span id="rowCountValue">0</span>
        </div>
      </div>

      <div class="scroll-buttons">
        <button id="scrollUp" class="scroll-btn" title="ุฅูู ุงูุฃุนูู">
          <ion-icon name="chevron-up-outline"></ion-icon>
        </button>
        <button id="scrollDown" class="scroll-btn" title="ุฅูู ุงูุฃุณูู">
          <ion-icon name="chevron-down-outline"></ion-icon>
        </button>
      </div>
    </div>

    <!-- LEFT SIDE: FORM -->
    <div class="left-side">
      <section class="glass">
        <div class="header-top">

          <label class="dark-toggle" title="Toggle dark mode">
            <input id="darkToggle" class="dark-toggle__input" type="checkbox" aria-label="Dark mode toggle"
              role="switch" aria-checked="false" />
            <span class="switch"></span>
            <span class="icon">๐</span>
          </label>

          <div class="logo">
            <ion-icon name="flash-outline"></ion-icon>
          </div>
          <div class="header-text">
            ูุฒุงุฑุฉ ุงูููุฑุจุงุก ูุงูุทุงูุฉ ุงููุชุฌุฏุฏุฉ<br />
            ุงูุดุฑูุฉ ุงููุงุจุถุฉ ูููุฑุจุงุก ูุตุฑ<br />
            ุดุฑูุฉ ุดูุงู ุงูุฏูุชุง ูุชูุฒูุน ุงูููุฑุจุงุก
          </div>
        </div>

        <h1 class="title-main">ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ูุฃูุธูุฉ ุงูุนุฏุงุฏุงุช ุงูุญุฏูุซุฉ</h1>

        <h3>ุจูุงูุงุช ุงูุนุฏุงุฏุงุช ุงููุณุฌูุฉ ูููุญุต</h3>

        <div class="form-grid">
          <input id="types" placeholder="ููุน ุงููุธุงู" readonly />
          <input id="mno" placeholder="ุฑูู ุงูุนุฏุงุฏ" readonly />
          <input id="mco" placeholder="ููุฏ ุงููุงุฑุช" readonly />
          <input id="mname" placeholder="ุงุณู ุงููุดุชุฑู" readonly />
          <input id="voltage" placeholder="ุฌูุฏ ุงูุชุดุบูู" readonly />
          <input id="accno" placeholder="ุฑูู ุงูุญุณุงุจ" readonly />
          <input id="place" placeholder="ููุงู ุงูุชุฑููุจ" readonly />
          <input id="year" placeholder="ุณูุฉ ุงูุตูุน" readonly />
          <input id="mreading" placeholder="ุงููุฑุงุกุฉ" readonly />
          <input id="mpower" placeholder="ุงููุฏุฑุฉ" readonly />
          <input id="mconn" placeholder="ููุน ุงูุชูุตูู" readonly />
          <input id="mtype" placeholder="ููุน ุงูุนุฏุงุฏ" readonly />
          <input id="keta3" placeholder="ุงููุทุงุน" readonly />
          <input id="handsa" placeholder="ุงูููุฏุณุฉ" readonly />
          <input id="nashattype" placeholder="ููุน ุงููุดุงุท" readonly />
          <input id="removingfor" placeholder="ุณุจุจ ุงูุฑูุน" readonly />
          <input id="mremovingfor" placeholder="ุชูุฑูุฑ ูุญุต ุงูููุฏุณุฉ" readonly />
          <label for="uploaddate">ุชุงุฑูุฎ ุงูุฑูุน</label>
          <input type="date" class="uploaddate" id="uploaddate" placeholder="ุชุงุฑูุฎ ุงูุฑูุน" readonly />
          <label for="enter_calib_date">ุชุงุฑูุฎ ุฏุฎูู ุงููุญุต</label>
          <input type="date" class="enter_calib_date" id="enter_calib_date" placeholder="ุชุงุฑูุฎ ุฏุฎูู ุงููุญุต" readonly />
          <input id="md" placeholder="ุฃูุตู ุญูู KW" aria-label="Maximum load KW" class="input-highlight" />
          <select id="mstat" aria-label="Permanent or temporary">
            <option value="">โพ ุฏุงุฆู / ูุคูุช</option>
            <option>ุฏุงุฆู</option>
            <option>ูุคูุช</option>
          </select>
          <select id="rosas" aria-label="Lead seal status">
            <option value="">โพ ุญุงูุฉ ุงูุฑุตุงุต</option>
            <option>ุณููู</option>
            <option>ุบูุฑ ุณููู</option>
            <option>ูุฑุตุต</option>
            <option>ุบูุฑ ูุฑุตุต</option>
          </select>
          <select id="error" aria-label="Error rate">
            <option value="">โพ ูุณุจุฉ ุงูุฎุทุฃ</option>
            <option>ููุฌุจ</option>
            <option>ุณุงูุจ</option>
          </select>
          <input id="errperc" placeholder="%" aria-label="Error percentage" class="input-highlight" />
          <select id="munip" aria-label="Tampering status">
            <option value="">โพุงูุชูุงุนุจ</option>
            <option>ุชูุงุนุจ ุจุงูุจูุฑุฏุฉ ุงูุฏุงุฎููุฉ ููุนุฏุงุฏ</option>
            <option>ุชูุงุนุจ ุจุงูุฐุงูุฑุฉ ุงูุฏุงุฎููุฉ ููุนุฏุงุฏ</option>
            <option>ููุฌุฏ ุงุซุงุฑ ุชูุงุนุจ ุฏุงุฎู ุงูุนุฏุงุฏ</option>
            <option>ุชูุงุนุจ ุจูุฌููุนุฉ ุงููุณุฌู</option>
            <option>ุชูุงุนุจ ุจุงูุนุฏุงุฏ</option>
            <option>ุงูุฒุฌุงุฌ ููุณูุฑ</option>
          </select>
          <select id="mgood" aria-label="Meter status">
            <option value="">โพุณููู</option>
            <option>
              ุงูุนุฏุงุฏ ุณููู ููุณุจุฉ ุงูุฎุทุฃ ูู ุญุฏูุฏ ุงููุณููุญ ุจูุง ููุชู ุชุฑููุจู ูููุดุชุฑู
              ูุฑุฉ ุงุฎุฑู
            </option>
            <option>ุงูุนุฏุงุฏ ุณููู ููุชู ุชููููุฉ ูุชุฑููุจ ุนุฏุงุฏ ูุณุจู ุงูุฏูุน</option>
            <option>
              ุงูุนุฏุงุฏ ุณููู ููุณุจุฉ ุงูุฎุทุฃ ูู ุญุฏูุฏ ุงููุณููุญ ุจูุง ููุชู ุงุฑุชุฌุงุนู ูููุฎุงุฒู
            </option>
            <option>ุงูุนุฏุงุฏ ุณููู ูุชุนุฏู ูุฏุฉ ุงูุชุฑููุจ-ููุชู ุชููููุฉ</option>
          </select>
          <select id="crab" aria-label="Defective meter">
            <option value="">โพุนุงุทู</option>
            <option>ุนุงุทู ูุฑุต ุงูุฏูุฑุงู ูุง ูุนูู-ููุชู ุชููููุฉ</option>
            <option>ุนุงุทู ูุฌููุนุฉ ุงููุณุฌู-ููุชู ุชููููุฉ</option>
            <option>
              ุนุงุทู ูููุฒู ุชููููุฉ ูุชูุฌู ุชูู ุจุงูุฐุงูุฑุฉ ุงูุฏุงุฎููู ุจุงูุนุฏุงุฏ
            </option>
            <option>ุนุงุทู ูุณุจุฉ ุฎุทุฃ-ูุชู ุชููููู</option>
            <option>ุนุงุทู ูุญุชุฑู ููุชู ุชููููู</option>
            <option>ุนุงุทู ุงูุดุงุดุฉ ูุงุชุนูู</option>
            <option>ุนุงุทู ูุงููุจู ุงูุดุญู</option>
            <option>ุนุงุทู ุงูููุตู ูุง ูุนูู</option>
          </select>
          <select id="format" aria-label="Formatting">
            <option value="">โพุงูุชููุฆุฉ</option>
            <option>ุชููุฆุฉ ุงูุนุฏุงุฏ ุจุงูููุฏุณุฉ ูุชุฑููุจุฉ ูููุดุชุฑู ูุฑุฉ ุงุฎุฑู</option>
            <option>ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉูุฃุนุงุฏุฉ ุงูุชููุฆุฉ</option>
            <option>ุชููุฆุฉ ุงูุนุฏุงุฏ ุจุงููุนูู ุงูููุฏุณู</option>
            <option>ุชููุฆุฉ ุงูุนุฏุงุฏ ุจูุนุฑูุฉ ูุดุฑู ุงููุทุงุน</option>
            <option>ุงููุฏููููุฉ ูุณุชุญูุฉ</option>
            <option>ุงูุฑุตูุฏ ุตุญูุญ ููุณุชุญู</option>
          </select>
          <select id="maintain" aria-label="Maintenance">
            <option value="">โพุงูุตูุงูุฉ</option>
            <option>ุนุทู ุจุงูุจุทุงุฑูุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
            <option>
              ูุงุฑูุก ุงููุฑูุช ูุง ูุนูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>
              ุงูุนุฏุงุฏ ูุง ููุจู ุงูุดุญู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>
              ุงูุนุฏุงุฏ ูุง ูููู ุจุงูุชูุตูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>ุงูุดุงุดุฉ ุนุงุทูุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
            <option>
              ุงูุนุฏุงุฏ ูุญุชุงุฌ ููุชููุฆุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>ุชูุฑูุฑ ูุญุต ููุนุฏุงุฏ ูู ูุจู ุงูุดุฑูุฉ ุงูููุฑุฏุฉ</option>
            <option>
              ุชูู ุจุฌุณู/ุฑูุฒุชุฉ ุงูุนุฏุงุฏ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>ุฒูุงุฏุฉ ูุฏุฑุฉ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
            <option>ุจุญุซ ูุฏููููุฉ ุจุงูุนุฏุงุฏ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
            <option>ุงูุนุฏุงุฏ ูุญุชุฑู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
            <option>ุงูุนุฏุงุฏ ูุง ูุนูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ</option>
            <option>
              ููุจุฉ ุงูุชูุงุนุจ ุชุนูู ุจุงุณุชูุฑุงุฑ ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>
              ุงูุนุฏุงุฏ ูุนูู ุจุฏูู ุดุญู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>
              ุงูุนุฏุงุฏ ูุง ูุณุฌู ุงูุงุณุชููุงู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
            <option>
              ุงูุนุฏุงุฏ ูุณุฌู ุงุณุชููุงู ุจุฏูู ุญูู ุงุฑุณุงูุฉ ููุดุฑูุฉ ุงูููุฑุฏุฉ ููุตูุงูุฉ
            </option>
          </select>
          <select id="reinf" aria-label="Installation and replacement">
            <option value="">โพุงูุฃุญูุงู ูุงูุชุฑููุจ</option>
            <option>ุชุฑููุจ ุนุฏุงุฏ ุฃุญุงุฏู ูุณุจู ุงูุฏูุน</option>
            <option>ุชุฑููุจ ุนุฏุงุฏ ุซูุงุซู ูุณุจู ุงูุฏูุน</option>
            <option>ุชุฑููุจ ููุญู ูุณุจู ุงูุฏูุน</option>
            <option>ุชุฑููุจ ุนุฏุงุฏ ุนูู ุงูุฌูุฏ ุงููุชูุณุท</option>
          </select>
          <textarea id="notes" placeholder="ููุงุญุธุงุช" aria-label="Notes"></textarea>

          <select id="user_1" aria-label="First committee member">
            <option value="">โพ ุงุฎุชุฑ ุนุถู ุงููุฌูุฉ ุงูุฃูู</option>
          </select>
          <select id="user_2" aria-label="Second committee member">
            <option value="">โพ ุงุฎุชุฑ ุนุถู ุงููุฌูุฉ ุงูุซุงูู</option>
          </select>
        </div>

        <div class="buttons">
          <button id="saveBtn" class="primary">ุญูุธ</button>
          <button id="editBtn" class="warning">ุชุนุฏูู</button>
          <button id="clearBtn" class="secondary">ุชูุฑูุบ</button>
          <button id="deleteBtn" class="danger">ุญุฐู</button>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      get,
      set,
      push,
      update,
      remove,
    } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

    // Initialize Firebase app
    const app = initializeApp({
      apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
      authDomain: "ndedc-meter-calib.firebaseapp.com",
      databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com",
      projectId: "ndedc-meter-calib",
      storageBucket: "ndedc-meter-calib.appspot.com",
      messagingSenderId: "185425429190",
      appId: "1:185425429190:web:dce85f29eea55ad9f54dc7",
      measurementId: "G-C6QEKW26MW",
    });

    const db = getDatabase(app);
    const tableBody = document.getElementById("tableBody");
    const searchInput = document.getElementById("searchInput");
    const exportBtn = document.getElementById("exportBtn");
    const clearBtn = document.getElementById("clearBtn");
    const rowCount = document.getElementById("rowCountValue");
    const el = (id) => document.getElementById(id);
    let currentKey = null;

    // ุฏุงูุฉ ุงูุชูุจูู ุงูุณุฑูุน (Toast) ููุญุฑูุงุช ุงูุจุณูุทุฉ
    const toast = (title, icon = "success") => {
      Swal.fire({
        title: title,
        icon: icon,
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
      });
    };

    // Set today's date in the upload and calibration date fields
    function setTodayDates() {
      const today = new Date().toISOString().split("T")[0];
      el("uploaddate").value = today;
      el("enter_calib_date").value = today;
      el("calib_date").value = today;
    }
    setTodayDates();

    // Format date for display
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const date = new Date(dateStr);
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const Year = date.getFullYear();
      return `${day}/${month}/${Year}`;
    }

    // Fill form with selected row's data
    function fillForm(d, key, row) {
      currentKey = key;

      document
        .querySelectorAll(".selected-row")
        .forEach((r) => r.classList.remove("selected-row"));
      row.classList.add("selected-row");

      el("mno").value = d.MNO || "";
      el("mname").value = d.MNAME || "";
      el("mco").value = d.MCO || "";
      el("accno").value = d.ACCNO || "";
      el("voltage").value = d.Voltage || "";
      el("place").value = d.PLACE || "";
      el("year").value = d.YEAR || "";
      el("mreading").value = d.MREADING || "";
      el("mpower").value = d.MPOWER || "";

      el("types").value = d.Type || "";
      el("mtype").value = d.Mtype || "";
      el("mconn").value = d.Connection || "";
      el("keta3").value = d.Keta3 || "";
      el("handsa").value = d.Handsa || "";
      el("nashattype").value = d.Nashattype || "";
      el("removingfor").value = d.Removingfor || "";
      el("mremovingfor").value = d.Mremovingfor || "";

      el("uploaddate").value = d.Uploaddate || "";
      el("enter_calib_date").value = d.Enter_Calib_Date || "";

      toast(`ุชู ุงุฎุชูุงุฑ ุงูุนุฏุงุฏ: ${d.MNO}`, "info");
    }

    /* ================= CLEAR ================= */
    function clearFilters() {
      document
        .querySelectorAll(".left-side select, .left-side input")
        .forEach((el) => {
          if (el.tagName === "SELECT") el.selectedIndex = 0;
          else el.value = "";
        });
      searchInput.value = "";
      currentKey = null;
      setTodayDates();

      // ูุฅุนุงุฏุฉ ุชุญููู ุงูุฌุฏูู ูุงููุงู
      fetchData();

      Swal.fire({
        icon: "success",
        title: "ุชู ุชูุธูู ุงูููุงุชุฑ",
        timer: 1000,
        showConfirmButton: false,
      });
    }

    // Fetch data from Firebase
    async function fetchData(query = "") {
      const tbody = el("tableBody");
      tbody.innerHTML =
        "<tr><td colspan='22' class='loading-message'>ุฌุงุฑู ุงูุชุญููู...</td></tr>";

      // 1. ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุชุญููู (Loading) ูุจู ุงูุจุฏุก ูู ุฌูุจ ุงูุจูุงูุงุช
      const loadingToast = Swal.fire({
        title: "ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช...",
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        },
      });

      try {
        const snap = await get(ref(db, "Enter_Calib"));
        tbody.innerHTML = "";
        let i = 1;
        const q = query.toLowerCase();

        if (!snap.exists()) {
          // ุฅุบูุงู ุงูุชูุจูู ุฅุฐุง ูู ุชูุฌุฏ ุจูุงูุงุช
          Swal.close();
          updateRowCount();
          return;
        }

        snap.forEach((c) => {
          const d = c.val().otherdata || c.val();
          if (
            query &&
            !d.MNO?.toLowerCase().includes(q) &&
            !d.MNAME?.toLowerCase().includes(q)
          )
            return;

          const tr = document.createElement("tr");
          tr.innerHTML = `
                <td>${i++}</td>
                <td>${d.Type || ""}</td>
                <td>${d.MNO || ""}</td>
                <td>${d.MCO || ""}</td>
                <td>${d.MNAME || ""}</td>
                <td>${d.Mtype || ""}</td>
                <td>${d.Connection || ""}</td>
                <td>${d.Voltage || ""}</td>
                <td>${d.ACCNO || ""}</td>
                <td>${d.PLACE || ""}</td>
                <td>${d.YEAR || ""}</td>
                <td>${d.MREADING || ""}</td>
                <td>${d.MPOWER || ""}</td>
                <td>${d.Keta3 || ""}</td>
                <td>${d.Handsa || ""}</td>
                <td>${d.Nashattype || ""}</td>
                <td>${d.Removingfor || ""}</td>
                <td>${formatDate(d.Uploaddate)}</td>
                <td>${d.Mremovingfor || ""}</td>
                <td>${formatDate(d.Enter_Calib_Date)}</td>
                <td>${d.Notes || ""}</td>
                <td><span class="status">ููุฏ ุงููุญุต</span></td>
            `;
          tr.onclick = () => fillForm(d, c.key, tr);
          tbody.appendChild(tr);
        });

        // 2. ุฅุบูุงู ุฑุณุงูุฉ ุงูุชุญููู ุจุนุฏ ุงูุงูุชูุงุก ูู ุงููุนุงูุฌุฉ ุจูุฌุงุญ
        Swal.close();

        updateRowCount();
        populateUsers();
      } catch (err) {
        // 3. ูู ุญุงูุฉ ุงูุฎุทุฃุ ุงุณุชุจุฏุงู ุฑุณุงูุฉ ุงูุชุญููู ุจุฑุณุงูุฉ ุงูุฎุทุฃ
        Swal.fire({
          icon: "error",
          title: "ุฎุทุฃ",
          text: "ูุดู ุชุญููู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช",
          confirmButtonText: "ุญุณูุงู",
        });
        console.error(err);
      }
    }

    // Save data to Firebase
    async function saveData() {
      const mnoValue = el("mno").value.trim();
      if (!mnoValue) {
        Swal.fire("ุชุญุฐูุฑ", "ูุฑุฌู ุงุฎุชูุงุฑ ุนุฏุงุฏ ุฃููุงู ูู ุงูุฌุฏูู", "warning");
        return;
      }
      if (!el("user_1").value || !el("user_2").value) {
        Swal.fire("ุชุญุฐูุฑ", "ูุฑุฌู ุงุฎุชูุงุฑ ุฃุนุถุงุก ูุฌูุฉ ุงููุญุต", "warning");
        return;
      }

      // ุฅุธูุงุฑ ูุงุฌูุฉ ุชุญููู
      Swal.fire({
        title: "ุฌุงุฑู ุงูุญูุธ...",
        didOpen: () => Swal.showLoading(),
      });

      const otherdata = {
        MNO: el("mno").value,
        MNAME: el("mname").value,
        MCO: el("mco").value,
        Voltage: el("voltage").value,
        ACCNO: el("accno").value,
        PLACE: el("place").value,
        YEAR: el("year").value,
        MREADING: el("mreading").value,
        MPOWER: el("mpower").value,
        Type: el("types").value,
        Mtype: el("mtype").value,
        Connection: el("mconn").value,
        Keta3: el("keta3").value,
        Handsa: el("handsa").value,
        Nashattype: el("nashattype").value,
        Removingfor: el("removingfor").value,
        Mremovingfor: el("mremovingfor").value,
        Uploaddate: el("uploaddate").value,
        Enter_Calib_Date: el("enter_calib_date").value,
        Notes: el("notes").value,
        Timestamp: new Date().toISOString(),
        MRAFcalib: el("mrafcalib")?.value || "",
        MD: el("md")?.value || "",
        Mstat: el("mstat")?.value || "",
        Rosas: el("rosas")?.value || "",
        Error: el("error")?.value || "",
        Errperc: el("errperc")?.value || "",
        Munip: el("munip")?.value || "",
        Mgood: el("mgood")?.value || "",
        Crab: el("crab")?.value || "",
        Format: el("format")?.value || "",
        Maintain: el("maintain")?.value || "",
        Reinf: el("reinf")?.value || "",
        User_1: el("user_1").value,
        User_2: el("user_2").value,
        CalibDate: el("calib_date")?.value || "",
      };

      const calibdata = JSON.parse(JSON.stringify(otherdata));

      try {
        await set(ref(db, `Calib/${mnoValue}`), { otherdata, calibdata });
        await set(push(ref(db, "Archive_Calib")), {
          otherdata,
          calibdata,
          archivedAt: new Date().toISOString(),
        });

        Swal.fire(
          "ุชู ุงูุญูุธ!",
          "ุชู ุชุฑุญูู ุงูุจูุงูุงุช ุฅูู ูุณู ุงููุนุงูุฑุฉ ุจูุฌุงุญ.",
          "success",
        );
        fetchData();
        clearFilters();
      } catch (err) {
        Swal.fire("ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ: " + err.message, "error");
      }
    }

    // Export table to Excel
    function exportToExcel() {
      try {
        const table = el("dataTable");
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ุจูุงูุงุช_ุงููุญุต");
        const filename = `ุจูุงูุงุช_ุงููุญุต_${new Date().toISOString().split("T")[0]}.xlsx`;
        XLSX.writeFile(wb, filename);

        toast("ุชู ุชุตุฏูุฑ ููู Excel ุจูุฌุงุญ");
      } catch (err) {
        Swal.fire("ุฎุทุฃ", "ูุดู ุชุตุฏูุฑ ุงูููู: " + err.message, "error");
      }
    }

    function updateRowCount() {
      const rows = document.querySelectorAll("#tableBody tr");
      el("rowCountValue").textContent = rows.length;
    }

    el("scrollUp").onclick = () =>
      window.scrollTo({ top: 0, behavior: "smooth" });
    el("scrollDown").onclick = () =>
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth",
      });

    el("saveBtn").onclick = saveData;
    el("editBtn").onclick = () => {
      toast("ุฌุงุฑู ุงูุงูุชูุงู ูุตูุญุฉ ุงูุชุนุฏูู...", "info");
      setTimeout(() => {
        window.location.href = "Edite_Calib.html";
      }, 1000);
    };
    el("deleteBtn").onclick = () => {
      toast("ุฌุงุฑู ุงูุงูุชูุงู ูุตูุญุฉ ุงูุญุฐู...", "info");
      setTimeout(() => {
        window.location.href = "Edite_Calib.html";
      }, 1000);
    };
    clearBtn.addEventListener("click", clearFilters);
    el("exportBtn").onclick = exportToExcel;
    el("searchInput").addEventListener("input", (e) => searchTable());

    async function populateUsers() {
      const user1Dropdown = el("user_1");
      const user2Dropdown = el("user_2");
      user1Dropdown.innerHTML = `<option value="">โพ ุงุฎุชุฑ ุนุถู ุงููุฌูุฉ ุงูุฃูู</option>`;
      user2Dropdown.innerHTML = `<option value="">โพ ุงุฎุชุฑ ุนุถู ุงููุฌูุฉ ุงูุซุงูู</option>`;

      try {
        const snap = await get(ref(db, "users-generatedcode"));
        if (snap.exists()) {
          snap.forEach((userSnap) => {
            const user = userSnap.val();
            const option1 = document.createElement("option");
            const option2 = document.createElement("option");
            option1.value = user.username;
            option1.textContent = user.username;
            option2.value = user.username;
            option2.textContent = user.username;
            user1Dropdown.appendChild(option1);
            user2Dropdown.appendChild(option2);
          });
        }
      } catch (err) {
        console.error("Error users:", err);
      }
    }

    function searchTable() {
      const searchTerm = el("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#tableBody tr");
      rows.forEach((row) => {
        const mnoCell = row.cells[2];
        const mnoValue = mnoCell ? mnoCell.textContent.toLowerCase() : "";
        row.style.display = mnoValue.includes(searchTerm) ? "" : "none";
      });
      updateRowCount();
    }

    fetchData();

    /* ================= SCROLL FUNCTIONS ================= */
    function scrollUp() {
      window.scrollTo({
        top: 0,
        behavior: "smooth",
      });
    }

    function scrollDown() {
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth",
      });
    }

    // ุฑุจุท ุงูุฃุฒุฑุงุฑ ุจุงูุฏูุงู
    document.querySelectorAll("#scrollUp").forEach((btn) => {
      btn.addEventListener("click", scrollUp);
    });

    document.querySelectorAll("#scrollDown").forEach((btn) => {
      btn.addEventListener("click", scrollDown);
    });

    // Dropdown Menu Functionality
    const btn = document.getElementById("dropdownBtn");
    const menu = document.getElementById("dropdownMenu");

    btn.addEventListener("click", () => {
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    });

    document.querySelectorAll(".dropdown-item[data-page]").forEach((item) => {
      item.addEventListener("click", () => {
        const page = item.dataset.page;
        window.open(page, "_blank"); // ูุชุญ ูู ุชุจููุจ ุฌุฏูุฏ
      });
    });

    // ุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงููุงุฆูุฉ
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".modern-dropdown")) {
        menu.style.display = "none";
      }
    });
  </script>
  <script>
    (function () {
      const checkbox = document.getElementById("darkToggle");

      function setDark(enable) {
        if (enable) {
          document.body.classList.add("dark-mode");
          localStorage.setItem("darkMode", "1");
        } else {
          document.body.classList.remove("dark-mode");
          localStorage.setItem("darkMode", "0");
        }
        if (checkbox) checkbox.setAttribute("aria-checked", enable);
      }

      window.toggleDarkMode = function () {
        if (checkbox) setDark(!checkbox.checked);
      };

      if (checkbox) {
        checkbox.addEventListener("change", function (e) {
          setDark(e.target.checked);
        });
      }

      function init() {
        const saved = localStorage.getItem("darkMode");
        const enabled = saved === "1";
        if (checkbox) {
          checkbox.checked = enabled;
          setDark(enabled);
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>

</html>
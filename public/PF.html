<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Power Systems & P.F Correction</title>
    <link rel="stylesheet" href="PF.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
</head>

<body>
    <div class="logo-section">
        <h2>‚ö° Power Systems Micro Calculator</h2>

        <div class="header-buttons">
            <button class="btn-reset" onclick="resetForm()">Reset All</button>
            <button class="btn-reset btn-home" onclick="window.location.href='index.html'">
                ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
            </button>
        </div>
    </div>

    <div class="section-container">
        <div class="section-title">‚öôÔ∏è P.F Correction & Visualization</div>

        <div class="system-mode-container">
            <div class="input-group">
                <label>System Mode:</label>
                <select id="phase_mode" aria-label="System Mode" onchange="calculateCorrection()">
                    <option value="1">Single Phase (1Œ¶)</option>
                    <option value="3" selected>Three Phase (3Œ¶)</option>
                </select>
            </div>
            <button class="btn-equations" onclick="toggleEquations()">Formula Reference</button>
        </div>

        <div class="main-layout">
            <div class="controls-side">
                <div class="input-group"><label>MD.KW (Load)</label><input type="number" id="kwh_in" placeholder="100"
                        oninput="calculateCorrection()"></div>
                <div class="input-group"><label>Eff %</label><input type="number" id="eff_in" value="90"
                        oninput="calculateCorrection()"></div>
                <div class="input-group"><label>Voltage (V)</label><input type="number" id="v_in" value="400"
                        oninput="calculateCorrection()"></div>
                <div class="input-group"><label>Freq (Hz)</label><input type="number" id="hz_in" value="50"
                        oninput="calculateCorrection()"></div>
                <div class="input-group"><label>COS(œÜ) Current</label><input type="number" step="0.01" id="cos_old_in"
                        placeholder="0.75" oninput="calculateCorrection()"></div>
                <div class="input-group"><label>COS(œÜ) Target</label><input type="number" step="0.01" id="cos_new_in"
                        value="0.95" oninput="calculateCorrection()"></div>
            </div>

            <div class="plot-side">
                <div class="plot-container">
                    <svg id="powerTriangle" viewBox="0 0 500 400">
                        <defs>
                            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#f0f0f0" stroke-width="1" />
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#grid)" />

                        <line x1="60" y1="340" x2="460" y2="340" stroke="#95a5a6" stroke-width="2" />
                        <line x1="60" y1="40" x2="60" y2="340" stroke="#95a5a6" stroke-width="2" />

                        <polygon id="polyOld" points="60,340 60,340 60,340" fill="rgba(44, 62, 80, 0.08)"
                            stroke="#2c3e50" stroke-width="2" />
                        <polygon id="polyNew" points="60,340 60,340 60,340" fill="rgba(52, 152, 219, 0.15)"
                            stroke="#3498db" stroke-width="2" stroke-dasharray="5" />

                        <line id="qCapLine" x1="0" y1="0" x2="0" y2="0" stroke="#e74c3c" stroke-width="5" />

                        <text id="txtKW" class="svg-text-bold" fill="#2c3e50" text-anchor="middle"></text>
                        <text id="txtKVAOld" class="svg-text-small" fill="#2c3e50"></text>
                        <text id="txtKVANew" class="svg-text-small" fill="#3498db"></text>
                        <text id="txtQC" class="svg-text-bold" fill="#e74c3c"></text>

                        <text x="460" y="360" class="svg-text-small" text-anchor="end">Active Power (P)</text>
                        <text x="50" y="40" class="svg-text-small" transform="rotate(-90 50,40)">Reactive Power
                            (Q)</text>
                    </svg>
                </div>
            </div>

            <div class="results-side">
                <div class="result-mini"><span>kVA (Old)</span><input type="text" id="s_old_res" readonly></div>
                <div class="result-mini highlight"><span>kVA (New)</span><input type="text" id="s_new_res" readonly>
                </div>
                <div class="result-mini"><span>Amps (Old)</span><input type="text" id="amp_old_res" readonly></div>
                <div class="result-mini highlight"><span>Amps (New)</span><input type="text" id="amp_new_res" readonly>
                </div>
                <div class="result-mini penalty-border"><span>Qcomp (kVAR)</span><input type="text" id="q_cap_res"
                        readonly></div>
                <div class="result-mini active-power-border"><span>¬µF / Phase</span><input type="text" id="farad_ph_res"
                        readonly></div>
            </div>
        </div>
    </div>

    <div class="section-container">
        <div class="section-title">üìü P.F Penalty</div>
        <div class="input-dashboard">
            <div class="input-group"><label>Active Energy (kWh)</label>
                <div class="input-row"><input type="number" id="kwh_curr" placeholder="ÿßŸÑÿ≠ÿßŸÑŸâ"
                        oninput="calculateSystem()"><input type="number" id="kwh_prev" placeholder="ÿßŸÑÿ≥ÿßÿ®ŸÇ"
                        oninput="calculateSystem()"></div>
            </div>
            <div class="input-group"><label>Reactive Energy (kVARh)</label>
                <div class="input-row"><input type="number" id="kvarh_curr" placeholder="ÿßŸÑÿ≠ÿßŸÑŸâ"
                        oninput="calculateSystem()"><input type="number" id="kvarh_prev" placeholder="ÿßŸÑÿ≥ÿßÿ®ŸÇ"
                        oninput="calculateSystem()"></div>
            </div>
            <div class="input-group"><label>Tariff (EGP/kWh)</label>
                <select id="tariffpf" aria-label="Tariff" onchange="calculateSystem()">
                    <option value="2.34">ŸÇŸàŸâ ŸÖÿ≠ÿ±ŸÉÿ© (2.34)</option>
                    <option value="2.0">ÿ±Ÿä (2.0)</option>
                    <option value="1.5">ŸÉÿ®ÿßÿ± ŸÖÿ¥ÿ™ÿ±ŸÉŸäŸÜ (1.5)</option>
                </select>
            </div>
        </div>
        <div class="results-dashboard">
            <div class="result-item">
                <h3>ŸÖÿ™Ÿàÿ≥ÿ∑ ŸÖÿπÿßŸÖŸÑ ÿßŸÑŸÇÿØÿ±ÿ©</h3><input type="text" id="pf_penalty" class="val-large" readonly>
            </div>
            <div class="result-item penalty-border">
                <h3 class="text-accent">ÿ∫ÿ±ÿßŸÖÿ© ŸÖÿπÿßŸÖŸÑ ÿßŸÑŸÇÿØÿ±ÿ©</h3><input type="text" id="pf_charge"
                    class="val-large text-accent" readonly>
            </div>
        </div>
    </div>

    <div id="equationModal" class="modal">
        <div class="modal-content">
            <h3>Technical Equations</h3>
            <p><b>1. Active Power:</b> P = ‚àö3 √ó V √ó I √ó Cos(œÜ) / 1000 [kW]</p>
            <p><b>2. Compensation:</b> Qc = P √ó [tan(œÜ1) - tan(œÜ2)] [kVAR]</p>
            <p><b>3. Capacitance:</b> C = (Qc √ó 10‚Åπ) / (2œÄ √ó f √ó V¬≤) [¬µF]</p>
            <p><b>4. Avg P.F:</b> Cos(œÜ) = kWh / ‚àö(kWh¬≤ + kVARh¬≤)</p>
        </div>
    </div>

    <script>
        function calculateCorrection() {
            const kwLoad = parseFloat(document.getElementById("kwh_in").value) || 0;
            const eff = (parseFloat(document.getElementById("eff_in").value) || 100) / 100;
            const v = parseFloat(document.getElementById("v_in").value) || 0;
            const hz = parseFloat(document.getElementById("hz_in").value) || 50;
            const cos1 = parseFloat(document.getElementById("cos_old_in").value) || 0;
            const cos2 = parseFloat(document.getElementById("cos_new_in").value) || 0;
            const mode = document.getElementById("phase_mode").value;

            if (kwLoad > 0 && cos1 > 0 && cos2 > 0 && cos1 < 1) {
                const P = kwLoad / eff;
                const Q1 = P * Math.tan(Math.acos(cos1));
                const Q2 = P * Math.tan(Math.acos(cos2));
                const Qc = Math.max(0, Q1 - Q2);

                const s1 = P / cos1;
                const s2 = P / cos2;

                document.getElementById("s_old_res").value = s1.toFixed(1);
                document.getElementById("s_new_res").value = s2.toFixed(1);
                document.getElementById("q_cap_res").value = Qc.toFixed(1);

                let a1 = (mode === "3") ? (P * 1000) / (Math.sqrt(3) * v * cos1) : (P * 1000) / (v * cos1);
                let a2 = (mode === "3") ? (P * 1000) / (Math.sqrt(3) * v * cos2) : (P * 1000) / (v * cos2);
                document.getElementById("amp_old_res").value = a1.toFixed(1);
                document.getElementById("amp_new_res").value = a2.toFixed(1);

                const C = (Qc * 1000) / (2 * Math.PI * hz * v * v) * 1000000;
                document.getElementById("farad_ph_res").value = C.toFixed(1);

                updatePlot(P, Q1, Q2, s1, s2, Qc);
            }
        }

        function updatePlot(P, Q1, Q2, s1, s2, Qc) {
            const margin = 60;
            const chartW = 400;
            const chartH = 300;

            // Scaler to fit triangle in SVG
            const scale = (P === 0) ? 1 : Math.min(chartW / P, chartH / (Q1 || 1));

            const x0 = margin, y0 = 340;
            const xP = x0 + (P * scale);
            const y1 = y0 - (Q1 * scale);
            const y2 = y0 - (Q2 * scale);

            document.getElementById("polyOld").setAttribute("points", `${x0},${y0} ${xP},${y0} ${xP},${y1}`);
            document.getElementById("polyNew").setAttribute("points", `${x0},${y0} ${xP},${y0} ${xP},${y2}`);

            const qLine = document.getElementById("qCapLine");
            qLine.setAttribute("x1", xP); qLine.setAttribute("y1", y1);
            qLine.setAttribute("x2", xP); qLine.setAttribute("y2", y2);

            // Labels
            const tKW = document.getElementById("txtKW");
            tKW.setAttribute("x", (x0 + xP) / 2); tKW.setAttribute("y", y0 + 15);
            tKW.textContent = P > 0 ? P.toFixed(1) + " kW" : "";

            const tS1 = document.getElementById("txtKVAOld");
            tS1.setAttribute("x", (x0 + xP) / 2 - 20); tS1.setAttribute("y", (y0 + y1) / 2 - 10);
            tS1.textContent = s1 > 0 ? s1.toFixed(1) + " kVA" : "";

            const tS2 = document.getElementById("txtKVANew");
            tS2.setAttribute("x", (x0 + xP) / 2 - 10); tS2.setAttribute("y", (y0 + y2) / 2 + 15);
            tS2.textContent = s2 > 0 ? s2.toFixed(1) + " kVA" : "";

            const tQC = document.getElementById("txtQC");
            tQC.setAttribute("x", xP + 10); tQC.setAttribute("y", (y1 + y2) / 2);
            tQC.textContent = Qc > 0 ? Qc.toFixed(1) + " kVAR" : "";
        }

        function calculateSystem() {
            let kwh = (parseFloat(document.getElementById("kwh_curr").value) || 0) - (parseFloat(document.getElementById("kwh_prev").value) || 0);
            let kvarh = (parseFloat(document.getElementById("kvarh_curr").value) || 0) - (parseFloat(document.getElementById("kvarh_prev").value) || 0);
            let t = parseFloat(document.getElementById("tariffpf").value);

            if (kwh > 0) {
                let pf = kwh / Math.sqrt(kwh * kwh + kvarh * kvarh);
                document.getElementById("pf_penalty").value = pf.toFixed(3);
                let penalty = 0;
                if (pf < 0.92) {
                    let factor = (pf < 0.72) ? ((0.72 - pf) * 1 + 0.1) : (0.92 - pf) * 0.5;
                    penalty = factor * kwh * t;
                }
                document.getElementById("pf_charge").value = penalty.toLocaleString(undefined, { minimumFractionDigits: 2 });
            } else {
                document.getElementById("pf_penalty").value = "";
                document.getElementById("pf_charge").value = "";
            }
        }

        function toggleEquations() {
            document.getElementById("equationModal").style.display = "block";
        }

        window.onclick = function (event) {
            const modal = document.getElementById("equationModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function resetForm() {
            document.querySelectorAll('input').forEach(i => i.value = "");
            updatePlot(0, 0, 0, 0, 0, 0);
        }
    </script>
</body>

</html>

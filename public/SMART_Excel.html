<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>تصدير بيانات العدادات الذكية</title>
    <link rel="stylesheet" type="text/css" href="SMART_Excel.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <div class="table-header">
            <h2><i class="fas fa-chart-line"></i> نظام إدارة العدادات الذكية</h2>
            <div class="meta">
                <div>التاريخ: <strong id="printDate" class="meta-badge">—</strong></div>
                <div>آخر تحديث: <span id="lastUpdate">الآن</span></div>
            </div>
        </div>

        <div class="table-wrapper">
            <div id="rowCountLabel" class="row-count-label">
                <i class="fas fa-list-ol"></i> عدد السجلات: <span id="recordCount">0</span>
            </div>
            <div class="table-actions">
                <div class="search-box">
                    <input type="text" id="tableSearch" placeholder="بحث في الجدول...">
                    <i class="fas fa-search"></i>
                </div>

                <div class="export-buttons">
                    <button id="excelExportBtn" class="export-btn excel">
                        <i class="fas fa-file-excel"></i> تصدير إلى Excel
                    </button>
                </div>

                <h3><i class="fas fa-database"></i> إدارة البيانات</h3>
                <div class="export-buttons">
                    <button id="clearTableBtn" class="export-btn danger" type="button">
                        <i class="fas fa-trash-alt"></i> مسح الجدول
                    </button>
                </div>
            </div>

            <div class="pagination-container">
                <button id="prevBtn" class="btn-pagination" onclick="window.changePage(-1)">السابق</button>
                <span id="pageInfo">الصفحة 1 من 1</span>
                <button id="nextBtn" class="btn-pagination" onclick="window.changePage(1)">التالي</button>
            </div>

            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th><i class="fas fa-hashtag"></i> Serial Num</th>
                            <th><i class="fas fa-sim-card"></i> SIM S.Num</th>
                            <th><i class="fas fa-id-badge"></i> Badge Number</th>
                            <th><i class="fas fa-industry"></i> Manufacturer</th>
                            <th><i class="fas fa-cube"></i> Model</th>
                            <th><i class="fas fa-barcode"></i> EEHC Unified code</th>
                            <th><i class="fas fa-building"></i> Facility Description</th>
                            <th><i class="fas fa-bolt"></i> Disco</th>
                            <th><i class="fas fa-sitemap"></i> Disco Section</th>
                            <th><i class="fas fa-code-branch"></i> Disco Branch</th>
                            <th><i class="fas fa-map-marker-alt"></i> منطقة</th>
                            <th><i class="fas fa-exclamation-triangle"></i> Losses Area</th>
                            <th><i class="fas fa-cogs"></i> Device function</th>
                            <th><i class="fas fa-network-wired"></i> Distribution Facility</th>
                            <th><i class="fas fa-calendar-alt"></i> Installation Date</th>
                            <th><i class="fas fa-map-pin"></i> ADDRESS4</th>
                            <th><i class="fas fa-tag"></i> TYPE</th>
                            <th><i class="fas fa-globe-americas"></i> Latitude(y)</th>
                            <th><i class="fas fa-globe-asia"></i> Longitude(x)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- سيتم إضافة الصفوف ديناميكياً -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Summary Table -->
    <div class="summary-table-card">
        <div class="summary-table-header">
            <h3><i class="fas fa-chart-pie"></i> ملخص توزيع العدادات حسب القطاع والهندسة</h3>
            <div class="week-selector">
                <select id="weekFilter" class="week-select" aria-label="تصفية حسب الأسبوع">
                    <option value="all">جميع الأسابيع</option>
                    <option value="current">الأسبوع الحالي</option>
                    <option value="last">الأسبوع الماضي</option>
                    <option value="last2">ما قبل الأسبوع الماضي</option>
                </select>
                <button class="btn btn-outline" id="refreshTableBtn" type="button">
                    <i class="fas fa-redo"></i> تحديث
                </button>
                <button id="exportSummaryExcel" class="btn btn-outline btn-excel-summary" type="button">
                    <i class="fas fa-file-excel"></i> تصدير Excel
                </button>
            </div>
        </div>
        <div class="summary-table-wrapper">
            <table class="summary-table" id="summaryTable">
                <thead>
                    <tr>
                        <th>القطاع</th>
                        <th>الهندسة</th>
                        <th>A1</th>
                        <th>A2</th>
                        <th>A3</th>
                        <th>A4</th>
                        <th>A5</th>
                        <th>إجمالى</th>
                        <th>النسبة الأسبوعية</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody">
                    <!-- سيتم ملؤه ديناميكياً -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="pageOverlay">
        <div id="loadingSpinner"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABeLySOk_10XjaHSUjkfnR8f3HSTFkEYU",
            authDomain: "ndedc-smartmeter.firebaseapp.com",
            projectId: "ndedc-smartmeter",
            storageBucket: "ndedc-smartmeter.appspot.com",
            messagingSenderId: "557422247352",
            appId: "1:557422247352:web:824d4f96affd7bbb0fa34d",
            measurementId: "G-3DCP87C92Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        console.log("Firebase initialized successfully!");

        // عناصر DOM
        let tbody = document.querySelector("#tableBody");
        const recordCountSpan = document.getElementById("recordCount");
        const excelExportBtn = document.getElementById("excelExportBtn");
        const clearTableBtn = document.getElementById("clearTableBtn");
        const tableSearch = document.getElementById("tableSearch");
        const lastUpdateSpan = document.getElementById("lastUpdate");
        const exportSummaryExcel = document.getElementById("exportSummaryExcel");
        const refreshTableBtn = document.getElementById("refreshTableBtn");
        const weekFilter = document.getElementById("weekFilter");

        // متغيرات لتخزين البيانات
        let allMeterData = [];
        let summaryData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 15;

        // ========== دوال المساعدة ==========
        function showNotification(message, type = "success") {
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(notif => notif.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        function disablePage() {
            document.getElementById("pageOverlay").style.display = "flex";
        }

        function enablePage() {
            document.getElementById("pageOverlay").style.display = "none";
        }

        function updateRowCount() {
            if (!tbody) return;
            recordCountSpan.textContent = filteredData.length;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG');
            lastUpdateSpan.textContent = timeString;
        }

        function getTableData() {
            // Use filteredData instead of scraping DOM
            const headers = [
                'Serial Num', 'SIM S.Num', 'Badge Number', 'Manufacturer', 'Model',
                'EEHC Unified code', 'Facility Description', 'Disco', 'Disco Section',
                'Disco Branch', 'منطقة', 'Losses Area', 'Device function',
                'Distribution Facility (EEHC unified code)', 'Installation Date',
                'ADDRESS4', 'TYPE', 'Latitude(y)', 'Longitude(x)'
            ];

            return filteredData.map(data => {
                const rowData = {};
                rowData['Serial Num'] = data.serial || "";
                rowData['SIM S.Num'] = data.sim || "";
                rowData['Badge Number'] = data.badge || "";
                rowData['Manufacturer'] = data.manuf || "";
                rowData['Model'] = data.model || "";
                rowData['EEHC Unified code'] = data.code1 || "";
                rowData['Facility Description'] = data.facDesc || "";
                rowData['Disco'] = data.disco || "";
                rowData['Disco Section'] = data.discoSec || "";
                rowData['Disco Branch'] = data.discoBranch || "";
                rowData['منطقة'] = data.area || "";
                rowData['Losses Area'] = data.lossArea || "";
                rowData['Device function'] = data.devFunc || "";
                rowData['Distribution Facility (EEHC unified code)'] = data.distFac || "";
                rowData['Installation Date'] = data.installDate || "";
                rowData['ADDRESS4'] = data.addr4 || "";
                rowData['TYPE'] = data.type || "";
                rowData['Latitude(y)'] = data.lat || "";
                rowData['Longitude(x)'] = data.lon || "";
                return rowData;
            });
        }

        function filterTable(searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredData = allMeterData.filter(item => {
                return Object.values(item).some(val =>
                    String(val).toLowerCase().includes(term)
                );
            });
            currentPage = 1;
            renderTable();
            updateRowCount();
            return filteredData.length;
        }

        function copyTableToClipboard() {
            const data = getTableData();
            if (data.length === 0) {
                showNotification('لا توجد بيانات للنسخ', 'warning');
                return;
            }

            const headers = Object.keys(data[0]);
            let csvContent = headers.join('\t') + '\n';

            data.forEach(row => {
                const rowValues = headers.map(header => row[header] || '');
                csvContent += rowValues.join('\t') + '\n';
            });

            navigator.clipboard.writeText(csvContent)
                .then(() => showNotification('تم نسخ الجدول إلى الحافظة', 'success'))
                .catch(() => showNotification('فشل نسخ الجدول', 'error'));
        }

        // ========== دوال التصدير الرئيسية ==========
        function exportToExcel() {
            const data = getTableData();

            if (data.length === 0) {
                showNotification('لا توجد بيانات للتصدير', 'warning');
                return;
            }

            try {
                disablePage();

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Smart Meters');

                const wscols = [
                    { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 12 },
                    { wch: 18 }, { wch: 25 }, { wch: 12 }, { wch: 15 }, { wch: 15 },
                    { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 25 }, { wch: 15 },
                    { wch: 20 }, { wch: 10 }, { wch: 12 }, { wch: 12 }
                ];
                worksheet['!cols'] = wscols;

                const date = new Date();
                const fileName = `العدادات_الذكية_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.xlsx`;

                XLSX.writeFile(workbook, fileName);
                showNotification(`تم تصدير ${data.length} سجل إلى Excel`, 'success');
                updateLastUpdateTime();

            } catch (error) {
                showNotification(`خطأ في التصدير: ${error.message}`, 'error');
            } finally {
                enablePage();
            }
        }

        function exportToCSV() {
            const data = getTableData();

            if (data.length === 0) {
                showNotification('لا توجد بيانات للتصدير', 'warning');
                return;
            }

            try {
                disablePage();

                const headers = Object.keys(data[0]);
                let csvContent = '\uFEFF';
                csvContent += headers.join(';') + '\n';

                data.forEach(row => {
                    const rowValues = headers.map(header => {
                        let value = row[header] || '';
                        if (value.includes(';') || value.includes('"') || value.includes('\n')) {
                            value = `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    });
                    csvContent += rowValues.join(';') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const date = new Date();
                const fileName = `العدادات_الذكية_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.csv`;

                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => URL.revokeObjectURL(url), 100);
                showNotification(`تم تصدير ${data.length} سجل إلى CSV`, 'success');
                updateLastUpdateTime();

            } catch (error) {
                showNotification(`خطأ في التصدير: ${error.message}`, 'error');
            } finally {
                enablePage();
            }
        }

        function getWeekCategory(dateString) {
            if (!dateString) return 'unknown';

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'unknown';

            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
            const threeWeeksAgo = new Date(now.getTime() - 21 * 24 * 60 * 60 * 1000);

            if (date >= oneWeekAgo) return 'current';
            if (date >= twoWeeksAgo) return 'last';
            if (date >= threeWeeksAgo) return 'last2';
            return 'older';
        }

        function getStatus(total) {
            if (total > 100) return '<span class="status-active">نشط</span>';
            if (total > 50) return '<span class="status-warning">متوسط</span>';
            return '<span class="status-inactive">ضعيف</span>';
        }

        // ========== دالة لتحميل وملء جدول الملخص ==========
        async function loadAndProcessSummaryData() {
            try {
                disablePage();

                const snapshot = await get(ref(db, "SMART"));

                if (!snapshot.exists()) {
                    showNotification('لا توجد بيانات في قاعدة البيانات', 'warning');
                    return;
                }

                // معالجة البيانات لجدول الملخص
                const summaryMap = new Map();
                let totalA1 = 0, totalA2 = 0, totalA3 = 0, totalA4 = 0, totalA5 = 0;

                snapshot.forEach(childSnap => {
                    const data = childSnap.val();
                    const discoSec = data.discoSec || 'غير محدد';
                    const area = data.discoBranch || 'غير محدد';
                    const installDate = data.installDate || '';

                    // تصنيف حسب الأسبوع
                    const weekCategory = getWeekCategory(installDate);
                    const weekFilterValue = weekFilter.value;

                    if (weekFilterValue !== 'all' && weekCategory !== weekFilterValue) {
                        return; // تخطي البيانات التي لا تطابق الفلتر
                    }

                    const key = `${discoSec}-${area}`;

                    if (!summaryMap.has(key)) {
                        summaryMap.set(key, {
                            discoSec: discoSec,
                            area: area,
                            A1: 0,
                            A2: 0,
                            A3: 0,
                            A4: 0,
                            A5: 0,
                            total: 0
                        });
                    }

                    const summary = summaryMap.get(key);

                    // توزيع العدادات حسب نوع المنطقة
                    const lossArea = data.type || '';

                    // التحقق من القيم بشكل دقيق
                    if (lossArea.includes('A1') || lossArea === 'A1') {
                        summary.A1++;
                        totalA1++;
                    } else if (lossArea.includes('A2') || lossArea === 'A2') {
                        summary.A2++;
                        totalA2++;
                    } else if (lossArea.includes('A3') || lossArea === 'A3') {
                        summary.A3++;
                        totalA3++;
                    } else if (lossArea.includes('A4') || lossArea === 'A4') {
                        summary.A4++;
                        totalA4++;
                    } else if (lossArea.includes('A5') || lossArea === 'A5') {
                        summary.A5++;
                        totalA5++;
                    } else {
                        // إذا لم يكن هناك تطابق، ضعه في A1 كافتراضي
                        summary.A1++;
                        totalA1++;
                    }

                    summary.total = summary.A1 + summary.A2 + summary.A3 + summary.A4 + summary.A5;
                });

                // تحويل الماب إلى مصفوفة
                summaryData = Array.from(summaryMap.values());

                // حساب الإجماليات الكلية
                const grandTotal = totalA1 + totalA2 + totalA3 + totalA4 + totalA5;

                // حساب النسب لكل صف
                summaryData.forEach(item => {
                    // النسبة لكل عمود بالنسبة للإجمالي الكلي
                    item.A1Percentage = totalA1 > 0 ? ((item.A1 / totalA1) * 100).toFixed(2) + '%' : '0%';
                    item.A2Percentage = totalA2 > 0 ? ((item.A2 / totalA2) * 100).toFixed(2) + '%' : '0%';
                    item.A3Percentage = totalA3 > 0 ? ((item.A3 / totalA3) * 100).toFixed(2) + '%' : '0%';
                    item.A4Percentage = totalA4 > 0 ? ((item.A4 / totalA4) * 100).toFixed(2) + '%' : '0%';
                    item.A5Percentage = totalA5 > 0 ? ((item.A5 / totalA5) * 100).toFixed(2) + '%' : '0%';

                    // النسبة الإجمالية للصف
                    item.rowPercentage = grandTotal > 0 ? ((item.total / grandTotal) * 100).toFixed(2) + '%' : '0%';

                    item.status = getStatus(item.total);
                });

                // إضافة صف الإجماليات
                const totalsRow = {
                    discoSec: '<strong>الإجمالي</strong>',
                    area: '<strong>-</strong>',
                    A1: totalA1,
                    A2: totalA2,
                    A3: totalA3,
                    A4: totalA4,
                    A5: totalA5,
                    total: grandTotal,
                    A1Percentage: '100%',
                    A2Percentage: '100%',
                    A3Percentage: '100%',
                    A4Percentage: '100%',
                    A5Percentage: '100%',
                    rowPercentage: '100%',
                    status: '<strong>المجموع</strong>',
                    isTotal: true
                };

                summaryData.push(totalsRow);

                // ترتيب البيانات حسب القطاع
                summaryData.sort((a, b) => {
                    if (a.isTotal && !b.isTotal) return 1;
                    if (!a.isTotal && b.isTotal) return -1;
                    if (a.discoSec === b.discoSec) {
                        return a.area.localeCompare(b.area);
                    }
                    return a.discoSec.localeCompare(b.discoSec);
                });

                // ملء جدول الملخص
                fillSummaryTable();

                showNotification(`تم معالجة ${summaryMap.size} سجل في الملخص | الإجمالي: ${grandTotal} عداد`, 'success');

            } catch (error) {
                showNotification(`خطأ في معالجة بيانات الملخص: ${error.message}`, 'error');
                console.error(error);
            } finally {
                enablePage();
            }
        }

        // تحديث دالة ملء الجدول لإظهار النسب
        function fillSummaryTable() {
            const summaryBody = document.getElementById('summaryTableBody');
            summaryBody.innerHTML = '';

            if (summaryData.length === 0) {
                summaryBody.innerHTML = `
                <tr>
                    <td colspan="10" style="text-align: center; padding: 30px; color: #7f8c8d;">
                        <i class="fas fa-database" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                        لا توجد بيانات متاحة للملخص
                    </td>
                </tr>
            `;
                return;
            }

            summaryData.forEach((item, index) => {
                const row = document.createElement('tr');

                if (item.isTotal) {
                    row.style.backgroundColor = '#f8f9fa';
                    row.style.fontWeight = 'bold';
                    row.style.borderTop = '3px solid #3498db';

                    row.innerHTML = `
                    <td style="color: #2c3e50;">${item.discoSec}</td>
                    <td style="color: #2c3e50;">${item.area}</td>
                    <td style="color: #2c3e50;">
                        ${item.A1}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A1Percentage}</small>
                    </td>
                    <td style="color: #2c3e50;">
                        ${item.A2}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A2Percentage}</small>
                    </td>
                    <td style="color: #2c3e50;">
                        ${item.A3}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A3Percentage}</small>
                    </td>
                    <td style="color: #2c3e50;">
                        ${item.A4}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A4Percentage}</small>
                    </td>
                    <td style="color: #2c3e50;">
                        ${item.A5}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A5Percentage}</small>
                    </td>
                    <td style="color: #2c3e50;">
                        ${item.total}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.rowPercentage}</small>
                    </td>
                    <td style="color: #2c3e50;">${item.rowPercentage}</td>
                    <td style="color: #2c3e50;">${item.status}</td>
                `;
                } else {
                    row.innerHTML = `
                    <td>${item.discoSec}</td>
                    <td>${item.area}</td>
                    <td>
                        ${item.A1}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A1Percentage}</small>
                    </td>
                    <td>
                        ${item.A2}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A2Percentage}</small>
                    </td>
                    <td>
                        ${item.A3}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A3Percentage}</small>
                    </td>
                    <td>
                        ${item.A4}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A4Percentage}</small>
                    </td>
                    <td>
                        ${item.A5}<br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.A5Percentage}</small>
                    </td>
                    <td>
                        <strong>${item.total}</strong><br>
                        <small style="color: #7f8c8d; font-size: 0.8em;">${item.rowPercentage}</small>
                    </td>
                    <td>${item.rowPercentage}</td>
                    <td>${item.status}</td>
                `;
                }

                summaryBody.appendChild(row);
            });
        }

        // ========== دالة لتصدير جدول الملخص إلى Excel ==========
        function exportSummaryToExcel() {
            if (summaryData.length === 0) {
                showNotification('لا توجد بيانات في جدول الملخص للتصدير', 'warning');
                return;
            }

            try {
                disablePage();

                // تحويل البيانات لشكل مناسب للتصدير (دون صف الإجماليات)
                const exportData = summaryData
                    .filter(item => !item.isTotal)
                    .map(item => ({
                        'القطاع': item.discoSec,
                        'الهندسة': item.area,
                        'A1 العدد': item.A1,
                        'A1 النسبة %': item.A1Percentage,
                        'A2 العدد': item.A2,
                        'A2 النسبة %': item.A2Percentage,
                        'A3 العدد': item.A3,
                        'A3 النسبة %': item.A3Percentage,
                        'A4 العدد': item.A4,
                        'A4 النسبة %': item.A4Percentage,
                        'A5 العدد': item.A5,
                        'A5 النسبة %': item.A5Percentage,
                        'الإجمالي': item.total,
                        'النسبة الإجمالية %': item.rowPercentage,
                        'الحالة': item.status.replace(/<[^>]*>/g, '')
                    }));

                // إضافة صف الإجماليات
                const totalsRow = summaryData.find(item => item.isTotal);
                if (totalsRow) {
                    exportData.push({
                        'القطاع': 'الإجمالي',
                        'الهندسة': '-',
                        'A1 العدد': totalsRow.A1,
                        'A1 النسبة %': '100%',
                        'A2 العدد': totalsRow.A2,
                        'A2 النسبة %': '100%',
                        'A3 العدد': totalsRow.A3,
                        'A3 النسبة %': '100%',
                        'A4 العدد': totalsRow.A4,
                        'A4 النسبة %': '100%',
                        'A5 العدد': totalsRow.A5,
                        'A5 النسبة %': '100%',
                        'الإجمالي': totalsRow.total,
                        'النسبة الإجمالية %': '100%',
                        'الحالة': 'المجموع'
                    });
                }

                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'ملخص العدادات');

                const wscols = [
                    { wch: 20 }, { wch: 20 }, { wch: 10 }, { wch: 12 },
                    { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 12 },
                    { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 12 },
                    { wch: 12 }, { wch: 15 }, { wch: 15 }
                ];
                worksheet['!cols'] = wscols;

                const date = new Date();
                const fileName = `ملخص_العدادات_${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}.xlsx`;

                XLSX.writeFile(workbook, fileName);
                showNotification(`تم تصدير ${summaryData.length - 1} سجل ملخص إلى Excel`, 'success');

            } catch (error) {
                showNotification(`خطأ في تصدير الملخص: ${error.message}`, 'error');
            } finally {
                enablePage();
            }
        }

        // ========== دوال Firebase للجدول الرئيسي ==========
        async function loadDataFromFirebase() {
            try {
                disablePage();

                const snapshot = await get(ref(db, "SMART"));

                if (!snapshot.exists()) {
                    showNotification('لا توجد بيانات في قاعدة البيانات', 'warning');
                    enablePage();
                    return;
                }

                tbody.innerHTML = '';
                allMeterData = [];

                snapshot.forEach(childSnap => {
                    const data = childSnap.val();
                    allMeterData.push(data); // تخزين البيانات للمعالجة اللاحقة
                });

                filteredData = [...allMeterData];
                renderTable();
                updateRowCount();
                updateLastUpdateTime();
                showNotification(`تم تحميل ${allMeterData.length} سجل من قاعدة البيانات`, 'success');

                // تحميل بيانات الملخص بعد تحميل البيانات الرئيسية
                await loadAndProcessSummaryData();

            } catch (error) {
                showNotification(`خطأ في التحميل: ${error.message}`, 'error');
            } finally {
                enablePage();
            }
        }

        function clearTable() {
            if (!confirm('هل أنت متأكد من مسح جميع البيانات من الجدول؟')) {
                return;
            }

            tbody.innerHTML = '';
            summaryData = [];
            allMeterData = [];
            filteredData = [];
            document.getElementById('summaryTableBody').innerHTML = '';
            updateRowCount();
            renderTable();
            showNotification('تم مسح الجدول بنجاح', 'success');
        }

        function renderTable() {
            tbody.innerHTML = '';

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            pageData.forEach(data => {
                const tr = document.createElement('tr');
                const values = [
                    data.serial || "",
                    data.sim || "",
                    data.badge || "",
                    data.manuf || "",
                    data.model || "",
                    data.code1 || "",
                    data.facDesc || "",
                    data.disco || "",
                    data.discoSec || "",
                    data.discoBranch || "",
                    data.area || "",
                    data.lossArea || "",
                    data.devFunc || "",
                    data.distFac || "",
                    data.installDate || "",
                    data.addr4 || "",
                    data.type || "",
                    data.lat || "",
                    data.lon || ""
                ];

                values.forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.max(1, Math.ceil(filteredData.length / rowsPerPage));
            document.getElementById('pageInfo').textContent = `الصفحة ${currentPage} من ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        window.changePage = (dir) => {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const newPage = currentPage + dir;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        };

        // ========== Event Listeners ==========
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById("printDate").textContent =
                `${today.getFullYear()}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getDate().toString().padStart(2, '0')}`;

            updateRowCount();
            updateLastUpdateTime();

            tableSearch.addEventListener('input', (e) => {
                const visibleCount = filterTable(e.target.value);
                if (e.target.value) {
                    showNotification(`عُثر على ${visibleCount} نتيجة`, 'info');
                }
            });

            showNotification('تم تحميل النظام بنجاح', 'success');

            // تحميل البيانات عند فتح الصفحة
            loadDataFromFirebase().catch(console.error);
        });

        // Event Listeners للأزرار
        excelExportBtn.addEventListener('click', exportToExcel);
        clearTableBtn.addEventListener('click', clearTable);
        exportSummaryExcel.addEventListener('click', exportSummaryToExcel);
        refreshTableBtn.addEventListener('click', loadAndProcessSummaryData);
        weekFilter.addEventListener('change', loadAndProcessSummaryData);

        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadDataFromFirebase().catch(error => {
                console.error('خطأ في التحديث التلقائي:', error);
            });
        }, 300000);


    </script>

</body>

</html>
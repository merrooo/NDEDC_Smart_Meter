<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø£Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯</title>
  <link rel="stylesheet" type="text/css" href="SMART_Added_Mod.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>
  <div id="pageOverlay">
    <div id="loadingSpinner"></div>
  </div>

  <div class="table-header">
    <h2>Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h2>
    <div class="meta">
      <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <strong id="printDate">â€”</strong></div>
      <div>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>
  </div>

  <div class="wrapper">
    <div class="sidebar">

      <div class="controls">
        <h4>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</h4>
        <button type="button" id="addRowBtn" class="btn-success">â• Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯</button>
        <button type="button" id="saveNewBtn" class="btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>

        <div class="action-buttons">
          <button type="button" id="searchBtn" class="btn-primary">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø§Ø¯</button>
          <button type="button" id="updateBtn" class="btn-warning">âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯</button>
          <button type="button" id="deleteBtn" class="btn-danger">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯</button>
          <div class="controls">
            <h4>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø§Ø¯</h4>
            <input type="text" id="searchInput" placeholder="Ø£Ø¯Ø®Ù„ Serial Ù„Ù„Ø¨Ø­Ø«...">
          </div>

        </div>
      </div>

      <div id="rowCountLabel" class="row-count-label">
        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
      </div>
    </div>

    <div class="table-wrapper">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Serial Num</th>
            <th>SIM S.Num</th>
            <th>Badge Number</th>
            <th>Manufacturer</th>
            <th>Model</th>
            <th>EEHC Unified code</th>
            <th>Facility Description</th>
            <th>Disco</th>
            <th>Disco Section</th>
            <th>Disco Branch</th>
            <th>Ù…Ù†Ø·Ù‚Ø©</th>
            <th>Losses Area</th>
            <th>Device function</th>
            <th>Distribution Facility (EEHC unified code)</th>
            <th>Installation Date</th>
            <th>ADDRESS4</th>
            <th>TYPE</th>
            <th>Latitude(Y-North)</th>
            <th>Longitude(X-Est)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, set, get, remove, onValue, update, child }
      from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyABeLySOk_10XjaHSUjkfnR8f3HSTFkEYU",
      authDomain: "ndedc-smartmeter.firebaseapp.com",
      projectId: "ndedc-smartmeter",
      storageBucket: "ndedc-smartmeter.appspot.com",
      messagingSenderId: "557422247352",
      appId: "1:557422247352:web:824d4f96affd7bbb0fa34d",
      measurementId: "G-3DCP87C92Y"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    console.log("ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ù†Ø¬Ø§Ø­!");

    // ---- Ø§Ù„Ø¹Ù†Ø§ØµØ± ----
    const tbody = document.querySelector("#dataTable tbody");
    const addRowBtn = document.getElementById("addRowBtn");
    const saveNewBtn = document.getElementById("saveNewBtn");
    const searchBtn = document.getElementById("searchBtn");
    const updateBtn = document.getElementById("updateBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const searchInput = document.getElementById("searchInput");
    const printDateEl = document.getElementById("printDate");

    // ---- Ø§Ù„ØªØ§Ø±ÙŠØ® ----
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    printDateEl.textContent = `${yyyy}-${mm}-${dd}`;

    // ---- Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ----
    const FIELD_KEYS = [
      "serial", "sim", "badge", "manuf", "model", "code1", "facDesc",
      "disco", "discoSec", "discoBranch", "area", "lossArea", "devFunc",
      "distFac", "installDate", "addr4", "type", "lat", "lon"
    ];

    let currentMeter = null;
    let isNewMeter = false;

    // ---- Ø¥Ù†Ø´Ø§Ø¡ ØµÙ ÙØ§Ø±Øº ----
    function createEmptyRow() {
      tbody.innerHTML = '';
      const tr = tbody.insertRow();
      tr.id = "currentMeterRow";

      FIELD_KEYS.forEach((key) => {
        const td = tr.insertCell();
        td.contentEditable = true;
        td.setAttribute("tabindex", "0");
        td.textContent = "";
        td.className = `cell-${key}`;

        // Ø¥Ø¶Ø§ÙØ© placeholder
        const placeholder = getPlaceholder(key);
        td.setAttribute("data-placeholder", placeholder);

        // Ø¹Ø±Ø¶ placeholder Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ²
        td.addEventListener('focus', function () {
          if (this.textContent === '') {
            this.textContent = this.getAttribute('data-placeholder');
            this.style.color = '#95a5a6';
          }
        });

        td.addEventListener('blur', function () {
          if (this.textContent === this.getAttribute('data-placeholder')) {
            this.textContent = '';
            this.style.color = '#333';
          }
        });
      });

      return tr;
    }

    // ---- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ placeholder ----
    function getPlaceholder(field) {
      const placeholders = {
        "serial": "Ù…Ø«Ø§Ù„: SMT-2024-001",
        "sim": "Ù…Ø«Ø§Ù„: 01001234567",
        "badge": "Ù…Ø«Ø§Ù„: PO: 50/2024/2025",
        "manuf": "Ù…Ø«Ø§Ù„: ESMC",
        "model": "Ù…Ø«Ø§Ù„: CL730D22H",
        "code1": "Ù…Ø«Ø§Ù„: EEHC-001",
        "facDesc": "ÙˆØµÙ Ø§Ù„Ù…Ø±ÙÙ‚",
        "disco": "Ù…Ø«Ø§Ù„: NDEDC",
        "discoSec": "Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ",
        "discoBranch": "Ù…Ø«Ø§Ù„: Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ",
        "area": "Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©",
        "lossArea": "Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙÙ‚Ø¯",
        "devFunc": "Ù…Ø«Ø§Ù„: Transformer",
        "distFac": "ÙƒÙˆØ¯ Ù…Ø±ÙÙ‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹",
        "installDate": `${yyyy}-${mm}-${dd}`,
        "addr4": "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†",
        "type": "Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯",
        "lat": "Ù…Ø«Ø§Ù„: 30.0444",
        "lon": "Ù…Ø«Ø§Ù„: 31.2357"
      };
      return placeholders[field] || "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§";
    }

    // ---- Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯ ----
    function displayMeterData(meterData) {
      const tr = createEmptyRow();
      currentMeter = meterData;
      isNewMeter = false;
      saveNewBtn.style.display = 'none';

      FIELD_KEYS.forEach((key, index) => {
        const td = tr.cells[index];
        td.textContent = meterData[key] || "";
        td.style.color = '#333';
      });
    }

    // ---- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ----
    function getDataFromTable() {
      const tr = document.getElementById("currentMeterRow");
      if (!tr) return null;

      const data = {};
      FIELD_KEYS.forEach((key, index) => {
        const cellContent = tr.cells[index].textContent;
        const placeholder = getPlaceholder(key);

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ³Ø§ÙˆÙŠ placeholderØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ ÙØ§Ø±ØºØ§Ù‹
        data[key] = (cellContent === placeholder) ? "" : cellContent.trim();
      });
      return data;
    }

    // ---- Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯ ----
    addRowBtn.addEventListener("click", () => {
      createEmptyRow();
      isNewMeter = true;
      saveNewBtn.style.display = 'block';
      updateBtn.style.display = 'none';

      // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      const tr = document.getElementById("currentMeterRow");
      tr.cells[14].textContent = `${yyyy}-${mm}-${dd}`;
      tr.cells[2].textContent = "PO: 50/2024/2025";
      tr.cells[3].textContent = "ESMC";
      tr.cells[4].textContent = "CL730D22H";
      tr.cells[7].textContent = "NDEDC";
      tr.cells[12].textContent = "Transformer";

      tr.cells[0].focus();
      updateRowCount("Ø¬Ø¯ÙŠØ¯", "warning");
    });

    // ---- Ø­ÙØ¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ----
    saveNewBtn.addEventListener("click", async () => {
      const meterData = getDataFromTable();
      if (!meterData) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¯Ø§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡");
        return;
      }

      const serial = meterData.serial.trim();
      if (!serial) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ");
        const tr = document.getElementById("currentMeterRow");
        tr.cells[0].focus();
        return;
      }

      disablePage();

      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const snapshot = await get(ref(db, `SMART/${serial}`));

        if (snapshot.exists()) {
          alert("âš ï¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ");
          enablePage();
          return;
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        await set(ref(db, `SMART/${serial}`), meterData);
        alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¯Ø§Ø¯ ${serial} Ø¨Ù†Ø¬Ø§Ø­`);

        // ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù…ÙˆØ¬ÙˆØ¯
        isNewMeter = false;
        saveNewBtn.style.display = 'none';
        updateBtn.style.display = 'block';
        currentMeter = meterData;

      } catch (error) {
        console.error(error);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
      } finally {
        enablePage();
      }
    });

    searchBtn.addEventListener("click", async () => {
      const query = searchInput.value.trim();

      if (!query) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ Ù„Ù„Ø¨Ø­Ø«");
        searchInput.focus();
        return;
      }

      disablePage();

      try {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const snapshot = await get(ref(db, 'SMART'));

        if (snapshot.exists()) {
          const allMeters = snapshot.val();
          let foundMeter = null;
          let foundKey = null;

          // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ
          for (const key in allMeters) {
            if (key === query || allMeters[key]?.serial === query) {
              foundMeter = allMeters[key];
              foundKey = key;
              break;
            }
          }

          if (foundMeter) {
            displayMeterData(foundMeter);
            isNewMeter = false;
            saveNewBtn.style.display = 'none';
            updateBtn.style.display = 'block';
            updateRowCount("Ù…ÙˆØ¬ÙˆØ¯", "success");
            searchInput.value = foundKey; // Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡
          } else {
            tbody.innerHTML = `
          <tr>
            <td colspan="19" class="empty-state">
              ğŸ” Ø§Ù„Ø¹Ø¯Ø§Ø¯ ${query} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
              <br>
              <small style="color: #95a5a6; margin-top: 10px; display: block;">
                ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯"
              </small>
            </td>
          </tr>
        `;
            currentMeter = null;
            updateRowCount("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", "danger");
          }
        } else {
          tbody.innerHTML = `
        <tr>
          <td colspan="19" class="empty-state">
            ğŸ“­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©
            <br>
            <small style="color: #95a5a6; margin-top: 10px; display: block;">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯
            </small>
          </td>
        </tr>
      `;
          updateRowCount("ÙØ§Ø±ØºØ©", "warning");
        }

      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      } finally {
        enablePage();
      }
    });

    // ---- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ----
    updateBtn.addEventListener("click", async () => {
      const meterData = getDataFromTable();
      if (!meterData) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¯Ø§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡");
        return;
      }

      const newSerial = meterData.serial.trim();
      if (!newSerial) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ");
        const tr = document.getElementById("currentMeterRow");
        tr.cells[0].focus();
        return;
      }

      disablePage();

      try {
        const oldSerial = currentMeter ? currentMeter.serial : null;

        // Check if serial number has changed
        if (oldSerial && oldSerial !== newSerial) {
          // Check if the new serial already exists
          const snapshot = await get(ref(db, `SMART/${newSerial}`));
          if (snapshot.exists()) {
            if (!confirm(`Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø±Ù‚Ù… ${newSerial} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙˆØ­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ${oldSerial}ØŸ`)) {
              enablePage();
              return;
            }
          } else {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ù…Ù† ${oldSerial} Ø¥Ù„Ù‰ ${newSerial}ØŸ`)) {
              enablePage();
              return;
            }
          }

          // Save new entry
          await set(ref(db, `SMART/${newSerial}`), meterData);
          // Delete old entry
          await remove(ref(db, `SMART/${oldSerial}`));

          alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­`);
        } else {
          // Standard update
          const snapshot = await get(ref(db, `SMART/${newSerial}`));
          if (!snapshot.exists()) {
            if (!confirm("Ø§Ù„Ø¹Ø¯Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒØ¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯ØŸ")) {
              enablePage();
              return;
            }
          }
          await set(ref(db, `SMART/${newSerial}`), meterData);
          alert(`âœ… ØªÙ… ${snapshot.exists() ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø¥Ø¶Ø§ÙØ©'} Ø§Ù„Ø¹Ø¯Ø§Ø¯ ${newSerial} Ø¨Ù†Ø¬Ø§Ø­`);
        }

        currentMeter = meterData;

      } catch (error) {
        console.error(error);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
      } finally {
        enablePage();
      }
    });

    // ---- Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ ----
    deleteBtn.addEventListener("click", async () => {
      const meterData = getDataFromTable();
      if (!meterData) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¯Ø§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡");
        return;
      }

      const serial = meterData.serial.trim();
      if (!serial) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ Ù„Ù„Ø­Ø°Ù");
        const tr = document.getElementById("currentMeterRow");
        tr.cells[0].focus();
        return;
      }

      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ ${serial}ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.`)) {
        return;
      }

      disablePage();

      try {
        const snapshot = await get(ref(db, `SMART/${serial}`));

        if (!snapshot.exists()) {
          alert("âš ï¸ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          enablePage();
          return;
        }

        await remove(ref(db, `SMART/${serial}`));

        tbody.innerHTML = '';
        currentMeter = null;
        isNewMeter = false;
        saveNewBtn.style.display = 'none';

        alert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ ${serial} Ø¨Ù†Ø¬Ø§Ø­`);
        updateRowCount("Ù…Ø­Ø°ÙˆÙ", "danger");

      } catch (error) {
        console.error(error);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
      } finally {
        enablePage();
      }
    });

    // ---- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© ----
    searchInput.addEventListener("input", async () => {
      const query = searchInput.value.trim();

      if (query.length >= 3) {
        disablePage();

        try {
          const snapshot = await get(ref(db, `SMART/${query}`));

          if (snapshot.exists()) {
            const meterData = snapshot.val();
            displayMeterData(meterData);
            isNewMeter = false;
            saveNewBtn.style.display = 'none';
            updateBtn.style.display = 'block';
            updateRowCount("Ù…ÙˆØ¬ÙˆØ¯", "success");
          }
        } catch (error) {
          console.error(error);
        } finally {
          enablePage();
        }
      } else if (!query) {
        tbody.innerHTML = '';
        currentMeter = null;
        updateRowCount("Ø¬Ø§Ù‡Ø²", "info");
      }
    });

    // ---- ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙÙˆÙ ----
    function updateRowCount(status, type) {
      const label = document.getElementById("rowCountLabel");
      const colors = {
        "success": "#27ae60",
        "warning": "#f39c12",
        "danger": "#e74c3c",
        "info": "#3498db"
      };

      label.textContent = `Ø§Ù„Ø­Ø§Ù„Ø©: ${status}`;
      label.style.color = colors[type] || "#7f8c8d";
    }

    // ---- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„ ----
    function disablePage() {
      document.getElementById("pageOverlay").style.display = "flex";
    }

    function enablePage() {
      document.getElementById("pageOverlay").style.display = "none";
    }

    // ---- Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ----
    window.addEventListener("DOMContentLoaded", () => {
      tbody.innerHTML = `
        <tr>
          <td colspan="19" class="empty-state">
            âš¡ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¯Ø§Ø¯ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ø¹Ø¯Ø§Ø¯Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹
            <br>
            <small style="color: #95a5a6; margin-top: 10px; display: block;">
              Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø¬Ø¯ÙŠØ¯"
            </small>
          </td>
        </tr>
      `;

      updateRowCount("Ø¬Ø§Ù‡Ø²", "info");
      searchInput.focus();
    });

    // ---- Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØµØ§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ----
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') {
        if (isNewMeter && saveNewBtn.style.display !== 'none') {
          saveNewBtn.click();
        } else if (!isNewMeter) {
          updateBtn.click();
        }
      }

      if (e.key === 'Escape') {
        searchInput.focus();
        searchInput.select();
      }
    });

  </script>
</body>

</html>
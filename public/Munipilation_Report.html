<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Power Manager Pro - Full Sync</title>
    <link rel="stylesheet" href="Munipilation_Report.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

    <div class="app">
        <div class="logo-section">
            <h2>โก ุงูุถุจุทูุฉ ุงููุถุงุฆูุฉ</h2>
            <div class="header-actions">
                <button class="btn-save" id="btnSave">๐พ ุญูุธ ุงูุจูุงูุงุช</button>
                <button class="btn-search" onclick="window.showSearchModal()">๐ ุชุนุฏูู ุงูุจูุงูุงุช</button>
                <button type="button" class="btn-report" onclick="window.showViewModal()">๐ ุชูุฑูุฑ ุงูุจูุงูุงุช</button>
                <button class="btn-search" onclick="window.location.href='index.html'">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</button>
        </div>
    </div>

    <div class="main-form-grid">
        <input type="text" id="mname" placeholder="ุงุณู ุงููุดุชุฑู">
        <input type="text" id="mno" placeholder="ุฑูู ุงูุนุฏุงุฏ">
        <input type="number" id="mco" placeholder="ููุฏ ุงููุดุชุฑู">
        <input type="text" id="notes" placeholder="ููุงุญุธุงุช">
    </div>

    <button class="btn-photo-select" onclick="document.getElementById('photoInput').click()">๐ผ๏ธ ุฑูุน
        ุงููุฑููุงุช</button>
    <input type="file" id="photoInput" multiple accept="image/*" class="hidden">
    <div id="frontPhotoGrid" class="photo-grid"></div>

    <div class="section-title">ุชุตููู ุงูุฃุญูุงู</div>

    <div class="add-load-row">
        <input type="text" id="newItemName" placeholder="ูุตู ููุน ุงูุญูู">
        <input type="number" id="newItemW" placeholder="Watts ุงููุฏุฑุฉ ุจุงููุงุช">
        <input type="number" id="newItemHP" placeholder="HP ุงููุฏุฑุฉ ุจุงูุญุตุงู">
        <button class="btn-search" id="btnAddLoad">ุงุถุงูุฉ</button>
    </div>

    <table id="mainTable">
        <thead>
            <tr>
                <th>ูุตู ููุน ุงูุญูู</th>
                <th>Watts ุงููุฏุฑุฉ ุจุงููุงุช</th>
                <th>HP ุงููุฏุฑุฉ ุจุงูุญุตุงู</th>
                <th>ุญุฐู</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    </div>


    <script type="module">
        import { Storage } from 'https://unpkg.com/megajs/dist/main.browser-es.mjs';

        const firebaseConfig = {
            apiKey: "AIzaSyCTSWDR3IvFpzp8UARsClrpwbRtTwr12jA",
            authDomain: "ndedc-meter-calib.firebaseapp.com",
            databaseURL: "https://ndedc-meter-calib-default-rtdb.firebaseio.com",
            projectId: "ndedc-meter-calib"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const megaEmail = 'amirmerrooo@gmail.com', megaPass = 'J851581800amir';

        let selectedFiles = [];
        const genId = () => Math.floor(100000 + Math.random() * 900000);

        // UI: Photo Preview Front
        document.getElementById('photoInput').onchange = (e) => {
            Array.from(e.target.files).forEach(file => {
                selectedFiles.push(file);
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const div = document.createElement('div');
                    div.className = 'photo-box';
                    div.innerHTML = `<img src="${ev.target.result}"><div class="del-photo" onclick="window.removeSelected(this)">โ</div>`;
                    document.getElementById('frontPhotoGrid').appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        };
        window.removeSelected = (el) => {
            const idx = Array.from(el.parentElement.parentElement.children).indexOf(el.parentElement);
            selectedFiles.splice(idx, 1);
            el.parentElement.remove();
        };

        // --- Save New ---
        document.getElementById('btnSave').onclick = async () => {
            const code = document.getElementById('mco').value;
            if (!code) return Swal.fire('Error', 'Unique ID required', 'error');
            Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const storage = await new Storage({ email: megaEmail, password: megaPass }).ready;
                let folder = storage.root.children.find(c => c.name === 'ndedc-loads') || await storage.mkdir('ndedc-loads');
                let links = [];
                for (let file of selectedFiles) {
                    const id = genId();
                    const upload = storage.upload({ name: `${id}.jpeg`, size: file.size, target: folder }, new Uint8Array(await file.arrayBuffer()));
                    const mf = await upload.complete;
                    links.push({ id: id, url: await mf.link() });
                }
                await db.ref('subscribers/' + code).set({
                    name: document.getElementById('mname').value,
                    meter_no: document.getElementById('mno').value,
                    description: document.getElementById('notes').value,
                    loads: Array.from(document.querySelectorAll('#tableBody tr')).map(r => ({ item: r.cells[0].innerText, watts: r.cells[1].innerText, hp: r.cells[2].innerText })),
                    megaPhotos: links
                });
                location.reload();
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        };

        // --- Search ---
        window.showSearchModal = () => {
            Swal.fire({
                title: 'ุจุญุซ ุจุฑูู ุงูุนุฏุงุฏ ูุชุนุฏูู ุงูุจูุงูุงุช',
                html: `<input type="text" id="mSearch" placeholder="ุงุฏุฎู ุฑูู ุงูุนุฏุงุฏ ..." onkeyup="window.runSearch()" style="margin-bottom:10px;">
                    <div id="searchResults" style="max-height:400px; overflow-y:auto;"></div>`,
                showConfirmButton: false, width: '800px'
            });
        };
        window.runSearch = async () => {
            const term = document.getElementById('mSearch').value;
            const res = document.getElementById('searchResults');
            if (term.length < 1) return;

            const snap = await db.ref('subscribers').once('value');
            res.innerHTML = "";

            snap.forEach(child => {
                const d = child.val();
                // Check if meter_no exists and matches the search term
                if (d.meter_no?.toString().includes(term)) {
                    const div = document.createElement('div');
                    div.className = "search-row"; // Using the CSS class now

                    div.innerHTML = `
    <div style="text-align: right;">
        <strong>ุงูุฃุณู:</strong> <span>${d.name || '---'}</span> 
        <span style="margin: 0 10px; color: #ccc;">|</span>
        <strong>ุฑูู ุงูุนุฏุงุฏ:</strong> <span>${d.meter_no}</span>
    </div>
    <button style="background:var(--warning); font-weight:bold; padding: 5px 15px;" 
            onclick="window.editSubscriber('${child.key}')">ุชุนุฏูู EDIT</button>
`;
                    res.appendChild(div);
                }
            });
        };

        // --- Modal Load Row Adder ---
        window.addNewRowInModal = () => {
            const tbody = document.getElementById('sw-body');
            const row = `<tr>
                <td><input class="sw-item-input" placeholder="ูุตู ููุน ุงูุญูู""></td>
                <td><input class="sw-watts-input" type="number" placeholder="Watts ุงููุฏุฑุฉ ุจุงููุงุช"" oninput="this.parentElement.nextElementSibling.querySelector('input').value = (this.value/746).toFixed(3)"></td>
                <td><input class="sw-hp-input" type="number" placeholder="HP ุงููุฏุฑุฉ ุจุงูุญุตุงู"" oninput="this.parentElement.previousElementSibling.querySelector('input').value = (this.value*746).toFixed(0)"></td>
              // Change this line in your btnAddLoad.onclick and addNewRowInModal functions:
                <td class="btn-delete-row" onclick = "this.parentElement.remove()" >ุญุฐู</ > 
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        };

        // --- Edit Subscriber ---
        window.editSubscriber = async (key) => {
            const snap = await db.ref('subscribers/' + key).once('value');
            const data = snap.val();

            await Swal.fire({
                title: 'ุชุนุฏูู ุจูุงูุงุช ูุดุชุฑู',
                width: '1000px',
                html: `
                    <div class="edit-modal-grid">
        <div class="form-group">
            <label>ุงูุฃุณู:</label>
            <input id="sw-name" value="${data.name || ''}">
        </div>
        <div class="form-group">
            <label>ุฑูู ุงูุนุฏุงุฏ:</label>
            <input id="sw-mno" value="${data.meter_no || ''}">
        </div>
        <div class="form-group">
            <label>ููุฏ ุงููุดุชุฑู:</label>
            <input id="sw-id" value="${key}">
        </div>
        <div class="form-group">
            <label>ููุงุญุธุงุช:</label>
            <input id="sw-note" value="${data.description || ''}">
        </div>
    </div>

                    <div class="section-title">ุชุตููู ุงูุฃุญูุงู</div>
                    <table>

                        <thead><tr><th>ูุตู ููุน ุงูุญูู</th><th>Watts ุงููุฏุฑุฉ ุจุงููุงุช</th><th>HP ุงููุฏุฑุฉ ุจุงูุญุตุงู</th><th>ุญุฐู</th></tr></thead>
                        <tbody id="sw-body">
                            ${(data.loads || []).map(l => `<tr>
                                <td><input class="sw-item-input" value="${l.item}"></td>
                                <td><input class="sw-watts-input" type="number" value="${l.watts}" oninput="this.parentElement.nextElementSibling.querySelector('input').value = (this.value/746).toFixed(3)"></td>
                                <td><input class="sw-hp-input" type="number" value="${l.hp}" oninput="this.parentElement.previousElementSibling.querySelector('input').value = (this.value*746).toFixed(0)"></td>
                                <td class="btn-delete-row" onclick="this.parentElement.remove()">ุญุฐู</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    <button class="btn-search" style="width:100%; margin-bottom:15px;" onclick="window.addNewRowInModal()">โ ุงุถุงูุฉ ุงุญูุงู ุฌุฏูุฏุฉ</button>
                    
                    <div class="section-title">ุงููุฑููุงุช</div>
                    <div class="photo-grid" id="sw-photo-grid">
                        ${(data.megaPhotos || []).map((p) => `
                            <div class="photo-box" data-id="${p.id}" data-url="${p.url}">
                                <img src="${p.url}">
                                <div class="del-photo" onclick="window.syncDeletePhoto('${key}', this)">โ</div>
                                <small>${p.id}</small>
                            </div>
                        `).join('')}
                    </div>
                    <div class="section-title">ุงุถุงูุฉ ูุฑููุงุช ุฌุฏูุฏุฉ</div>
                    <input type="file" id="sw-new-photos" multiple accept="image/*">
                `,
                showCancelButton: true,
                confirmButtonText: '๐ ุชุนุฏูู ูุญูุธ ุงูุจูุงูุงุช',
                preConfirm: async () => {
                    const newPhotoFiles = document.getElementById('sw-new-photos').files;
                    const remainingPhotos = [];
                    document.querySelectorAll('#sw-photo-grid .photo-box').forEach(box => {
                        remainingPhotos.push({ id: box.dataset.id, url: box.dataset.url });
                    });

                    // Logic to collect all rows (new and old)
                    const updatedLoads = Array.from(document.querySelectorAll('#sw-body tr')).map(r => ({
                        item: r.querySelector('.sw-item-input').value,
                        watts: r.querySelector('.sw-watts-input').value,
                        hp: r.querySelector('.sw-hp-input').value
                    })).filter(item => item.item !== ""); // Ignore empty rows

                    Swal.showLoading();
                    try {
                        const storage = await new Storage({ email: megaEmail, password: megaPass }).ready;
                        const folder = storage.root.children.find(c => c.name === 'ndedc-loads');
                        for (let file of newPhotoFiles) {
                            const id = genId();
                            const upload = storage.upload({ name: `${id}.jpeg`, size: file.size, target: folder }, new Uint8Array(await file.arrayBuffer()));
                            const mf = await upload.complete;
                            remainingPhotos.push({ id: id, url: await mf.link() });
                        }

                        const newKey = document.getElementById('sw-id').value;
                        const finalObj = {
                            name: document.getElementById('sw-name').value,
                            meter_no: document.getElementById('sw-mno').value,
                            description: document.getElementById('sw-note').value,
                            loads: updatedLoads,
                            megaPhotos: remainingPhotos
                        };

                        await db.ref('subscribers/' + newKey).set(finalObj);
                        if (newKey !== key) await db.ref('subscribers/' + key).remove();
                        return true;
                    } catch (err) { Swal.showValidationMessage(`Error: ${err.message}`); }
                }
            }).then((res) => { if (res.isConfirmed) location.reload(); });
        };

        window.syncDeletePhoto = async (subKey, el) => {
            const box = el.parentElement;
            const photoId = box.dataset.id;
            if (!confirm(`Permanent Delete?`)) return;
            try {
                const storage = await new Storage({ email: megaEmail, password: megaPass }).ready;
                const folder = storage.root.children.find(c => c.name === 'ndedc-loads');
                const file = folder.children.find(c => c.name === `${photoId}.jpeg`);
                if (file) await file.delete();
                const ref = db.ref(`subscribers/${subKey}/megaPhotos`);
                const snap = await ref.once('value');
                let photos = (snap.val() || []).filter(p => p.id != photoId);
                await ref.set(photos);
                box.remove();
            } catch (e) { alert(e.message); }
        };

        // --- Helper for Front Page ---
        document.getElementById('btnAddLoad').onclick = () => {
            const n = document.getElementById('newItemName').value;
            const w = document.getElementById('newItemW').value;
            const h = document.getElementById('newItemHP').value;

            if (!n) return;

            // ุชู ุฅุถุงูุฉ class="btn-delete-row" ููุนูู ูุคุดุฑ ุงููุงูุณ ุญุณุจ ุงูู CSS
            const newRow = `
        <tr>
            <td>${n}</td>
            <td>${w}</td>
            <td>${h}</td>
            <td class="btn-delete-row" onclick="this.parentElement.remove()">ุญุฐู</td>
        </tr>`;

            document.getElementById('tableBody').insertAdjacentHTML('beforeend', newRow);

            // ุชูุฑูุบ ุงูุญููู ุจุนุฏ ุงูุฅุถุงูุฉ
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemW').value = '';
            document.getElementById('newItemHP').value = '';
        };

        // ุชุญููู ูู Watts ุฅูู HP (ุงููุณูุฉ ุนูู 746)
        document.getElementById('newItemW').oninput = function () {
            if (this.value) {
                document.getElementById('newItemHP').value = (this.value / 746).toFixed(3);
            } else {
                document.getElementById('newItemHP').value = '';
            }
        };

        // ุชุญููู ูู HP ุฅูู Watts (ุงูุถุฑุจ ูู 746)
        document.getElementById('newItemHP').oninput = function () {
            if (this.value) {
                document.getElementById('newItemW').value = (this.value * 746).toFixed(0);
            } else {
                document.getElementById('newItemW').value = '';
            }
        };



        window.showViewModal = () => {
            Swal.fire({
                title: 'ุนุฑุถ ุงูุจูุงูุงุช - ุฃูุณูู  ',
                html: `
            <input type="text" id="viewSearch" placeholder="ุจุญุซ ุจุฑูู ุงูุนุฏุงุฏ ููุนุฑุถ..." onkeyup="window.runViewSearch()" style="margin-bottom:15px;">
            <div id="viewResults" style="max-height:450px; overflow-y:auto; text-align:right;"></div>
        `,
                showConfirmButton: false,
                width: '900px'
            });
        };

        window.runViewSearch = async () => {
            const term = document.getElementById('viewSearch').value;
            const res = document.getElementById('viewResults');
            if (term.length < 1) return;

            const snap = await db.ref('subscribers').once('value');
            res.innerHTML = "";

            snap.forEach(child => {
                const d = child.val();
                if (d.meter_no?.toString().includes(term)) {
                    const div = document.createElement('div');
                    div.className = "search-row";
                    div.style.flexDirection = "column";
                    div.style.alignItems = "stretch";

                    div.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; background:#f8f9fa; padding:12px 15px; border-radius:8px; border:1px solid #dee2e6; margin-bottom:10px;">
        <div style="font-size: 12px; color: #2c3e50; line-height: 1.5;">
            <strong style="color: #34495e;">๐ค ุงุณู ุงููุดุชุฑู:</strong> <span>${d.name || '---'}</span> 
            <span style="margin: 0 8px; color: #ccc;">|</span>
            <strong style="color: #34495e;">๐ข ุฑูู ุงูุนุฏุงุฏ:</strong> <span>${d.meter_no}</span> 
            <span style="margin: 0 8px; color: #ccc;">|</span>
            <strong style="color: #34495e;">๐ ููุฏ ุงููุดุชุฑู:</strong> <span style="font-family: monospace; font-weight: bold; color: #e67e22;">${child.key}</span>
        </div> 
        <button class="btn-save" style="padding:6px 15px; font-size:13px; white-space: nowrap;" onclick="window.exportToExcel('${child.key}')">๐ฅ Excel</button>
    </div>
    <div style="margin-top:5px; padding: 0 10px;">
        <table style="width:100%; font-size:13px; margin-bottom:10px; border: 1px solid #eee;">
            <thead>
                <tr style="background:#f1f3f5;">
                    <th style="padding:8px;">ูุตู ุงูุญูู</th>
                    <th style="padding:8px;">Watts</th>
                    <th style="padding:8px;">HP</th>
                </tr>
            </thead>
            <tbody>
                ${(d.loads || []).map(l => `
                    <tr>
                        <td style="padding:6px; border:1px solid #eee;">${l.item}</td>
                        <td style="padding:6px; border:1px solid #eee;">${l.watts}</td>
                        <td style="padding:6px; border:1px solid #eee;">${l.hp}</td>
                    </tr>`).join('')}
            </tbody>
        </table>
        <div style="background:#fffbe6; padding:10px; border-radius:6px; border:1px solid #ffe58f; font-size: 13px;">
            <strong>๐ ููุงุญุธุงุช:</strong> <span style="color: #666;">${d.description || 'ูุง ููุฌุฏ'}</span>
        </div>
    </div>
    <hr style="margin:20px 0; border:0; border-top: 1px dashed #ddd;">
`;
                    res.appendChild(div);
                }
            });
        };


        window.exportToExcel = async (key) => {
            try {
                const snap = await db.ref('subscribers/' + key).once('value');
                const data = snap.val();

                if (!data) {
                    Swal.fire('ุฎุทุฃ', 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช', 'error');
                    return;
                }

                // 1. ุชุฌููุฒ ุงููุตูููุฉ (ุงูุจูุงูุงุช)
                const info = [
                    ["ุชูุฑูุฑ ุจูุงูุงุช ุงููุดุชุฑู ูุงูุฃุญูุงู"], // ุงูุตู 0
                    [""],                            // ุงูุตู 1
                    ["ุงุณู ุงููุดุชุฑู", data.name || "---", ""], // ุงูุตู 2
                    ["ุฑูู ุงูุนุฏุงุฏ", data.meter_no || "---", ""], // ุงูุตู 3
                    ["ููุฏ ุงููุดุชุฑู", key, ""],        // ุงูุตู 4
                    ["ููุงุญุธุงุช", data.description || "ูุง ููุฌุฏ", ""], // ุงูุตู 5
                    [""],                            // ุงูุตู 6
                    ["ุฌุฏูู ุงูุฃุญูุงู", "", ""],        // ุงูุตู 7 (ูุฐุง ูุง ุณูููู ุจุฏูุฌู)
                    ["ูุตู ููุน ุงูุญูู", "ุงููุฏุฑุฉ ุจุงููุงุช (W)", "ุงููุฏุฑุฉ ุจุงูุญุตุงู (HP)"] // ุงูุตู 8
                ];

                // 2. ุฅุถุงูุฉ ุตููู ุฌุฏูู ุงูุฃุญูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                const loadsData = (data.loads || []).map(l => [l.item, l.watts, l.hp]);
                const finalData = info.concat(loadsData);

                // 3. ุฅูุดุงุก ูุฑูุฉ ุงูุนูู
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(finalData);

                // 4. ุฅุนุฏุงุฏ ุฎุงุตูุฉ ุงูุฏูุฌ (Merging)
                // s = start, e = end | r = row, c = col (ุงูุชุฑููู ูุจุฏุฃ ูู 0)
                ws['!merges'] = [
                    // ุฏูุฌ ุนููุงู "ุชูุฑูุฑ ุจูุงูุงุช ุงููุดุชุฑู" (ุงูุตู ุงูุฃูู)
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 2 } },
                    // ุฏูุฌ ุนููุงู "ุฌุฏูู ุงูุฃุญูุงู" (ุงูุตู ุงูุซุงูู - index 7) ุนุจุฑ 3 ุฃุนูุฏุฉ
                    { s: { r: 7, c: 0 }, e: { r: 7, c: 2 } }
                ];

                // 5. ุชูุณููุงุช ุฅุถุงููุฉ (ุงูุงุชุฌุงู ูุนุฑุถ ุงูุฃุนูุฏุฉ)
                ws['!dir'] = "rtl";
                ws['!cols'] = [{ wch: 30 }, { wch: 20 }, { wch: 20 }];

                // 6. ุงูุชุญููู
                XLSX.utils.book_append_sheet(wb, ws, "ุชูุฑูุฑ ุงูุฃุญูุงู");
                XLSX.writeFile(wb, `ุชูุฑูุฑ ุงุญูุงู ุฑูู ุงูุนุฏุงุฏ ${data.meter_no || key}.xlsx`);

            } catch (error) {
                console.error("Excel Export Error:", error);
                Swal.fire('ุฎุทุฃ', 'ูุดู ุชุตุฏูุฑ ุงูููู: ' + error.message, 'error');
            }
        };


        // ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ ูุฌููุน ููุงูุฐ SweetAlert2
        const Swal = window.Swal.mixin({
            allowOutsideClick: false, // ููุน ุงูุฅุบูุงู ุนูุฏ ุงูุถุบุท ุฎุงุฑุฌ ุงููุงูุฐุฉ
            allowEscapeKey: false,    // ููุน ุงูุฅุบูุงู ุจููุชุงุญ Esc
            showCancelButton: true,   // ุฅุธูุงุฑ ุฒุฑ ุงูุฅูุบุงุก ุชููุงุฆูุงู ูู ูู ุงูููุงูุฐ
            cancelButtonText: 'ุฅุบูุงู โ', // ูุต ุฒุฑ ุงูุฅูุบุงุก
            cancelButtonColor: '#d33',  // ููู ุฒุฑ ุงูุฅูุบุงุก (ุฃุญูุฑ)
            confirmButtonColor: '#3085d6' // ููู ุฒุฑ ุงูุชุฃููุฏ ุงูุงูุชุฑุงุถู
        });


    </script>
</body>

</html>

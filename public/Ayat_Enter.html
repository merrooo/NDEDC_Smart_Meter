<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام تسجيل دخول العدادات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="Ayat.css" />
    <style>
        /* compact table fonts */
        .table-container table td {
            font-size: 12px;
            padding: 6px 8px;
        }

        .table-container table th {
            font-size: 13px;
            padding: 8px 10px;
        }

        .search-row input {
            font-size: 12px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <label class="dark-toggle" onclick="document.body.classList.toggle('dark-mode')">
        <span class="icon">🌙</span>
        <div class="switch"></div>
        <span class="icon">☀️</span>
    </label>

    <button class="btn-view" onclick="window.location.href='index.html'">
        الصفحة الرئيسية
    </button>

    <div class="entry-card">
        <h2>تسجيل بيانات العدادات</h2>

        <div class="table-controls">
            <div class="controls-right">
                <button class="btn-refresh" onclick="refreshDatabase()">تحديث البيانات</button>
            </div>
            <div class="controls-left">
                <button class="btn-excel" onclick="exportExcel()">تصدير Excel</button>
            </div>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>رقم العداد</th>
                        <th>تاريخ الفحص</th>
                        <th>القطاع</th>
                        <th>الهندسة</th>
                        <th>النشاط</th>
                        <th>نوع العداد</th>
                        <th>حالة العداد</th>
                        <th>الإجراءات</th>
                    </tr>
                    <tr class="search-row">
                        <th><input type="text" class="search-input" onkeyup="filterTable(0)" placeholder="بحث..."></th>
                        <th>
                            <div class="date-range">
                                <input type="date" class="search-input-date-start" onchange="filterTable(1)" title="من"
                                    placeholder="من">
                                <input type="date" class="search-input-date-end" onchange="filterTable(1)" title="إلى"
                                    placeholder="إلى">
                            </div>
                        </th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(2)" placeholder="بحث..."></th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(3)" placeholder="بحث..."></th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(4)" placeholder="بحث..."></th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(5)" placeholder="بحث..."></th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(6)" placeholder="بحث..."></th>
                        <th><button class="btn-clear-filters" onclick="addNewRow()">إضافةعداد</button></th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                </tbody>
            </table>
        </div>

        <div class="pagination-controls">
            <button id="prevBtn" class="btn-pagination" onclick="window.prevPage()" disabled>
                السابق
            </button>
            <span id="pageInfo" class="page-info">الصفحة 1 من 1</span>
            <button id="nextBtn" class="btn-pagination" onclick="window.nextPage()" disabled>
                التالي
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, remove, push }
            from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABeLySOk_10XjaHSUjkfnR8f3HSTFkEYU",
            authDomain: "ndedc-smartmeter.firebaseapp.com",
            projectId: "ndedc-smartmeter",
            storageBucket: "ndedc-smartmeter.appspot.com",
            messagingSenderId: "557422247352",
            appId: "1:557422247352:web:824d4f96affd7bbb0fa34d",
            databaseURL: "https://ndedc-smartmeter-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global options object for dropdowns
        const options = {
            2: ['دمياط', 'شمال الدقهلية', 'جنوب الدقهلية', 'كفر الشيخ'],
            3: ['هندسة شمال دمياط', 'هندسة جنوب دمياط', 'هندسة عزبة البرج', 'هندسة كفر سعد', 'هندسة كفر البطيخ', 'هندسة راس البر', 'هندسة دمياط الجديدة', 'هندسة الزرقا', 'هندسة فارسكور', 'هندسة الروضة', 'هندسة الشعراء', 'هندسة مدينة شربين', 'هندسة قري شربين', 'هندسة دكرنس', 'هندسة جمصة', 'هندسة قري بلقاس', 'هندسة مدينة بلقاس', 'هندسة الستاموني', 'هندسة بني عبيد', 'هندسة منية النصر', 'هندسة ميت سلسيل', 'هندسة الجمالية', 'هندسة قري المنزلة', 'هندسة مدينة المنزلة', 'هندسة المطرية', 'هندسة شرق المنصورة', 'هندسة غرب المنصورة', 'هندسة طلخا', 'هندسة نبروه', 'هندسة قري المنصورة 1', 'هندسة قري المنصورة 2', 'هندسة اجا', 'هندسة مدينة السنبلاوين', 'هندسة قري السنبلاوين', 'هندسة تمي الامديد', 'هندسة مدينة ميت غمر', 'هندسة قري ميت غمر', 'هندسة كوم النور', 'هندسة مدينة كفر الشيخ', 'هندسة غرب كفر الشيخ', 'هندسة شرق كفر الشيخ', 'هندسة قلين', 'هندسة قرى سيدي سالم', 'هندسة مدينة سيدي سالم', 'هندسة الرياض', 'هندسة مدينة دسوق', 'هندسة قرى شمال دسوق', 'هندسة قرى جنوب دسوق', 'هندسة فوه', 'هندسة مطوبس', 'هندسة مدينة الحامول', 'هندسة قرى الحامول', 'هندسة بيلا', 'هندسة بلطيم', 'هندسة برج البرلس'],
            4: ['منزلي', 'تجاري', 'قوى محركة', 'كودي مخالف', 'ري', 'مزارع', 'مساجد', 'استثمار صناعة', 'كبار', 'مصالح حكومية', 'مصالح حكوميه اخري', 'ADD_NEW'],
            5: ['اسكرا احادي', 'المصريه احادي', 'جلوبال ثلاثى مباشر', 'جلوبال احادي', 'جلوبال ثلاثى غير مباشر', 'ADD_NEW'],
            6: ['الفحص', 'التكهين','فحص الشركة المصنعة', 'ADD_NEW']
        };

        // Pagination state
        let allData = [];
        let filteredData = [];
        let itemsPerPage = 8;
        let currentPage = 1;

        // Date helpers: display as dd/mm/yyyy, store as yyyy-mm-dd
        function formatDateDisplay(iso) {
            if (!iso) return '';
            const m = iso.toString().match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (m) return `${m[3]}/${m[2]}/${m[1]}`;
            const m2 = iso.toString().match(/^(\d{2})\/(\d{2})\/(\d{4})/);
            if (m2) return iso; // already dd/mm/yyyy
            return iso;
        }

        function parseAnyToISO(val) {
            if (!val) return '';
            const s = val.toString().trim();
            if (s.indexOf('/') > -1) {
                const parts = s.split('/');
                if (parts.length === 3) {
                    const dd = parts[0].padStart(2, '0');
                    const mm = parts[1].padStart(2, '0');
                    const yy = parts[2];
                    return `${yy}-${mm}-${dd}`;
                }
                return s;
            }
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (m) return `${m[1]}-${m[2]}-${m[3]}`;
            return s;
        }

        // تحميل البيانات
        async function loadAyatEnterData() {
            try {
                const dbRef = ref(db, 'Ayat_Enter');
                const snapshot = await get(dbRef);
                allData = [];

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        const item = data[key] || {};
                        // keep original key if mno missing
                        if (!item.mno) item.mno = key;
                        allData.push(item);
                    });
                }

                // initialize filteredData and render first page
                filteredData = allData.slice();
                currentPage = 1;
                renderPage();
            } catch (error) {
                console.error('Error loading:', error);
            }
        }

        function renderPage() {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            const effectiveItemsPerPage = Math.max(8, (typeof itemsPerPage === 'number' ? itemsPerPage : 8));
            const start = (currentPage - 1) * effectiveItemsPerPage;
            const pageItems = filteredData.slice(start, start + effectiveItemsPerPage);
            pageItems.forEach(item => renderRow(item.mno || item._key || '', item));
            updatePaginationControls();
        }

        function renderRow(key, item) {
            const tbody = document.getElementById('comparisonTableBody');
            const newRow = tbody.insertRow();
            // استخدام رقم العداد (mno) كـ data-key بدلاً من Firebase key
            newRow.setAttribute('data-key', item.mno || key);

            const fields = ['mno', 'enter_date', 'keta3', 'handsa', 'nashattype', 'mtype','status'];
            fields.forEach((field, index) => {
                const cell = newRow.insertCell(index);
                cell.className = 'editable-cell';
                if (field === 'enter_date') {
                    cell.innerText = formatDateDisplay(item[field] || '');
                } else if (field === 'mno') {
                    // fallback to key for old records that don't have mno stored
                    cell.innerText = item[field] || key || '';
                } else {
                    cell.innerText = item[field] || '';
                }
                cell.onclick = () => editCell(cell);
            });


            const actionCell = newRow.insertCell(7);
            // use row key to avoid undefined mno issues on old records
            actionCell.innerHTML = `
                <button class="btn-excel btn-edit-toggle" style="padding: 4px 10px; font-size: 12px;" onclick="toggleRowEdit(this)">تعديل</button>
                <button class="btn-refresh" style="padding: 4px 10px; font-size: 12px;" onclick="deleteRow(this)">حـذف</button>
            `;
        }

        // تحديث قاعدة البيانات
        window.refreshDatabase = () => {
            Swal.fire({ title: "جاري التحميل...", timer: 1000, showConfirmButton: false, didOpen: () => Swal.showLoading() });
            loadAyatEnterData();
        };

        // إضافة سجل جديد فارغ
        window.addNewRow = () => {
            const tbody = document.getElementById("comparisonTableBody");
            const newRow = tbody.insertRow(0);
            newRow.setAttribute('data-editing', '1');
            for (let i = 0; i < 7; i++) {
                const cell = newRow.insertCell(i);
                cell.className = 'editable-cell';
                if (i === 1) {
                    // set date to today and make it non-editable
                    const todayISO = new Date().toISOString().slice(0, 10);
                    cell.innerText = formatDateDisplay(todayISO);
                    cell.classList.add('date-disabled');
                } else {
                    cell.onclick = () => editCell(cell);
                }
            }
            const actionCell = newRow.insertCell(7);
            actionCell.innerHTML = `
                <button class="btn-save" style="width: auto; padding: 4px 10px; font-size: 12px;" onclick="saveNewRow(this)">حفظ</button>
                <button class="btn-cancel" style="margin-inline-start:6px; padding: 4px 10px; font-size: 12px;" onclick="cancelNewRow(this)">إلغاء</button>
            `;
        };

        // تعديل خلية مع دعم القوائم المنسدلة
        window.editCell = (cell) => {
            const row = cell.closest('tr');
            if (!row || row.getAttribute('data-editing') !== '1') return;
            if (cell.querySelector('input') || cell.querySelector('select')) return;
            const text = cell.innerText;
            const colIndex = cell.cellIndex;
            // Prevent editing the date for existing (saved) records
            if (colIndex === 1 && row && row.getAttribute('data-key')) {
                return;
            }
            let input;

            // إنشء مدخل مناسب بناءً على العمود
            if (colIndex === 1) {
                // عمود التاريخ
                input = document.createElement('input');
                input.type = 'date';
                input.value = parseAnyToISO(text);
            } else if ([2, 3, 4, 5, 6].includes(colIndex) && options[colIndex]) {
                // أعمدة بها قوائم منسدلة
                input = document.createElement('select');
                input.innerHTML = '<option value="">اختر...</option>';

                options[colIndex].forEach(opt => {
                    const option = document.createElement('option');
                    if (opt === 'ADD_NEW') {
                        option.value = 'ADD_NEW';
                        option.textContent = 'إضافة جديد...';
                    } else {
                        option.value = opt;
                        option.textContent = opt;
                        if (opt === text) option.selected = true;
                    }
                    input.appendChild(option);
                });

                // معالجة ADD_NEW
                if ([4, 5 , 6].includes(colIndex)) {
                    input.onchange = () => {
                        if (input.value === 'ADD_NEW') {
                            const promptText = colIndex === 5 ? 'أدخل نوع العداد الجديد:' : colIndex === 6 ? 'أدخل حالة العداد الجديدة:' : 'أدخل نوع النشاط الجديد:';
                            const newVal = prompt(promptText);
                            if (newVal && newVal.trim()) {
                                const trimmed = newVal.trim();
                                if (!options[colIndex].includes(trimmed)) {
                                    options[colIndex].splice(options[colIndex].length - 1, 0, trimmed);
                                    const opt = document.createElement('option');
                                    opt.value = trimmed;
                                    opt.textContent = trimmed;
                                    opt.selected = true;
                                    input.insertBefore(opt, input.lastChild);
                                }
                            } else {
                                input.value = '';
                            }
                        }
                    };
                }
            } else {
                // نص عادي
                input = document.createElement('input');
                input.type = 'text';
                input.value = text;
            }

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            if (input.select) input.select();

            const saveEdit = () => {
                if (colIndex === 1) {
                    cell.innerText = formatDateDisplay(input.value);
                } else {
                    cell.innerText = input.value;
                }
                cell.onclick = () => editCell(cell);
            };

            input.onblur = saveEdit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') saveEdit();
                if (e.key === 'Escape') {
                    cell.innerText = text;
                    cell.onclick = () => editCell(cell);
                }
            };
        };

        window.toggleRowEdit = (btn) => {
            const row = btn.closest('tr');
            if (!row) return;

            const isEditing = row.getAttribute('data-editing') === '1';

            if (!isEditing) {
                row.setAttribute('data-editing', '1');
                row.querySelectorAll('td').forEach((td) => {
                    td.style.backgroundColor = 'rgba(14, 165, 233, 0.12)';
                });
                btn.textContent = 'حفظ';
                return;
            }

            // finalize any active editors before saving
            row.querySelectorAll('td').forEach((cell) => {
                const input = cell.querySelector('input, select');
                if (!input) return;
                if (cell.cellIndex === 1) {
                    cell.innerText = formatDateDisplay(input.value);
                } else {
                    cell.innerText = input.value;
                }
                cell.onclick = () => editCell(cell);
            });

            const key = row.getAttribute('data-key') || row.cells[0]?.innerText || '';
            updateInFirebase(key, row, true);

            row.setAttribute('data-editing', '0');
            row.querySelectorAll('td').forEach((td) => {
                td.style.backgroundColor = '';
            });
            btn.textContent = 'تعديل';
        };

        window.deleteRow = (btn) => {
            const row = btn.closest('tr');
            if (!row) return;
            const key = (row.getAttribute('data-key') || row.cells[0]?.innerText || '').trim();
            deleteRecord(key);
        };

        // حفظ السجل الجديد باستخدام رقم العداد كـ key
        window.saveNewRow = (btn) => {
            const row = btn.closest('tr');
            const cells = row.cells;
            const data = {
                mno: cells[0].innerText,
                enter_date: parseAnyToISO(cells[1].innerText),
                keta3: cells[2].innerText,
                handsa: cells[3].innerText,
                nashattype: cells[4].innerText,
                mtype: cells[5].innerText,
                status: cells[6].innerText
            };

            if (!data.mno) return Swal.fire("خطأ", "يجب إدخال رقم العداد", "error");

            // استخدام رقم العداد كـ key بدلاً من ID عشوائي
            set(ref(db, `Ayat_Enter/${data.mno}`), data).then(() => {
                Swal.fire("تم", "تم الحفظ بنجاح", "success");
                row.setAttribute('data-key', data.mno);
                loadAyatEnterData();
            }).catch(err => {
                Swal.fire("خطأ", "فشل الحفظ: " + err.message, "error");
            });
        };

        // تحديث في فيربيز باستخدام رقم العداد
        function updateInFirebase(key, row, showMessage = false) {
            const cells = row.cells;
            const originalKey = (key || '').trim();
            const mno = (cells[0].innerText || '').trim(); // استخدام رقم العداد كـ key
            if (!mno) {
                Swal.fire("خطأ", "رقم العداد مطلوب للحفظ", "error");
                return;
            }
            const data = {
                mno: mno,
                enter_date: parseAnyToISO(cells[1].innerText),
                keta3: cells[2].innerText,
                handsa: cells[3].innerText,
                nashattype: cells[4].innerText,
                mtype: cells[5].innerText,
                status: cells[6].innerText
            };
            const saveRecord = () => set(ref(db, `Ayat_Enter/${mno}`), data).then(() => {
                row.setAttribute('data-key', mno);
                if (showMessage) {
                    Swal.fire("تم", "تم حفظ التعديل بنجاح", "success");
                }
            }).catch((err) => {
                Swal.fire("خطأ", "فشل حفظ التعديل: " + err.message, "error");
            });

            // إذا تغيّر رقم العداد، احذف المفتاح القديم ثم احفظ بالجديد
            if (originalKey && originalKey !== mno) {
                remove(ref(db, `Ayat_Enter/${originalKey}`))
                    .then(saveRecord)
                    .catch((err) => Swal.fire("خطأ", "فشل تحديث المفتاح: " + err.message, "error"));
                return;
            }

            saveRecord();
        }

        // حذف سجل باستخدام رقم العداد
        window.deleteRecord = (key) => {
            const safeKey = (key || '').trim();
            if (!safeKey) {
                Swal.fire("خطأ", "لا يمكن حذف سجل بدون رقم عداد", "error");
                return;
            }
            Swal.fire({
                title: "هل أنت متأكد؟",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "نعم، احذف"
            }).then((res) => {
                if (res.isConfirmed) {
                    remove(ref(db, `Ayat_Enter/${safeKey}`)).then(() => {
                        Swal.fire("تم", "تم الحذف بنجاح", "success");
                        loadAyatEnterData();
                    }).catch((err) => {
                        Swal.fire("خطأ", "فشل الحذف: " + err.message, "error");
                    });
                }
            });
        };

        // إلغاء السجل الجديد أو إعادة تحميل السجل الحالي لإرجاع القيم
        window.cancelNewRow = (btn) => {
            const row = btn.closest('tr');
            // إذا كان السطر غير محفوظ (بدون data-key) فاحذفه، وإلا أعد تحميل البيانات لإرجاع القيم
            if (!row.getAttribute('data-key')) {
                row.remove();
            } else {
                loadAyatEnterData();
            }
        };

        function updatePaginationControls() {
            // enforce a minimum of 8 rows per page
            const effectiveItemsPerPage = Math.max(8, (typeof itemsPerPage === 'number' ? itemsPerPage : 8));
            const totalItems = Array.isArray(filteredData) ? filteredData.length : document.querySelectorAll('#comparisonTableBody tr').length;
            const totalPages = Math.max(1, Math.ceil(totalItems / effectiveItemsPerPage));
            const pageInfo = document.getElementById("pageInfo");
            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("nextBtn");

            if (pageInfo) pageInfo.textContent = `الصفحة ${currentPage} من ${totalPages}`;
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        window.nextPage = () => {
            const effectiveItemsPerPage = Math.max(8, (typeof itemsPerPage === 'number' ? itemsPerPage : 8));
            const totalItems = Array.isArray(filteredData) ? filteredData.length : document.querySelectorAll('#comparisonTableBody tr').length;
            const totalPages = Math.max(1, Math.ceil(totalItems / effectiveItemsPerPage));
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
            }
        };

        window.prevPage = () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        };

        // فلاتر البحث
        window.filterTable = (idx) => {
            const rows = document.querySelectorAll('#comparisonTableBody tr');
            const th = document.querySelector('.search-row')?.children[idx];
            if (!th) return;

            // Rebuild filteredData from allData using current search inputs, then render page
            const startVal = document.querySelector('.search-input-date-start')?.value || '';
            const endVal = document.querySelector('.search-input-date-end')?.value || '';
            const startIso = startVal ? parseAnyToISO(startVal) : '';
            const endIso = endVal ? parseAnyToISO(endVal) : '';

            const q0 = document.querySelector('.search-row')?.children[0]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q2 = document.querySelector('.search-row')?.children[2]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q3 = document.querySelector('.search-row')?.children[3]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q4 = document.querySelector('.search-row')?.children[4]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q5 = document.querySelector('.search-row')?.children[5]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q6 = document.querySelector('.search-row')?.children[6]?.querySelector('.search-input')?.value.toLowerCase() || '';

            filteredData = allData.filter(item => {
                // date
                const itemIso = parseAnyToISO(item.enter_date || '');
                if (startIso && endIso) {
                    if (!itemIso || itemIso < startIso || itemIso > endIso) return false;
                } else if (startIso) {
                    if (!itemIso || itemIso < startIso) return false;
                } else if (endIso) {
                    if (!itemIso || itemIso > endIso) return false;
                }
                // mno
                if (q0 && !(String(item.mno || '').toLowerCase().includes(q0))) return false;
                if (q2 && !(String(item.keta3 || '').toLowerCase().includes(q2))) return false;
                if (q3 && !(String(item.handsa || '').toLowerCase().includes(q3))) return false;
                if (q4 && !(String(item.nashattype || '').toLowerCase().includes(q4))) return false;
                if (q5 && !(String(item.mtype || '').toLowerCase().includes(q5))) return false;
                if (q6 && !(String(item.status || '').toLowerCase().includes(q6))) return false;
                return true;
            });

            currentPage = 1;
            renderPage();
        };

        // تصدير اكسيل
        window.exportExcel = () => {
            const table = document.getElementById("dataTable");
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "بيانات_العدادات.xlsx");
        };

        window.onload = loadAyatEnterData;
    </script>
</body>

</html>



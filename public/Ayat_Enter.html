<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="Ayat.css" />
    <style>
        /* compact table fonts */
        .table-container table td { font-size: 12px; padding: 6px 8px; }
        .table-container table th { font-size: 13px; padding: 8px 10px; }
        .search-row input { font-size: 12px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <label class="dark-toggle" onclick="document.body.classList.toggle('dark-mode')">
        <span class="icon">ğŸŒ™</span>
        <div class="switch"></div>
        <span class="icon">â˜€ï¸</span>
    </label>

    <div class="entry-card">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

        <div class="table-controls">
            <div class="controls-right">
                <button class="btn-refresh" onclick="refreshDatabase()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
            <div class="controls-left">
                <button class="btn-excel" onclick="exportExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
            </div>
        </div>

        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ</th>
                        <th>Ø§Ù„Ù‚Ø·Ø§Ø¹</th>
                        <th>Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©</th>
                        <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                    <tr class="search-row">
                        <th><input type="text" class="search-input" onkeyup="filterTable(0)" placeholder="Ø¨Ø­Ø«..."></th>
                        <th>
                            <div class="date-range">
                                <input type="date" class="search-input-date-start" onchange="filterTable(1)" title="Ù…Ù†"
                                    placeholder="Ù…Ù†">
                                <input type="date" class="search-input-date-end" onchange="filterTable(1)" title="Ø¥Ù„Ù‰"
                                    placeholder="Ø¥Ù„Ù‰">
                            </div>
                        </th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(2)" placeholder="Ø¨Ø­Ø«..."></th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(3)" placeholder="Ø¨Ø­Ø«..."></th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(4)" placeholder="Ø¨Ø­Ø«..."></th>
                        <th><input type="text" class="search-input" onkeyup="filterTable(5)" placeholder="Ø¨Ø­Ø«..."></th>
                        <th><button class="btn-clear-filters" onclick="addNewRow()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯</button></th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                </tbody>
            </table>
        </div>

        <div class="pagination-controls">
            <button id="prevBtn" class="btn-pagination" onclick="window.prevPage()" disabled>
                â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚
            </button>
            <span id="pageInfo" class="page-info">Ø§Ù„ØµÙØ­Ø© 1 Ù…Ù† 1</span>
            <button id="nextBtn" class="btn-pagination" onclick="window.nextPage()" disabled>
                Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, remove, push }
            from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABeLySOk_10XjaHSUjkfnR8f3HSTFkEYU",
            authDomain: "ndedc-smartmeter.firebaseapp.com",
            projectId: "ndedc-smartmeter",
            storageBucket: "ndedc-smartmeter.appspot.com",
            messagingSenderId: "557422247352",
            appId: "1:557422247352:web:824d4f96affd7bbb0fa34d",
            databaseURL: "https://ndedc-smartmeter-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global options object for dropdowns
        const options = {
            2: ['Ø¯Ù…ÙŠØ§Ø·', 'Ø´Ù…Ø§Ù„ Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©', 'Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©', 'ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®'],
            3: ['Ù‡Ù†Ø¯Ø³Ø© Ø´Ù…Ø§Ù„ Ø¯Ù…ÙŠØ§Ø·', 'Ù‡Ù†Ø¯Ø³Ø© Ø¬Ù†ÙˆØ¨ Ø¯Ù…ÙŠØ§Ø·', 'Ù‡Ù†Ø¯Ø³Ø© Ø¹Ø²Ø¨Ø© Ø§Ù„Ø¨Ø±Ø¬', 'Ù‡Ù†Ø¯Ø³Ø© ÙƒÙØ± Ø³Ø¹Ø¯', 'Ù‡Ù†Ø¯Ø³Ø© ÙƒÙØ± Ø§Ù„Ø¨Ø·ÙŠØ®', 'Ù‡Ù†Ø¯Ø³Ø© Ø±Ø§Ø³ Ø§Ù„Ø¨Ø±', 'Ù‡Ù†Ø¯Ø³Ø© Ø¯Ù…ÙŠØ§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø²Ø±Ù‚Ø§', 'Ù‡Ù†Ø¯Ø³Ø© ÙØ§Ø±Ø³ÙƒÙˆØ±', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø±ÙˆØ¶Ø©', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ø´Ø±Ø¨ÙŠÙ†', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±ÙŠ Ø´Ø±Ø¨ÙŠÙ†', 'Ù‡Ù†Ø¯Ø³Ø© Ø¯ÙƒØ±Ù†Ø³', 'Ù‡Ù†Ø¯Ø³Ø© Ø¬Ù…ØµØ©', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±ÙŠ Ø¨Ù„Ù‚Ø§Ø³', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ø¨Ù„Ù‚Ø§Ø³', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø³ØªØ§Ù…ÙˆÙ†ÙŠ', 'Ù‡Ù†Ø¯Ø³Ø© Ø¨Ù†ÙŠ Ø¹Ø¨ÙŠØ¯', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ù†ÙŠØ© Ø§Ù„Ù†ØµØ±', 'Ù‡Ù†Ø¯Ø³Ø© Ù…ÙŠØª Ø³Ù„Ø³ÙŠÙ„', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ©', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±ÙŠ Ø§Ù„Ù…Ù†Ø²Ù„Ø©', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†Ø²Ù„Ø©', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ù…Ø·Ø±ÙŠØ©', 'Ù‡Ù†Ø¯Ø³Ø© Ø´Ø±Ù‚ Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©', 'Ù‡Ù†Ø¯Ø³Ø© ØºØ±Ø¨ Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©', 'Ù‡Ù†Ø¯Ø³Ø© Ø·Ù„Ø®Ø§', 'Ù‡Ù†Ø¯Ø³Ø© Ù†Ø¨Ø±ÙˆÙ‡', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±ÙŠ Ø§Ù„Ù…Ù†ØµÙˆØ±Ø© 1', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±ÙŠ Ø§Ù„Ù…Ù†ØµÙˆØ±Ø© 2', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ø¬Ø§', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±ÙŠ Ø§Ù„Ø³Ù†Ø¨Ù„Ø§ÙˆÙŠÙ†', 'Ù‡Ù†Ø¯Ø³Ø© ØªÙ…ÙŠ Ø§Ù„Ø§Ù…Ø¯ÙŠØ¯', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ù…ÙŠØª ØºÙ…Ø±', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±ÙŠ Ù…ÙŠØª ØºÙ…Ø±', 'Ù‡Ù†Ø¯Ø³Ø© ÙƒÙˆÙ… Ø§Ù„Ù†ÙˆØ±', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®', 'Ù‡Ù†Ø¯Ø³Ø© ØºØ±Ø¨ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®', 'Ù‡Ù†Ø¯Ø³Ø© Ø´Ø±Ù‚ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ù„ÙŠÙ†', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±Ù‰ Ø³ÙŠØ¯ÙŠ Ø³Ø§Ù„Ù…', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ø³ÙŠØ¯ÙŠ Ø³Ø§Ù„Ù…', 'Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø±ÙŠØ§Ø¶', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ø¯Ø³ÙˆÙ‚', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±Ù‰ Ø´Ù…Ø§Ù„ Ø¯Ø³ÙˆÙ‚', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±Ù‰ Ø¬Ù†ÙˆØ¨ Ø¯Ø³ÙˆÙ‚', 'Ù‡Ù†Ø¯Ø³Ø© ÙÙˆÙ‡', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø·ÙˆØ¨Ø³', 'Ù‡Ù†Ø¯Ø³Ø© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø­Ø§Ù…ÙˆÙ„', 'Ù‡Ù†Ø¯Ø³Ø© Ù‚Ø±Ù‰ Ø§Ù„Ø­Ø§Ù…ÙˆÙ„', 'Ù‡Ù†Ø¯Ø³Ø© Ø¨ÙŠÙ„Ø§', 'Ù‡Ù†Ø¯Ø³Ø© Ø¨Ù„Ø·ÙŠÙ…', 'Ù‡Ù†Ø¯Ø³Ø© Ø¨Ø±Ø¬ Ø§Ù„Ø¨Ø±Ù„Ø³'],
            4: ['Ù…Ù†Ø²Ù„ÙŠ', 'ØªØ¬Ø§Ø±ÙŠ', 'Ù‚ÙˆÙ‰ Ù…Ø­Ø±ÙƒØ©', 'ÙƒÙˆØ¯ÙŠ Ù…Ø®Ø§Ù„Ù', 'Ø±ÙŠ', 'Ù…Ø²Ø§Ø±Ø¹', 'Ù…Ø³Ø§Ø¬Ø¯', 'Ø§Ø³ØªØ«Ù…Ø§Ø± ØµÙ†Ø§Ø¹Ø©', 'ÙƒØ¨Ø§Ø±', 'Ù…ØµØ§Ù„Ø­ Ø­ÙƒÙˆÙ…ÙŠØ©', 'Ù…ØµØ§Ù„Ø­ Ø­ÙƒÙˆÙ…ÙŠÙ‡ Ø§Ø®Ø±ÙŠ', 'ADD_NEW'],
            5: ['Ø§Ø³ÙƒØ±Ø§ Ø§Ø­Ø§Ø¯ÙŠ', 'Ø§Ù„Ù…ØµØ±ÙŠÙ‡ Ø§Ø­Ø§Ø¯ÙŠ', 'Ø¬Ù„ÙˆØ¨Ø§Ù„ Ø«Ù„Ø§Ø«Ù‰ Ù…Ø¨Ø§Ø´Ø±', 'Ø¬Ù„ÙˆØ¨Ø§Ù„ Ø§Ø­Ø§Ø¯ÙŠ', 'Ø¬Ù„ÙˆØ¨Ø§Ù„ Ø«Ù„Ø§Ø«Ù‰ ØºÙŠØ± Ù…Ø¨Ø§Ø´Ø±', 'ADD_NEW']
        };

        // Pagination state
        let allData = [];
        let filteredData = [];
        let itemsPerPage = 8;
        let currentPage = 1;

        // Date helpers: display as dd/mm/yyyy, store as yyyy-mm-dd
        function formatDateDisplay(iso) {
            if (!iso) return '';
            const m = iso.toString().match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (m) return `${m[3]}/${m[2]}/${m[1]}`;
            const m2 = iso.toString().match(/^(\d{2})\/(\d{2})\/(\d{4})/);
            if (m2) return iso; // already dd/mm/yyyy
            return iso;
        }

        function parseAnyToISO(val) {
            if (!val) return '';
            const s = val.toString().trim();
            if (s.indexOf('/') > -1) {
                const parts = s.split('/');
                if (parts.length === 3) {
                    const dd = parts[0].padStart(2, '0');
                    const mm = parts[1].padStart(2, '0');
                    const yy = parts[2];
                    return `${yy}-${mm}-${dd}`;
                }
                return s;
            }
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (m) return `${m[1]}-${m[2]}-${m[3]}`;
            return s;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function loadAyatEnterData() {
            try {
                const dbRef = ref(db, 'Ayat_Enter');
                const snapshot = await get(dbRef);
                allData = [];

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    Object.keys(data).forEach(key => {
                        const item = data[key] || {};
                        // keep original key if mno missing
                        if (!item.mno) item.mno = key;
                        allData.push(item);
                    });
                }

                // initialize filteredData and render first page
                filteredData = allData.slice();
                currentPage = 1;
                renderPage();
            } catch (error) {
                console.error('Error loading:', error);
            }
        }

        function renderPage() {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            const effectiveItemsPerPage = Math.max(8, (typeof itemsPerPage === 'number' ? itemsPerPage : 8));
            const start = (currentPage - 1) * effectiveItemsPerPage;
            const pageItems = filteredData.slice(start, start + effectiveItemsPerPage);
            pageItems.forEach(item => renderRow(item.mno || item._key || '', item));
            updatePaginationControls();
        }

        function renderRow(key, item) {
            const tbody = document.getElementById('comparisonTableBody');
            const newRow = tbody.insertRow();
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ (mno) ÙƒÙ€ data-key Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Firebase key
            newRow.setAttribute('data-key', item.mno || key);

            const fields = ['mno', 'enter_date', 'keta3', 'handsa', 'nashattype', 'mtype'];
            fields.forEach((field, index) => {
                const cell = newRow.insertCell(index);
                cell.className = 'editable-cell';
                if (field === 'enter_date') {
                    cell.innerText = formatDateDisplay(item[field] || '');
                } else {
                    cell.innerText = item[field] || '';
                }
                cell.onclick = () => editCell(cell);
            });


            const actionCell = newRow.insertCell(6);
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… mno Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† key
            actionCell.innerHTML = `
                <button class="btn-refresh" style="padding: 4px 10px; font-size: 12px;" onclick="deleteRecord('${item.mno}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            `;
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        window.refreshDatabase = () => {
            Swal.fire({ title: "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...", timer: 1000, showConfirmButton: false, didOpen: () => Swal.showLoading() });
            loadAyatEnterData();
        };

        // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙØ§Ø±Øº
        window.addNewRow = () => {
            const tbody = document.getElementById("comparisonTableBody");
            const newRow = tbody.insertRow(0);
            for (let i = 0; i < 6; i++) {
                const cell = newRow.insertCell(i);
                cell.className = 'editable-cell';
                if (i === 1) {
                    // set date to today and make it non-editable
                    const todayISO = new Date().toISOString().slice(0, 10);
                    cell.innerText = formatDateDisplay(todayISO);
                    cell.classList.add('date-disabled');
                } else {
                    cell.onclick = () => editCell(cell);
                }
            }
            const actionCell = newRow.insertCell(6);
            actionCell.innerHTML = `
                <button class="btn-save" style="width: auto; padding: 4px 10px; font-size: 12px;" onclick="saveNewRow(this)">ğŸ’¾ Ø­ÙØ¸</button>
                <button class="btn-cancel" style="margin-inline-start:6px; padding: 4px 10px; font-size: 12px;" onclick="cancelNewRow(this)">âŒ Ø¥Ù„ØºØ§Ø¡</button>
            `;
        };

        // ØªØ¹Ø¯ÙŠÙ„ Ø®Ù„ÙŠØ© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        window.editCell = (cell) => {
            if (cell.querySelector('input') || cell.querySelector('select')) return;
            const text = cell.innerText;
            const colIndex = cell.cellIndex;
            const row = cell.closest('tr');
            // Prevent editing the date for existing (saved) records
            if (colIndex === 1 && row && row.getAttribute('data-key')) {
                return;
            }
            let input;

            // Ø¥Ù†Ø´Ø¡ Ù…Ø¯Ø®Ù„ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙˆØ¯
            if (colIndex === 1) {
                // Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ®
                input = document.createElement('input');
                input.type = 'date';
                input.value = parseAnyToISO(text);
            } else if ([2, 3, 4, 5].includes(colIndex) && options[colIndex]) {
                // Ø£Ø¹Ù…Ø¯Ø© Ø¨Ù‡Ø§ Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø³Ø¯Ù„Ø©
                input = document.createElement('select');
                input.innerHTML = '<option value="">Ø§Ø®ØªØ±...</option>';

                options[colIndex].forEach(opt => {
                    const option = document.createElement('option');
                    if (opt === 'ADD_NEW') {
                        option.value = 'ADD_NEW';
                        option.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯...';
                    } else {
                        option.value = opt;
                        option.textContent = opt;
                        if (opt === text) option.selected = true;
                    }
                    input.appendChild(option);
                });

                // Ù…Ø¹Ø§Ù„Ø¬Ø© ADD_NEW
                if ([4, 5].includes(colIndex)) {
                    input.onchange = () => {
                        if (input.value === 'ADD_NEW') {
                            const promptText = colIndex === 5 ? 'Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:' : 'Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯:';
                            const newVal = prompt(promptText);
                            if (newVal && newVal.trim()) {
                                const trimmed = newVal.trim();
                                if (!options[colIndex].includes(trimmed)) {
                                    options[colIndex].splice(options[colIndex].length - 1, 0, trimmed);
                                    const opt = document.createElement('option');
                                    opt.value = trimmed;
                                    opt.textContent = trimmed;
                                    opt.selected = true;
                                    input.insertBefore(opt, input.lastChild);
                                }
                            } else {
                                input.value = '';
                            }
                        }
                    };
                }
            } else {
                // Ù†Øµ Ø¹Ø§Ø¯ÙŠ
                input = document.createElement('input');
                input.type = 'text';
                input.value = text;
            }

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            if (input.select) input.select();

            const saveEdit = () => {
                if (colIndex === 1) {
                    cell.innerText = formatDateDisplay(input.value);
                } else {
                    cell.innerText = input.value;
                }
                cell.onclick = () => editCell(cell);
                const key = cell.closest('tr').getAttribute('data-key');
                if (key) updateInFirebase(key, cell.closest('tr'));
            };

            input.onblur = saveEdit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') saveEdit();
                if (e.key === 'Escape') {
                    cell.innerText = text;
                    cell.onclick = () => editCell(cell);
                }
            };
        };

        // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ€ key
        window.saveNewRow = (btn) => {
            const row = btn.closest('tr');
            const cells = row.cells;
            const data = {
                mno: cells[0].innerText,
                enter_date: parseAnyToISO(cells[1].innerText),
                keta3: cells[2].innerText,
                handsa: cells[3].innerText,
                nashattype: cells[4].innerText,
                mtype: cells[5].innerText
            };

            if (!data.mno) return Swal.fire("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯", "error");

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ€ key Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ID Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            set(ref(db, `Ayat_Enter/${data.mno}`), data).then(() => {
                Swal.fire("ØªÙ…", "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­", "success");
                row.setAttribute('data-key', data.mno);
                loadAyatEnterData();
            }).catch(err => {
                Swal.fire("Ø®Ø·Ø£", "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: " + err.message, "error");
            });
        };

        // ØªØ­Ø¯ÙŠØ« ÙÙŠ ÙÙŠØ±Ø¨ÙŠØ² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯
        function updateInFirebase(key, row) {
            const cells = row.cells;
            const mno = cells[0].innerText; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙƒÙ€ key
            const data = {
                mno: mno,
                enter_date: parseAnyToISO(cells[1].innerText),
                keta3: cells[2].innerText,
                handsa: cells[3].innerText,
                nashattype: cells[4].innerText,
                mtype: cells[5].innerText
            };
            // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯
            set(ref(db, `Ayat_Enter/${mno}`), data).then(() => {
                row.setAttribute('data-key', mno);
            });
        }

        // Ø­Ø°Ù Ø³Ø¬Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯
        window.deleteRecord = (key) => {
            Swal.fire({
                title: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù"
            }).then((res) => {
                if (res.isConfirmed) {
                    remove(ref(db, `Ayat_Enter/${key}`)).then(() => {
                        Swal.fire("ØªÙ…", "ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
                        loadAyatEnterData();
                    });
                }
            });
        };

        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ…
        window.cancelNewRow = (btn) => {
            const row = btn.closest('tr');
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø·Ø± ØºÙŠØ± Ù…Ø­ÙÙˆØ¸ (Ø¨Ø¯ÙˆÙ† data-key) ÙØ§Ø­Ø°ÙÙ‡ØŒ ÙˆØ¥Ù„Ø§ Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù‚ÙŠÙ…
            if (!row.getAttribute('data-key')) {
                row.remove();
            } else {
                loadAyatEnterData();
            }
        };

        function updatePaginationControls() {
            // enforce a minimum of 5 rows per page
            const effectiveItemsPerPage = Math.max(8, (typeof itemsPerPage === 'number' ? itemsPerPage : 8));
            const totalItems = Array.isArray(filteredData) ? filteredData.length : document.querySelectorAll('#comparisonTableBody tr').length;
            const totalPages = Math.max(1, Math.ceil(totalItems / effectiveItemsPerPage));
            const pageInfo = document.getElementById("pageInfo");
            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("nextBtn");

            if (pageInfo) pageInfo.textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} Ù…Ù† ${totalPages}`;
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        window.nextPage = () => {
            const effectiveItemsPerPage = Math.max(8, (typeof itemsPerPage === 'number' ? itemsPerPage : 8));
            const totalItems = Array.isArray(filteredData) ? filteredData.length : document.querySelectorAll('#comparisonTableBody tr').length;
            const totalPages = Math.max(1, Math.ceil(totalItems / effectiveItemsPerPage));
            if (currentPage < totalPages) {
                currentPage++;
                renderPage();
            }
        };

        window.prevPage = () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        };

        // ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø«
        window.filterTable = (idx) => {
            const rows = document.querySelectorAll('#comparisonTableBody tr');
            const th = document.querySelector('.search-row')?.children[idx];
            if (!th) return;

            // Rebuild filteredData from allData using current search inputs, then render page
            const startVal = document.querySelector('.search-input-date-start')?.value || '';
            const endVal = document.querySelector('.search-input-date-end')?.value || '';
            const startIso = startVal ? parseAnyToISO(startVal) : '';
            const endIso = endVal ? parseAnyToISO(endVal) : '';

            const q0 = document.querySelector('.search-row')?.children[0]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q2 = document.querySelector('.search-row')?.children[2]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q3 = document.querySelector('.search-row')?.children[3]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q4 = document.querySelector('.search-row')?.children[4]?.querySelector('.search-input')?.value.toLowerCase() || '';
            const q5 = document.querySelector('.search-row')?.children[5]?.querySelector('.search-input')?.value.toLowerCase() || '';

            filteredData = allData.filter(item => {
                // date
                const itemIso = parseAnyToISO(item.enter_date || '');
                if (startIso && endIso) {
                    if (!itemIso || itemIso < startIso || itemIso > endIso) return false;
                } else if (startIso) {
                    if (!itemIso || itemIso < startIso) return false;
                } else if (endIso) {
                    if (!itemIso || itemIso > endIso) return false;
                }
                // mno
                if (q0 && !(String(item.mno || '').toLowerCase().includes(q0))) return false;
                if (q2 && !(String(item.keta3 || '').toLowerCase().includes(q2))) return false;
                if (q3 && !(String(item.handsa || '').toLowerCase().includes(q3))) return false;
                if (q4 && !(String(item.nashattype || '').toLowerCase().includes(q4))) return false;
                if (q5 && !(String(item.mtype || '').toLowerCase().includes(q5))) return false;
                return true;
            });

            currentPage = 1;
            renderPage();
        };

        // ØªØµØ¯ÙŠØ± Ø§ÙƒØ³ÙŠÙ„
        window.exportExcel = () => {
            const table = document.getElementById("dataTable");
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª.xlsx");
        };

        window.onload = loadAyatEnterData;
    </script>
</body>

</html>